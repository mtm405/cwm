<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Recovery System Test - Code with Morais</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2.5rem;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .test-section {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .test-card {
            background: #2a2a2a;
            border-radius: 6px;
            padding: 1rem;
            border: 1px solid #333;
        }
        
        .test-card h3 {
            margin-top: 0;
            color: #ffffff;
            font-size: 1.1rem;
        }
        
        .test-card p {
            color: #cccccc;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .btn:hover {
            background: #5a67d8;
        }
        
        .btn-danger {
            background: #e53e3e;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-success {
            background: #38a169;
        }
        
        .btn-success:hover {
            background: #2f855a;
        }
        
        .status-panel {
            background: #2d3748;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .status-panel h3 {
            margin-top: 0;
            color: #667eea;
        }
        
        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem 0;
            border-bottom: 1px solid #4a5568;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-success { color: #68d391; }
        .log-error { color: #fc8181; }
        .log-warning { color: #fbb64f; }
        .log-info { color: #63b3ed; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-card {
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #333;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #cccccc;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Error Recovery System Test Suite</h1>
            <p>Comprehensive testing for robust error handling and recovery</p>
        </div>

        <!-- Test Status Panel -->
        <div class="status-panel">
            <h3>üìä System Status</h3>
            <div id="system-status">
                <div class="log-info">üîÑ Initializing test environment...</div>
            </div>
        </div>

        <!-- Recovery Statistics -->
        <div class="test-section">
            <h2>üìà Recovery Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-errors">0</div>
                    <div class="stat-label">Total Errors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="recovered-errors">0</div>
                    <div class="stat-label">Recovered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="failed-recoveries">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="recovery-rate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>
        </div>

        <!-- Module Error Tests -->
        <div class="test-section">
            <h2>üîß Module Error Recovery Tests</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>ES6 Import Error</h3>
                    <p>Simulate ES6 import statement error in non-module context</p>
                    <button class="btn btn-danger" onclick="testModuleImportError()">Trigger Error</button>
                    <button class="btn" onclick="testModuleRecovery()">Test Recovery</button>
                </div>
                
                <div class="test-card">
                    <h3>Missing Module Dependencies</h3>
                    <p>Test behavior when critical modules fail to load</p>
                    <button class="btn btn-danger" onclick="testMissingModules()">Simulate Missing</button>
                    <button class="btn" onclick="loadCriticalModules()">Load Modules</button>
                </div>
                
                <div class="test-card">
                    <h3>Duplicate Declarations</h3>
                    <p>Test duplicate class declaration prevention</p>
                    <button class="btn" onclick="testDuplicateDeclarations()">Test Duplicates</button>
                    <button class="btn btn-success" onclick="verifyDuplicatePrevention()">Verify Prevention</button>
                </div>
            </div>
        </div>

        <!-- Data Structure Error Tests -->
        <div class="test-section">
            <h2>üìä Data Structure Recovery Tests</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Missing Lesson Data</h3>
                    <p>Test recovery when lesson data is undefined or corrupted</p>
                    <button class="btn btn-danger" onclick="corruptLessonData()">Corrupt Data</button>
                    <button class="btn" onclick="recoverLessonData()">Recover Data</button>
                </div>
                
                <div class="test-card">
                    <h3>Undefined Properties</h3>
                    <p>Test handling of undefined object properties</p>
                    <button class="btn btn-danger" onclick="testUndefinedProperties()">Test Undefined</button>
                    <button class="btn" onclick="normalizeDataStructures()">Normalize</button>
                </div>
                
                <div class="test-card">
                    <h3>Invalid Data Types</h3>
                    <p>Test recovery from invalid data type assignments</p>
                    <button class="btn btn-danger" onclick="testInvalidTypes()">Create Invalid</button>
                    <button class="btn" onclick="validateAndFix()">Validate & Fix</button>
                </div>
            </div>
        </div>

        <!-- Network Error Tests -->
        <div class="test-section">
            <h2>üåê Network Error Recovery Tests</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>API Request Failure</h3>
                    <p>Test recovery from failed API requests</p>
                    <button class="btn btn-danger" onclick="testAPIFailure()">Fail Request</button>
                    <button class="btn" onclick="testRetryLogic()">Test Retry</button>
                </div>
                
                <div class="test-card">
                    <h3>Offline Mode</h3>
                    <p>Test offline mode activation and cached data usage</p>
                    <button class="btn" onclick="simulateOffline()">Go Offline</button>
                    <button class="btn btn-success" onclick="simulateOnline()">Go Online</button>
                </div>
                
                <div class="test-card">
                    <h3>Cache Management</h3>
                    <p>Test data caching and retrieval mechanisms</p>
                    <button class="btn" onclick="testCaching()">Test Cache</button>
                    <button class="btn" onclick="clearCache()">Clear Cache</button>
                </div>
            </div>
        </div>

        <!-- Manual Recovery Controls -->
        <div class="test-section">
            <h2>üîß Manual Recovery Controls</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Full System Recovery</h3>
                    <p>Trigger comprehensive recovery for all error types</p>
                    <button class="btn btn-success" onclick="triggerFullRecovery()">Full Recovery</button>
                    <button class="btn" onclick="resetSystem()">Reset System</button>
                </div>
                
                <div class="test-card">
                    <h3>Health Check</h3>
                    <p>Perform system health check and diagnostics</p>
                    <button class="btn" onclick="performHealthCheck()">Health Check</button>
                    <button class="btn" onclick="showDiagnostics()">Show Diagnostics</button>
                </div>
                
                <div class="test-card">
                    <h3>Recovery History</h3>
                    <p>View error history and recovery attempts</p>
                    <button class="btn" onclick="showErrorHistory()">Show History</button>
                    <button class="btn" onclick="clearErrorHistory()">Clear History</button>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="status-panel">
            <h3>üìã Test Results</h3>
            <div id="test-results">
                <div class="log-info">No tests run yet. Click buttons above to start testing.</div>
            </div>
        </div>
    </div>

    <!-- Load Error Recovery System -->
    <script src="/static/js/utils/errorRecoverySystem.js"></script>
    <script src="/static/js/utils/dataStructureNormalizer.js"></script>

    <script>
        // Test Suite Implementation
        let testResults = [];
        let testCounter = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.appendChild(logEntry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStats() {
            if (window.errorRecovery) {
                const stats = window.errorRecovery.getRecoveryStats();
                document.getElementById('total-errors').textContent = stats.total || 0;
                document.getElementById('recovered-errors').textContent = stats.recovered || 0;
                document.getElementById('failed-recoveries').textContent = (stats.total - stats.recovered) || 0;
                document.getElementById('recovery-rate').textContent = stats.recoveryRate || '0%';
            }
        }

        // Module Error Tests
        function testModuleImportError() {
            log('Testing ES6 import error...', 'warning');
            try {
                eval('import { nonExistentModule } from "./fake-module.js";');
            } catch (error) {
                log(`‚úì ES6 import error triggered: ${error.message}`, 'error');
            }
        }

        function testModuleRecovery() {
            log('Testing module recovery...', 'info');
            if (window.errorRecovery) {
                window.errorRecovery.triggerRecovery('modules').then(() => {
                    log('‚úì Module recovery completed', 'success');
                    updateStats();
                });
            } else {
                log('‚úó Error recovery system not available', 'error');
            }
        }

        function testMissingModules() {
            log('Simulating missing critical modules...', 'warning');
            // Temporarily hide critical modules
            window.EditorService = undefined;
            window.QuizEngine = undefined;
            window.DataStructureNormalizer = undefined;
            log('‚úì Critical modules removed', 'warning');
        }

        function loadCriticalModules() {
            log('Attempting to load critical modules...', 'info');
            if (window.errorRecovery) {
                window.errorRecovery.triggerRecovery('modules').then(() => {
                    log('‚úì Critical modules loaded', 'success');
                    updateStats();
                });
            }
        }

        function testDuplicateDeclarations() {
            log('Testing duplicate class declarations...', 'info');
            try {
                // Try to create duplicate class
                window.TestClass = class TestClass {};
                window.TestClass = class TestClass {}; // This should be prevented
                log('‚úì Duplicate prevention test executed', 'success');
            } catch (error) {
                log(`‚úì Duplicate prevented: ${error.message}`, 'success');
            }
        }

        function verifyDuplicatePrevention() {
            log('Verifying duplicate prevention mechanisms...', 'info');
            const hasDuplicateGuards = document.querySelectorAll('script[data-recovery-loaded]').length > 0;
            if (hasDuplicateGuards) {
                log('‚úì Duplicate prevention guards detected', 'success');
            } else {
                log('‚úó No duplicate prevention guards found', 'warning');
            }
        }

        // Data Structure Error Tests
        function corruptLessonData() {
            log('Corrupting lesson data...', 'warning');
            window.lessonData = null;
            window.lessonProgress = undefined;
            window.quizData = "invalid_data";
            log('‚úì Lesson data corrupted', 'error');
        }

        function recoverLessonData() {
            log('Recovering lesson data...', 'info');
            if (window.errorRecovery) {
                window.errorRecovery.triggerRecovery('data').then(() => {
                    log('‚úì Lesson data recovery completed', 'success');
                    updateStats();
                });
            }
        }

        function testUndefinedProperties() {
            log('Testing undefined property access...', 'warning');
            try {
                const result = window.nonExistentObject.nonExistentProperty.deepProperty;
                log(`Unexpected success: ${result}`, 'warning');
            } catch (error) {
                log(`‚úì Undefined property error: ${error.message}`, 'error');
            }
        }

        function normalizeDataStructures() {
            log('Normalizing data structures...', 'info');
            if (window.DataStructureNormalizer) {
                window.lessonData = window.DataStructureNormalizer.normalizeLessonDataComprehensive(window.lessonData || {});
                log('‚úì Data structures normalized', 'success');
            } else {
                log('‚úó DataStructureNormalizer not available', 'error');
            }
        }

        function testInvalidTypes() {
            log('Testing invalid data types...', 'warning');
            window.lessonData = "this should be an object";
            window.lessonProgress = 12345;
            window.quizData = true;
            log('‚úì Invalid data types assigned', 'error');
        }

        function validateAndFix() {
            log('Validating and fixing data types...', 'info');
            if (window.errorRecovery) {
                window.errorRecovery.triggerRecovery('data').then(() => {
                    log('‚úì Data types validated and fixed', 'success');
                    updateStats();
                });
            }
        }

        // Network Error Tests
        function testAPIFailure() {
            log('Testing API failure...', 'warning');
            fetch('/api/nonexistent-endpoint')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                })
                .catch(error => {
                    log(`‚úì API failure simulated: ${error.message}`, 'error');
                });
        }

        function testRetryLogic() {
            log('Testing retry logic...', 'info');
            if (window.errorRecovery) {
                window.errorRecovery.triggerRecovery('network').then(() => {
                    log('‚úì Network retry logic executed', 'success');
                    updateStats();
                });
            }
        }

        function simulateOffline() {
            log('Simulating offline mode...', 'warning');
            window.dispatchEvent(new Event('offline'));
            log('‚úì Offline mode activated', 'warning');
        }

        function simulateOnline() {
            log('Simulating online mode...', 'success');
            window.dispatchEvent(new Event('online'));
            log('‚úì Online mode restored', 'success');
        }

        function testCaching() {
            log('Testing cache mechanisms...', 'info');
            if (window.errorRecovery) {
                window.errorRecovery.cacheData('test_data', { test: true, timestamp: Date.now() });
                log('‚úì Cache test completed', 'success');
            }
        }

        function clearCache() {
            log('Clearing cache...', 'info');
            localStorage.clear();
            sessionStorage.clear();
            log('‚úì Cache cleared', 'success');
        }

        // Manual Recovery Controls
        function triggerFullRecovery() {
            log('Triggering full system recovery...', 'info');
            if (window.errorRecovery) {
                window.errorRecovery.triggerRecovery('all').then(() => {
                    log('‚úì Full system recovery completed', 'success');
                    updateStats();
                });
            }
        }

        function resetSystem() {
            log('Resetting system...', 'info');
            if (window.errorRecovery) {
                window.errorRecovery.clearErrorHistory();
                log('‚úì System reset completed', 'success');
                updateStats();
            }
        }

        function performHealthCheck() {
            log('Performing health check...', 'info');
            if (window.performHealthCheck) {
                window.performHealthCheck();
                log('‚úì Health check completed', 'success');
            } else {
                log('‚úó Health check function not available', 'error');
            }
        }

        function showDiagnostics() {
            log('Showing system diagnostics...', 'info');
            const diagnostics = {
                errorRecovery: !!window.errorRecovery,
                dataNormalizer: !!window.DataStructureNormalizer,
                lessonData: !!window.lessonData,
                currentUser: !!window.currentUser,
                onlineStatus: navigator.onLine
            };
            
            Object.entries(diagnostics).forEach(([key, value]) => {
                log(`${key}: ${value ? '‚úì' : '‚úó'}`, value ? 'success' : 'error');
            });
        }

        function showErrorHistory() {
            log('Showing error history...', 'info');
            if (window.errorRecovery) {
                const history = window.errorRecovery.getErrorHistory();
                log(`Error history contains ${history.length} entries`, 'info');
                history.slice(-5).forEach((entry, index) => {
                    log(`${index + 1}. ${entry.error.message} (${entry.recovered ? 'recovered' : 'failed'})`, 
                        entry.recovered ? 'success' : 'error');
                });
            }
        }

        function clearErrorHistory() {
            log('Clearing error history...', 'info');
            if (window.errorRecovery) {
                window.errorRecovery.clearErrorHistory();
                log('‚úì Error history cleared', 'success');
                updateStats();
            }
        }

        // Initialize test environment
        document.addEventListener('DOMContentLoaded', function() {
            log('üõ°Ô∏è Error Recovery Test Suite initialized', 'success');
            log('Ready for testing. Click buttons above to run tests.', 'info');
            
            // Update stats every 2 seconds
            setInterval(updateStats, 2000);
            
            // Initial stats update
            setTimeout(updateStats, 1000);
            
            // Check if error recovery system is available
            if (window.errorRecovery) {
                log('‚úì Error Recovery System detected', 'success');
                document.getElementById('system-status').innerHTML = 
                    '<div class="log-success">‚úÖ Error Recovery System is active and ready</div>';
            } else {
                log('‚úó Error Recovery System not detected', 'error');
                document.getElementById('system-status').innerHTML = 
                    '<div class="log-error">‚ùå Error Recovery System not found</div>';
            }
        });
    </script>
</body>
</html>

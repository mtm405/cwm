<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3 Session 2: Quiz System Integration Test</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.39.0/min/vs/loader.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/lesson.css">
    
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .status-info { background-color: #3b82f6; }
        
        .test-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .quiz-integration-demo {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .demo-lesson-container {
            min-height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            background: #f9fafb;
        }
        
        .integration-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn-test {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-test:hover {
            background: #5a67d8;
        }
        
        .btn-test:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .test-result.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .test-result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .test-result.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .quiz-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .stat-card .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        /* Quiz System Styles */
        .quiz-controller {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .quiz-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .quiz-content {
            padding: 20px;
        }
        
        .quiz-navigation {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .quiz-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar {
            width: 200px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s ease;
        }
        
        .question-content {
            margin-bottom: 20px;
        }
        
        .question-title {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .question-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-label:hover {
            background: #f3f4f6;
            border-color: #667eea;
        }
        
        .option-label input[type="radio"] {
            margin: 0;
        }
        
        .quiz-results {
            text-align: center;
            padding: 30px;
        }
        
        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        
        .score-circle.passed {
            background: #10b981;
        }
        
        .score-circle.failed {
            background: #ef4444;
        }
        
        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-item .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .stat-item .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .integration-controls {
                flex-direction: column;
            }
            
            .quiz-navigation {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <!-- Test Header -->
        <div class="test-header">
            <h1><i class="fas fa-brain"></i> Phase 3 Session 2: Quiz System Integration Test</h1>
            <p>Testing the integration of the advanced quiz system with the ES6 lesson architecture</p>
            <div class="mt-3">
                <span class="badge bg-light text-dark">ES6 Modules</span>
                <span class="badge bg-light text-dark">Quiz Engine</span>
                <span class="badge bg-light text-dark">Lesson System</span>
                <span class="badge bg-light text-dark">Firebase Integration</span>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="test-section">
            <h3><i class="fas fa-cog"></i> System Status</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="status-list">
                        <div class="status-item">
                            <span class="status-indicator status-info" id="lesson-system-status"></span>
                            <span>Lesson System</span>
                            <span class="badge bg-secondary ms-2" id="lesson-system-version">Loading...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-indicator status-info" id="quiz-engine-status"></span>
                            <span>Quiz Engine</span>
                            <span class="badge bg-secondary ms-2" id="quiz-engine-version">Loading...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-indicator status-info" id="quiz-controller-status"></span>
                            <span>Quiz Controller</span>
                            <span class="badge bg-secondary ms-2" id="quiz-controller-version">Loading...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-indicator status-info" id="quiz-state-status"></span>
                            <span>Quiz State</span>
                            <span class="badge bg-secondary ms-2" id="quiz-state-version">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="status-list">
                        <div class="status-item">
                            <span class="status-indicator status-info" id="firebase-status"></span>
                            <span>Firebase Integration</span>
                            <span class="badge bg-secondary ms-2" id="firebase-version">Loading...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-indicator status-info" id="lesson-renderer-status"></span>
                            <span>Lesson Renderer</span>
                            <span class="badge bg-secondary ms-2" id="lesson-renderer-version">Loading...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-indicator status-info" id="lesson-interactions-status"></span>
                            <span>Lesson Interactions</span>
                            <span class="badge bg-secondary ms-2" id="lesson-interactions-version">Loading...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-indicator status-info" id="integration-status"></span>
                            <span>Quiz Integration</span>
                            <span class="badge bg-secondary ms-2" id="integration-version">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Integration Controls -->
        <div class="test-section">
            <h3><i class="fas fa-play-circle"></i> Integration Tests</h3>
            <div class="integration-controls">
                <button class="btn-test" id="test-lesson-load">Test Lesson Loading</button>
                <button class="btn-test" id="test-quiz-init">Test Quiz Initialization</button>
                <button class="btn-test" id="test-quiz-render">Test Quiz Rendering</button>
                <button class="btn-test" id="test-quiz-interaction">Test Quiz Interaction</button>
                <button class="btn-test" id="test-quiz-submission">Test Quiz Submission</button>
                <button class="btn-test" id="test-progress-integration">Test Progress Integration</button>
                <button class="btn-test" id="test-firebase-sync">Test Firebase Sync</button>
                <button class="btn-test" id="run-all-tests">Run All Tests</button>
            </div>
            <div id="test-results"></div>
        </div>
        
        <!-- Quiz Integration Demo -->
        <div class="test-section">
            <h3><i class="fas fa-brain"></i> Live Quiz Integration Demo</h3>
            <div class="quiz-integration-demo">
                <div class="demo-controls mb-3">
                    <button class="btn btn-primary" id="load-demo-lesson">Load Demo Lesson</button>
                    <button class="btn btn-secondary" id="reset-demo">Reset Demo</button>
                    <button class="btn btn-info" id="show-quiz-stats">Show Quiz Stats</button>
                </div>
                <div class="demo-lesson-container" id="demo-lesson-container">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-play-circle fa-3x mb-3"></i>
                        <p>Click "Load Demo Lesson" to start the quiz integration demo</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quiz Statistics -->
        <div class="test-section">
            <h3><i class="fas fa-chart-bar"></i> Quiz Statistics</h3>
            <div class="quiz-stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-quizzes">0</div>
                    <div class="stat-label">Total Quizzes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-quizzes">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="average-score">0%</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="quiz-errors">0</div>
                    <div class="stat-label">Errors</div>
                </div>
            </div>
        </div>
        
        <!-- Debug Information -->
        <div class="test-section">
            <h3><i class="fas fa-bug"></i> Debug Information</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>System Log</h5>
                    <div class="test-log" id="system-log"></div>
                </div>
                <div class="col-md-6">
                    <h5>Quiz Debug</h5>
                    <div class="test-log" id="quiz-debug"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- ES6 Module System -->
    <script type="module">
        import { LessonSystem } from '/static/js/lesson/lessonSystem.js';
        
        // Global test state
        window.testState = {
            lessonSystem: null,
            quizEngine: null,
            quizController: null,
            currentQuiz: null,
            testResults: [],
            logs: []
        };
        
        // Test configuration
        const TEST_CONFIG = {
            demoLessonId: 'demo-quiz-integration',
            demoQuizId: 'demo-quiz-001',
            apiEndpoint: '/api',
            debugMode: true
        };
        
        // Demo lesson data with quiz blocks
        const DEMO_LESSON_DATA = {
            id: 'demo-quiz-integration',
            title: 'Quiz Integration Demo',
            description: 'Testing quiz system integration with lesson blocks',
            blocks: [
                {
                    id: 'intro-block',
                    type: 'text',
                    order: 1,
                    title: 'Introduction',
                    content: 'Welcome to the quiz integration demo. This lesson contains quiz blocks that test the integration between the ES6 lesson system and the advanced quiz engine.'
                },
                {
                    id: 'quiz-block-1',
                    type: 'quiz',
                    order: 2,
                    title: 'Basic Python Quiz',
                    description: 'Test your basic Python knowledge',
                    quiz_id: 'basic-python-quiz'
                },
                {
                    id: 'text-block-2',
                    type: 'text',
                    order: 3,
                    title: 'Advanced Concepts',
                    content: 'Now let\'s test some advanced Python concepts with a more challenging quiz.'
                },
                {
                    id: 'quiz-block-2',
                    type: 'quiz',
                    order: 4,
                    title: 'Advanced Python Quiz',
                    description: 'Test your advanced Python knowledge',
                    quiz_id: 'advanced-python-quiz'
                }
            ]
        };
        
        // Demo quiz data
        const DEMO_QUIZ_DATA = {
            'basic-python-quiz': {
                id: 'basic-python-quiz',
                title: 'Basic Python Quiz',
                description: 'Test your basic Python knowledge',
                difficulty: 'beginner',
                time_limit: 300,
                passing_score: 70,
                xp_reward: 50,
                pycoins_reward: 10,
                questions: [
                    {
                        id: 'q1',
                        type: 'multiple_choice',
                        question: 'What is the output of print(2 + 3)?',
                        options: ['4', '5', '6', '23'],
                        correct_answer: 1,
                        points: 1,
                        explanation: 'The + operator adds the numbers 2 and 3, resulting in 5.'
                    },
                    {
                        id: 'q2',
                        type: 'multiple_choice',
                        question: 'Which of these is a valid Python variable name?',
                        options: ['2var', 'var-name', 'var_name', 'var name'],
                        correct_answer: 2,
                        points: 1,
                        explanation: 'Python variable names can contain letters, numbers, and underscores, but cannot start with a number or contain spaces/hyphens.'
                    },
                    {
                        id: 'q3',
                        type: 'multiple_choice',
                        question: 'What data type is the result of 5 / 2 in Python 3?',
                        options: ['int', 'float', 'str', 'bool'],
                        correct_answer: 1,
                        points: 1,
                        explanation: 'In Python 3, the / operator always returns a float, even for whole number divisions.'
                    }
                ]
            },
            'advanced-python-quiz': {
                id: 'advanced-python-quiz',
                title: 'Advanced Python Quiz',
                description: 'Test your advanced Python knowledge',
                difficulty: 'advanced',
                time_limit: 600,
                passing_score: 80,
                xp_reward: 100,
                pycoins_reward: 25,
                questions: [
                    {
                        id: 'q1',
                        type: 'multiple_choice',
                        question: 'What is a closure in Python?',
                        options: [
                            'A function that calls itself',
                            'A function that returns another function',
                            'A nested function that captures variables from its outer scope',
                            'A function that takes no parameters'
                        ],
                        correct_answer: 2,
                        points: 2,
                        explanation: 'A closure is a nested function that has access to variables from its outer (enclosing) scope even after the outer function has returned.'
                    },
                    {
                        id: 'q2',
                        type: 'multiple_choice',
                        question: 'What does the @property decorator do?',
                        options: [
                            'Makes a method static',
                            'Allows a method to be accessed like an attribute',
                            'Makes a method private',
                            'Caches the result of a method'
                        ],
                        correct_answer: 1,
                        points: 2,
                        explanation: 'The @property decorator allows a method to be accessed like an attribute, providing a way to implement getters and setters.'
                    }
                ]
            }
        };
        
        // Logging utility
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            window.testState.logs.push(logEntry);
            
            // Update system log
            const systemLog = document.getElementById('system-log');
            systemLog.textContent += logEntry + '\n';
            systemLog.scrollTop = systemLog.scrollHeight;
            
            console.log(logEntry);
        }
        
        // Test result utility
        function addTestResult(testName, success, message, details = null) {
            const result = {
                testName,
                success,
                message,
                details,
                timestamp: new Date().toISOString()
            };
            
            window.testState.testResults.push(result);
            
            // Update UI
            const testResults = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <strong>${testName}</strong>: ${message}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            testResults.appendChild(resultDiv);
            
            log(`Test ${testName}: ${success ? 'PASSED' : 'FAILED'} - ${message}`, success ? 'success' : 'error');
        }
        
        // Status update utility
        function updateStatus(componentId, status, version = '') {
            const statusElement = document.getElementById(`${componentId}-status`);
            const versionElement = document.getElementById(`${componentId}-version`);
            
            if (statusElement) {
                statusElement.className = `status-indicator status-${status}`;
            }
            
            if (versionElement && version) {
                versionElement.textContent = version;
                versionElement.className = `badge bg-${status === 'success' ? 'success' : status === 'error' ? 'danger' : 'secondary'} ms-2`;
            }
        }
        
        // Initialize test system
        async function initializeTestSystem() {
            log('Initializing test system...');
            
            try {
                // Initialize lesson system
                window.testState.lessonSystem = new LessonSystem();
                await window.testState.lessonSystem.initialize();
                
                updateStatus('lesson-system', 'success', 'ES6 v2.0');
                log('Lesson system initialized successfully');
                
                // Load quiz system components
                await loadQuizSystemComponents();
                
                // Set up event listeners
                setupEventListeners();
                
                updateStatus('integration', 'success', 'Ready');
                log('Test system initialization complete');
                
            } catch (error) {
                log(`Failed to initialize test system: ${error.message}`, 'error');
                updateStatus('integration', 'error', 'Failed');
            }
        }
        
        // Load quiz system components
        async function loadQuizSystemComponents() {
            try {
                // Load QuizEngine
                if (window.QuizEngine) {
                    updateStatus('quiz-engine', 'success', 'Loaded');
                    log('QuizEngine loaded successfully');
                } else {
                    updateStatus('quiz-engine', 'error', 'Missing');
                    log('QuizEngine not found', 'error');
                }
                
                // Load QuizController
                if (window.QuizController) {
                    updateStatus('quiz-controller', 'success', 'Loaded');
                    log('QuizController loaded successfully');
                } else {
                    updateStatus('quiz-controller', 'error', 'Missing');
                    log('QuizController not found', 'error');
                }
                
                // Load QuizState
                if (window.QuizState) {
                    updateStatus('quiz-state', 'success', 'Loaded');
                    log('QuizState loaded successfully');
                } else {
                    updateStatus('quiz-state', 'error', 'Missing');
                    log('QuizState not found', 'error');
                }
                
                // Check Firebase
                if (window.firebase) {
                    updateStatus('firebase', 'success', 'v9.22.0');
                    log('Firebase SDK loaded successfully');
                } else {
                    updateStatus('firebase', 'warning', 'Missing');
                    log('Firebase SDK not found', 'warning');
                }
                
                // Check other components
                updateStatus('lesson-renderer', 'success', 'ES6 v2.0');
                updateStatus('lesson-interactions', 'success', 'ES6 v2.0');
                
            } catch (error) {
                log(`Failed to load quiz system components: ${error.message}`, 'error');
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Test buttons
            document.getElementById('test-lesson-load').addEventListener('click', testLessonLoading);
            document.getElementById('test-quiz-init').addEventListener('click', testQuizInitialization);
            document.getElementById('test-quiz-render').addEventListener('click', testQuizRendering);
            document.getElementById('test-quiz-interaction').addEventListener('click', testQuizInteraction);
            document.getElementById('test-quiz-submission').addEventListener('click', testQuizSubmission);
            document.getElementById('test-progress-integration').addEventListener('click', testProgressIntegration);
            document.getElementById('test-firebase-sync').addEventListener('click', testFirebaseSync);
            document.getElementById('run-all-tests').addEventListener('click', runAllTests);
            
            // Demo buttons
            document.getElementById('load-demo-lesson').addEventListener('click', loadDemoLesson);
            document.getElementById('reset-demo').addEventListener('click', resetDemo);
            document.getElementById('show-quiz-stats').addEventListener('click', showQuizStats);
        }
        
        // Test functions
        async function testLessonLoading() {
            log('Testing lesson loading...');
            
            try {
                if (!window.testState.lessonSystem) {
                    throw new Error('Lesson system not initialized');
                }
                
                // Test lesson data loading
                const lessonData = DEMO_LESSON_DATA;
                
                if (!lessonData.blocks || lessonData.blocks.length === 0) {
                    throw new Error('No lesson blocks found');
                }
                
                // Check quiz blocks
                const quizBlocks = lessonData.blocks.filter(block => block.type === 'quiz');
                if (quizBlocks.length === 0) {
                    throw new Error('No quiz blocks found in lesson');
                }
                
                addTestResult('Lesson Loading', true, `Loaded lesson with ${lessonData.blocks.length} blocks (${quizBlocks.length} quiz blocks)`);
                
            } catch (error) {
                addTestResult('Lesson Loading', false, error.message);
            }
        }
        
        async function testQuizInitialization() {
            log('Testing quiz initialization...');
            
            try {
                if (!window.QuizEngine) {
                    throw new Error('QuizEngine not available');
                }
                
                if (!window.QuizController) {
                    throw new Error('QuizController not available');
                }
                
                // Test quiz engine initialization
                const quizEngine = new window.QuizEngine();
                const quizData = DEMO_QUIZ_DATA['basic-python-quiz'];
                
                await quizEngine.initialize(quizData);
                
                // Test quiz controller initialization
                const testContainer = document.createElement('div');
                testContainer.id = 'test-quiz-container';
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);
                
                const quizController = new window.QuizController('test-quiz-container');
                await quizController.loadQuiz(quizData);
                
                // Clean up
                document.body.removeChild(testContainer);
                
                addTestResult('Quiz Initialization', true, 'Quiz engine and controller initialized successfully');
                
            } catch (error) {
                addTestResult('Quiz Initialization', false, error.message);
            }
        }
        
        async function testQuizRendering() {
            log('Testing quiz rendering...');
            
            try {
                // Test quiz block rendering through lesson system
                const quizData = DEMO_QUIZ_DATA['basic-python-quiz'];
                
                if (!quizData.questions || quizData.questions.length === 0) {
                    throw new Error('No quiz questions found');
                }
                
                // Test question rendering
                const question = quizData.questions[0];
                if (!question.question || !question.options) {
                    throw new Error('Invalid question format');
                }
                
                addTestResult('Quiz Rendering', true, `Quiz rendering validated for ${quizData.questions.length} questions`);
                
            } catch (error) {
                addTestResult('Quiz Rendering', false, error.message);
            }
        }
        
        async function testQuizInteraction() {
            log('Testing quiz interaction...');
            
            try {
                // Test quiz interaction capabilities
                const quizData = DEMO_QUIZ_DATA['basic-python-quiz'];
                
                // Validate question types
                const supportedTypes = ['multiple_choice', 'code_completion', 'true_false'];
                const questionTypes = quizData.questions.map(q => q.type);
                const unsupportedTypes = questionTypes.filter(type => !supportedTypes.includes(type));
                
                if (unsupportedTypes.length > 0) {
                    throw new Error(`Unsupported question types: ${unsupportedTypes.join(', ')}`);
                }
                
                addTestResult('Quiz Interaction', true, 'Quiz interaction capabilities validated');
                
            } catch (error) {
                addTestResult('Quiz Interaction', false, error.message);
            }
        }
        
        async function testQuizSubmission() {
            log('Testing quiz submission...');
            
            try {
                // Test quiz submission logic
                const quizData = DEMO_QUIZ_DATA['basic-python-quiz'];
                const mockAnswers = {
                    'q1': 1,
                    'q2': 2,
                    'q3': 1
                };
                
                // Calculate score
                let correctAnswers = 0;
                quizData.questions.forEach(question => {
                    if (mockAnswers[question.id] === question.correct_answer) {
                        correctAnswers++;
                    }
                });
                
                const score = (correctAnswers / quizData.questions.length) * 100;
                const passed = score >= quizData.passing_score;
                
                addTestResult('Quiz Submission', true, `Quiz submission validated - Score: ${score}% (${passed ? 'Passed' : 'Failed'})`);
                
            } catch (error) {
                addTestResult('Quiz Submission', false, error.message);
            }
        }
        
        async function testProgressIntegration() {
            log('Testing progress integration...');
            
            try {
                if (!window.testState.lessonSystem) {
                    throw new Error('Lesson system not available');
                }
                
                // Test progress tracking
                const testProgress = {
                    lessonId: 'demo-quiz-integration',
                    completedBlocks: ['intro-block'],
                    quizScores: {
                        'basic-python-quiz': 85,
                        'advanced-python-quiz': 90
                    },
                    totalProgress: 50
                };
                
                // Validate progress structure
                if (!testProgress.lessonId || !testProgress.completedBlocks) {
                    throw new Error('Invalid progress structure');
                }
                
                addTestResult('Progress Integration', true, 'Progress integration validated');
                
            } catch (error) {
                addTestResult('Progress Integration', false, error.message);
            }
        }
        
        async function testFirebaseSync() {
            log('Testing Firebase sync...');
            
            try {
                if (!window.firebase) {
                    throw new Error('Firebase not available');
                }
                
                // Test Firebase configuration
                const firebaseConfig = await fetch('/api/firebase-config');
                if (!firebaseConfig.ok) {
                    throw new Error('Failed to fetch Firebase config');
                }
                
                addTestResult('Firebase Sync', true, 'Firebase sync capabilities validated');
                
            } catch (error) {
                addTestResult('Firebase Sync', false, error.message);
            }
        }
        
        async function runAllTests() {
            log('Running all tests...');
            
            // Clear previous results
            document.getElementById('test-results').innerHTML = '';
            window.testState.testResults = [];
            
            // Run all tests
            await testLessonLoading();
            await testQuizInitialization();
            await testQuizRendering();
            await testQuizInteraction();
            await testQuizSubmission();
            await testProgressIntegration();
            await testFirebaseSync();
            
            // Summary
            const totalTests = window.testState.testResults.length;
            const passedTests = window.testState.testResults.filter(r => r.success).length;
            const failedTests = totalTests - passedTests;
            
            log(`Test suite completed: ${passedTests}/${totalTests} tests passed, ${failedTests} failed`);
            
            // Update statistics
            updateStatistics();
        }
        
        // Demo functions
        async function loadDemoLesson() {
            log('Loading demo lesson...');
            
            try {
                if (!window.testState.lessonSystem) {
                    throw new Error('Lesson system not initialized');
                }
                
                const container = document.getElementById('demo-lesson-container');
                container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading lesson...</div>';
                
                // Load lesson data
                const lessonData = DEMO_LESSON_DATA;
                
                // Set up mock API endpoints for demo
                setupMockAPIEndpoints();
                
                // Render lesson
                await window.testState.lessonSystem.loadLesson(lessonData.id, lessonData);
                
                // Update container with lesson content
                container.innerHTML = `
                    <div class="lesson-content">
                        <h4>${lessonData.title}</h4>
                        <p>${lessonData.description}</p>
                        <div id="lesson-content-container"></div>
                    </div>
                `;
                
                // Let lesson system render into the container
                const lessonContentContainer = document.getElementById('lesson-content-container');
                if (window.testState.lessonSystem.renderer) {
                    window.testState.lessonSystem.renderer.container = lessonContentContainer;
                    await window.testState.lessonSystem.renderer.renderLesson(lessonData, {});
                }
                
                log('Demo lesson loaded successfully');
                
            } catch (error) {
                log(`Failed to load demo lesson: ${error.message}`, 'error');
                const container = document.getElementById('demo-lesson-container');
                container.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Failed to load demo lesson: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function setupMockAPIEndpoints() {
            // Mock quiz API endpoints
            const originalFetch = window.fetch;
            
            window.fetch = async function(url, options) {
                if (url.includes('/api/quiz/')) {
                    const quizId = url.split('/api/quiz/')[1].split('/')[0];
                    
                    if (url.includes('/submit')) {
                        // Mock quiz submission
                        const body = JSON.parse(options.body);
                        const quizData = DEMO_QUIZ_DATA[quizId];
                        
                        let correctAnswers = 0;
                        quizData.questions.forEach(question => {
                            if (body.answers[question.id] === question.correct_answer) {
                                correctAnswers++;
                            }
                        });
                        
                        const score = (correctAnswers / quizData.questions.length) * 100;
                        const passed = score >= quizData.passing_score;
                        
                        return new Response(JSON.stringify({
                            success: true,
                            score: score,
                            passed: passed,
                            correct_answers: correctAnswers,
                            total_questions: quizData.questions.length,
                            passing_score: quizData.passing_score,
                            rewards: passed ? {
                                xp: quizData.xp_reward,
                                pycoins: quizData.pycoins_reward
                            } : null,
                            results: quizData.questions.map(question => ({
                                correct: body.answers[question.id] === question.correct_answer,
                                explanation: question.explanation
                            }))
                        }), {
                            status: 200,
                            headers: { 'Content-Type': 'application/json' }
                        });
                    } else {
                        // Mock quiz data fetch
                        const quizData = DEMO_QUIZ_DATA[quizId];
                        if (quizData) {
                            return new Response(JSON.stringify(quizData), {
                                status: 200,
                                headers: { 'Content-Type': 'application/json' }
                            });
                        } else {
                            return new Response(JSON.stringify({
                                error: 'Quiz not found'
                            }), {
                                status: 404,
                                headers: { 'Content-Type': 'application/json' }
                            });
                        }
                    }
                }
                
                // Use original fetch for other requests
                return originalFetch.call(this, url, options);
            };
        }
        
        function resetDemo() {
            log('Resetting demo...');
            
            const container = document.getElementById('demo-lesson-container');
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-play-circle fa-3x mb-3"></i>
                    <p>Click "Load Demo Lesson" to start the quiz integration demo</p>
                </div>
            `;
            
            // Reset test state
            window.testState.currentQuiz = null;
            
            log('Demo reset complete');
        }
        
        function showQuizStats() {
            log('Showing quiz statistics...');
            
            const stats = {
                totalQuizzes: Object.keys(DEMO_QUIZ_DATA).length,
                completedQuizzes: window.testState.testResults.filter(r => r.testName.includes('Quiz')).length,
                averageScore: 85, // Mock data
                quizErrors: window.testState.testResults.filter(r => !r.success && r.testName.includes('Quiz')).length
            };
            
            updateStatistics(stats);
            log('Quiz statistics updated');
        }
        
        function updateStatistics(stats = null) {
            if (!stats) {
                stats = {
                    totalQuizzes: Object.keys(DEMO_QUIZ_DATA).length,
                    completedQuizzes: window.testState.testResults.filter(r => r.success).length,
                    averageScore: window.testState.testResults.length > 0 ? 
                        Math.round((window.testState.testResults.filter(r => r.success).length / window.testState.testResults.length) * 100) : 0,
                    quizErrors: window.testState.testResults.filter(r => !r.success).length
                };
            }
            
            document.getElementById('total-quizzes').textContent = stats.totalQuizzes;
            document.getElementById('completed-quizzes').textContent = stats.completedQuizzes;
            document.getElementById('average-score').textContent = stats.averageScore + '%';
            document.getElementById('quiz-errors').textContent = stats.quizErrors;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            log('Page loaded, initializing test system...');
            
            // Add loading scripts dynamically
            const scripts = [
                '/static/js/quiz/QuizState.js',
                '/static/js/quiz/QuizEngine.js',
                '/static/js/quiz/QuizController.js'
            ];
            
            for (const script of scripts) {
                try {
                    const scriptElement = document.createElement('script');
                    scriptElement.src = script;
                    document.head.appendChild(scriptElement);
                    
                    await new Promise((resolve, reject) => {
                        scriptElement.onload = resolve;
                        scriptElement.onerror = reject;
                    });
                    
                    log(`Loaded script: ${script}`);
                } catch (error) {
                    log(`Failed to load script ${script}: ${error.message}`, 'error');
                }
            }
            
            // Initialize test system
            await initializeTestSystem();
        });
        
        // Export for debugging
        window.testSystem = {
            log,
            addTestResult,
            updateStatus,
            loadDemoLesson,
            resetDemo,
            showQuizStats,
            runAllTests
        };
    </script>
</body>
</html>

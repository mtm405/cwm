<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson System Real Data Test</title>
    <link rel="stylesheet" href="static/css/components/lesson-blocks-enhanced.css">
    <link rel="stylesheet" href="static/css/components/lesson-block-types.css">
    <link rel="stylesheet" href="static/css/components/lesson-progress-enhanced.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-left: 10px;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        
        .lesson-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
        }
        
        .lesson-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        
        .lesson-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .info-card h4 {
            margin: 0 0 10px 0;
            color: #555;
            font-size: 1em;
        }
        
        .lesson-content {
            margin-top: 20px;
        }
        
        .block-list {
            margin-top: 15px;
        }
        
        .block-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .block-type {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        .progress-section {
            margin-top: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
        }
        
        .test-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .error-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.error {
            color: #dc3545;
        }
        
        .log-entry.success {
            color: #28a745;
        }
        
        .log-entry.warning {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß™ Lesson System Real Data Test</h1>
            <p>Testing the lesson system with actual lesson data from Firebase</p>
        </div>
        
        <div class="test-section">
            <h3>üìã Test Status</h3>
            <div id="test-status">
                <span>Loading...</span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìö Lesson Selection</h3>
            <div class="lesson-selector">
                <label for="lesson-select">Select a lesson to test:</label>
                <select id="lesson-select">
                    <option value="">Loading lessons...</option>
                </select>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìä Lesson Information</h3>
            <div id="lesson-info" class="lesson-info">
                <div class="info-card">
                    <h4>Title</h4>
                    <div id="lesson-title">Not loaded</div>
                </div>
                <div class="info-card">
                    <h4>Difficulty</h4>
                    <div id="lesson-difficulty">Not loaded</div>
                </div>
                <div class="info-card">
                    <h4>Estimated Time</h4>
                    <div id="lesson-time">Not loaded</div>
                </div>
                <div class="info-card">
                    <h4>Blocks Count</h4>
                    <div id="lesson-blocks-count">Not loaded</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üß© Lesson Blocks</h3>
            <div id="lesson-blocks" class="block-list">
                <p>Select a lesson to view its blocks...</p>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìà Progress Testing</h3>
            <div class="progress-section">
                <div class="progress-bar">
                    <div id="test-progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progress-text">0% Complete (0 of 0 blocks)</div>
            </div>
            <div class="test-actions">
                <button id="test-complete-block" class="btn btn-primary">Mark Next Block Complete</button>
                <button id="test-reset-progress" class="btn btn-secondary">Reset Progress</button>
                <button id="test-save-progress" class="btn btn-success">Save Progress</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîç Test Log</h3>
            <div id="test-log" class="error-log">
                <div class="log-entry">Starting test system...</div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import our lesson system
        import { LessonSystem } from '/static/js/lesson/lessonSystem.js';
        import { LessonProgress } from '/static/js/lesson/services/LessonProgress.js';
        import { AssessmentBasedProgressTracker } from '/static/js/lesson/services/AssessmentBasedProgressTracker.js';
        
        class RealDataLessonTester {
            constructor() {
                this.lessonSystem = new LessonSystem();
                this.progressTracker = new LessonProgress();
                this.assessmentTracker = new AssessmentBasedProgressTracker();
                this.currentLessonId = null;
                this.currentLessonData = null;
                this.testProgress = {
                    completedBlocks: [],
                    totalBlocks: 0,
                    currentBlockIndex: 0
                };
                
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // Lesson selection
                document.getElementById('lesson-select').addEventListener('change', (e) => {
                    if (e.target.value) {
                        this.loadLesson(e.target.value);
                    }
                });
                
                // Test actions
                document.getElementById('test-complete-block').addEventListener('click', () => {
                    this.completeNextBlock();
                });
                
                document.getElementById('test-reset-progress').addEventListener('click', () => {
                    this.resetProgress();
                });
                
                document.getElementById('test-save-progress').addEventListener('click', () => {
                    this.saveProgress();
                });
            }
            
            async initialize() {
                this.log('üöÄ Initializing real data lesson tester...', 'success');
                
                try {
                    // Load available lessons
                    await this.loadLessonList();
                    
                    // Initialize lesson system
                    await this.lessonSystem.initialize();
                    
                    this.log('‚úÖ Test system initialized successfully', 'success');
                    this.updateTestStatus('‚úÖ Ready', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Initialization failed: ${error.message}`, 'error');
                    this.updateTestStatus('‚ùå Failed to initialize', 'error');
                }
            }
            
            async loadLessonList() {
                try {
                    const response = await fetch('/api/lessons');
                    const data = await response.json();
                    
                    if (data.lessons && data.lessons.length > 0) {
                        const select = document.getElementById('lesson-select');
                        select.innerHTML = '<option value="">Select a lesson...</option>';
                        
                        data.lessons.forEach(lesson => {
                            const option = document.createElement('option');
                            option.value = lesson.id;
                            option.textContent = `${lesson.title} (${lesson.difficulty || 'beginner'})`;
                            select.appendChild(option);
                        });
                        
                        this.log(`üìö Loaded ${data.lessons.length} lessons`, 'success');
                    } else {
                        throw new Error('No lessons found');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to load lessons: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            async loadLesson(lessonId) {
                try {
                    this.log(`üìñ Loading lesson: ${lessonId}`, 'success');
                    
                    const response = await fetch(`/api/lessons/${lessonId}`);
                    const data = await response.json();
                    
                    if (data.lesson) {
                        this.currentLessonId = lessonId;
                        this.currentLessonData = data.lesson;
                        
                        this.updateLessonInfo(data.lesson);
                        this.updateBlocksList(data.lesson);
                        this.resetTestProgress();
                        
                        this.log(`‚úÖ Lesson loaded: ${data.lesson.title}`, 'success');
                    } else {
                        throw new Error('Lesson data not found');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to load lesson: ${error.message}`, 'error');
                }
            }
            
            updateLessonInfo(lesson) {
                document.getElementById('lesson-title').textContent = lesson.title || 'Unknown';
                document.getElementById('lesson-difficulty').textContent = lesson.difficulty || 'beginner';
                document.getElementById('lesson-time').textContent = lesson.estimated_time ? `${lesson.estimated_time} min` : 'Not specified';
                
                const blocksCount = lesson.blocks ? lesson.blocks.length : 0;
                document.getElementById('lesson-blocks-count').textContent = blocksCount;
                
                this.testProgress.totalBlocks = blocksCount;
            }
            
            updateBlocksList(lesson) {
                const container = document.getElementById('lesson-blocks');
                
                if (!lesson.blocks || lesson.blocks.length === 0) {
                    container.innerHTML = '<p>No blocks found in this lesson</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                lesson.blocks.forEach((block, index) => {
                    const blockElement = document.createElement('div');
                    blockElement.className = 'block-item';
                    blockElement.innerHTML = `
                        <div>
                            <strong>${block.title || `Block ${index + 1}`}</strong>
                            <span class="block-type">${block.type}</span>
                        </div>
                        <div id="block-status-${index}" class="status">Not started</div>
                    `;
                    container.appendChild(blockElement);
                });
            }
            
            completeNextBlock() {
                if (!this.currentLessonData || !this.currentLessonData.blocks) {
                    this.log('‚ùå No lesson loaded', 'error');
                    return;
                }
                
                const { currentBlockIndex, completedBlocks, totalBlocks } = this.testProgress;
                
                if (currentBlockIndex >= totalBlocks) {
                    this.log('‚úÖ All blocks already completed', 'warning');
                    return;
                }
                
                const blockId = this.currentLessonData.blocks[currentBlockIndex].id || `block-${currentBlockIndex}`;
                
                // Mark block as completed
                completedBlocks.push(blockId);
                this.testProgress.currentBlockIndex++;
                
                // Update UI
                this.updateBlockStatus(currentBlockIndex, 'completed');
                this.updateProgressDisplay();
                
                this.log(`‚úÖ Block ${currentBlockIndex + 1} marked as complete`, 'success');
                
                // Test assessment-based completion
                this.testAssessmentCompletion(blockId, currentBlockIndex);
            }
            
            testAssessmentCompletion(blockId, blockIndex) {
                try {
                    const block = this.currentLessonData.blocks[blockIndex];
                    
                    // Create mock assessment data based on block type
                    let assessmentData = {};
                    
                    switch (block.type) {
                        case 'quiz':
                            assessmentData = {
                                score: 85,
                                totalQuestions: 5,
                                correctAnswers: 4,
                                attempts: 1
                            };
                            break;
                        case 'interactive':
                        case 'code':
                            assessmentData = {
                                codeExecuted: true,
                                testsPassed: 3,
                                totalTests: 3,
                                attempts: 2
                            };
                            break;
                        case 'text':
                            assessmentData = {
                                timeSpent: 45,
                                keyPointsReviewed: true,
                                readingCompleted: true
                            };
                            break;
                    }
                    
                    // Test assessment validation
                    const isValid = this.assessmentTracker.validateAssessment(block.type, assessmentData);
                    
                    if (isValid) {
                        this.log(`‚úÖ Assessment validation passed for ${block.type} block`, 'success');
                    } else {
                        this.log(`‚ùå Assessment validation failed for ${block.type} block`, 'error');
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Assessment test failed: ${error.message}`, 'error');
                }
            }
            
            updateBlockStatus(index, status) {
                const statusElement = document.getElementById(`block-status-${index}`);
                if (statusElement) {
                    statusElement.textContent = status;
                    statusElement.className = `status ${status === 'completed' ? 'success' : 'warning'}`;
                }
            }
            
            updateProgressDisplay() {
                const { completedBlocks, totalBlocks } = this.testProgress;
                const percentage = totalBlocks > 0 ? Math.round((completedBlocks.length / totalBlocks) * 100) : 0;
                
                document.getElementById('test-progress-fill').style.width = `${percentage}%`;
                document.getElementById('progress-text').textContent = 
                    `${percentage}% Complete (${completedBlocks.length} of ${totalBlocks} blocks)`;
            }
            
            resetProgress() {
                this.testProgress = {
                    completedBlocks: [],
                    totalBlocks: this.testProgress.totalBlocks,
                    currentBlockIndex: 0
                };
                
                this.resetTestProgress();
                this.log('üîÑ Progress reset', 'warning');
            }
            
            resetTestProgress() {
                // Reset all block statuses
                if (this.currentLessonData && this.currentLessonData.blocks) {
                    this.currentLessonData.blocks.forEach((_, index) => {
                        this.updateBlockStatus(index, 'Not started');
                    });
                }
                
                this.updateProgressDisplay();
            }
            
            async saveProgress() {
                if (!this.currentLessonId) {
                    this.log('‚ùå No lesson loaded to save progress', 'error');
                    return;
                }
                
                try {
                    const progressData = {
                        lessonId: this.currentLessonId,
                        completedBlocks: this.testProgress.completedBlocks,
                        progress: this.testProgress.completedBlocks.length / this.testProgress.totalBlocks,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    const response = await fetch(`/api/lessons/${this.currentLessonId}/progress`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(progressData)
                    });
                    
                    if (response.ok) {
                        this.log('‚úÖ Progress saved successfully', 'success');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to save progress: ${error.message}`, 'error');
                }
            }
            
            updateTestStatus(message, type) {
                const statusElement = document.getElementById('test-status');
                statusElement.innerHTML = `<span class="status ${type}">${message}</span>`;
            }
            
            log(message, type = 'info') {
                const logContainer = document.getElementById('test-log');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                console.log(message);
            }
        }
        
        // Initialize the tester
        const tester = new RealDataLessonTester();
        tester.initialize();
        
        // Make available globally for debugging
        window.lessonTester = tester;
    </script>
</body>
</html>

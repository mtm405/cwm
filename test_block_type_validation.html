<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Type Validation Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-left: 10px;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        
        .block-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .block-type-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .block-type-card h4 {
            margin: 0 0 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            background: #007bff;
            color: white;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            background: #0056b3;
        }
        
        .test-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .test-results {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }
        
        .error-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.error { color: #dc3545; }
        .log-entry.success { color: #28a745; }
        .log-entry.warning { color: #ffc107; }
        
        .api-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .api-test-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .api-test-card h5 {
            margin: 0 0 10px 0;
            font-size: 1em;
        }
        
        .api-response {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.8em;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß™ Block Type Validation Test</h1>
            <p>Testing all lesson block types and their functionality</p>
        </div>
        
        <div class="test-section">
            <h3>üìã Test Status</h3>
            <div id="overall-status">
                <span>Initializing...</span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîå API Endpoints Test</h3>
            <div class="api-test-grid">
                <div class="api-test-card">
                    <h5>Lessons List</h5>
                    <button class="test-btn" id="test-lessons-api">Test /api/lessons</button>
                    <div id="lessons-api-response" class="api-response" style="display: none;"></div>
                </div>
                <div class="api-test-card">
                    <h5>Single Lesson</h5>
                    <button class="test-btn" id="test-lesson-api">Test /api/lessons/python-basics-01</button>
                    <div id="lesson-api-response" class="api-response" style="display: none;"></div>
                </div>
                <div class="api-test-card">
                    <h5>Progress API</h5>
                    <button class="test-btn" id="test-progress-api">Test Progress API</button>
                    <div id="progress-api-response" class="api-response" style="display: none;"></div>
                </div>
                <div class="api-test-card">
                    <h5>Quiz Data</h5>
                    <button class="test-btn" id="test-quiz-api">Test Quiz API</button>
                    <div id="quiz-api-response" class="api-response" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üß© Block Type Rendering Test</h3>
            <div class="block-types-grid">
                <div class="block-type-card">
                    <h4>Text Block <span class="status" id="text-block-status">Not tested</span></h4>
                    <p>Tests reading comprehension blocks with markdown content</p>
                    <button class="test-btn" id="test-text-block">Test Text Block</button>
                    <div id="text-block-results" class="test-results" style="display: none;"></div>
                </div>
                
                <div class="block-type-card">
                    <h4>Code Block <span class="status" id="code-block-status">Not tested</span></h4>
                    <p>Tests code example blocks with syntax highlighting</p>
                    <button class="test-btn" id="test-code-block">Test Code Block</button>
                    <div id="code-block-results" class="test-results" style="display: none;"></div>
                </div>
                
                <div class="block-type-card">
                    <h4>Interactive Block <span class="status" id="interactive-block-status">Not tested</span></h4>
                    <p>Tests interactive coding challenges with execution</p>
                    <button class="test-btn" id="test-interactive-block">Test Interactive Block</button>
                    <div id="interactive-block-results" class="test-results" style="display: none;"></div>
                </div>
                
                <div class="block-type-card">
                    <h4>Quiz Block <span class="status" id="quiz-block-status">Not tested</span></h4>
                    <p>Tests quiz integration with question rendering</p>
                    <button class="test-btn" id="test-quiz-block">Test Quiz Block</button>
                    <div id="quiz-block-results" class="test-results" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìä Progress Tracking Test</h3>
            <div class="block-types-grid">
                <div class="block-type-card">
                    <h4>Assessment Validation <span class="status" id="assessment-status">Not tested</span></h4>
                    <p>Tests assessment-based completion validation</p>
                    <button class="test-btn" id="test-assessment">Test Assessment</button>
                    <div id="assessment-results" class="test-results" style="display: none;"></div>
                </div>
                
                <div class="block-type-card">
                    <h4>Progress Persistence <span class="status" id="persistence-status">Not tested</span></h4>
                    <p>Tests progress saving and loading across sessions</p>
                    <button class="test-btn" id="test-persistence">Test Persistence</button>
                    <div id="persistence-results" class="test-results" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîç Test Log</h3>
            <div id="test-log" class="error-log">
                <div class="log-entry">Starting block type validation tests...</div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import lesson system components
        import { LessonRenderer } from '/static/js/lesson/components/LessonRenderer.js';
        import { LessonProgress } from '/static/js/lesson/services/LessonProgress.js';
        import { AssessmentBasedProgressTracker } from '/static/js/lesson/services/AssessmentBasedProgressTracker.js';
        
        class BlockTypeValidator {
            constructor() {
                this.renderer = new LessonRenderer();
                this.progressTracker = new LessonProgress();
                this.assessmentTracker = new AssessmentBasedProgressTracker();
                this.testResults = {};
                
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // API Tests
                document.getElementById('test-lessons-api').addEventListener('click', () => this.testLessonsAPI());
                document.getElementById('test-lesson-api').addEventListener('click', () => this.testLessonAPI());
                document.getElementById('test-progress-api').addEventListener('click', () => this.testProgressAPI());
                document.getElementById('test-quiz-api').addEventListener('click', () => this.testQuizAPI());
                
                // Block Type Tests
                document.getElementById('test-text-block').addEventListener('click', () => this.testTextBlock());
                document.getElementById('test-code-block').addEventListener('click', () => this.testCodeBlock());
                document.getElementById('test-interactive-block').addEventListener('click', () => this.testInteractiveBlock());
                document.getElementById('test-quiz-block').addEventListener('click', () => this.testQuizBlock());
                
                // Progress Tests
                document.getElementById('test-assessment').addEventListener('click', () => this.testAssessment());
                document.getElementById('test-persistence').addEventListener('click', () => this.testPersistence());
            }
            
            async initialize() {
                this.log('üöÄ Initializing block type validator...', 'success');
                
                try {
                    // Initialize components
                    await this.progressTracker.initialize();
                    
                    this.log('‚úÖ Block type validator initialized successfully', 'success');
                    this.updateOverallStatus('‚úÖ Ready for testing', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Initialization failed: ${error.message}`, 'error');
                    this.updateOverallStatus('‚ùå Initialization failed', 'error');
                }
            }
            
            async testLessonsAPI() {
                this.log('üìö Testing lessons API...', 'success');
                
                try {
                    const response = await fetch('/api/lessons');
                    const data = await response.json();
                    
                    if (response.ok && data.lessons && data.lessons.length > 0) {
                        this.showApiResponse('lessons-api-response', {
                            status: 'success',
                            count: data.lessons.length,
                            sample: data.lessons[0]
                        });
                        this.log(`‚úÖ Lessons API: ${data.lessons.length} lessons found`, 'success');
                    } else {
                        throw new Error('No lessons found');
                    }
                } catch (error) {
                    this.showApiResponse('lessons-api-response', {
                        status: 'error',
                        error: error.message
                    });
                    this.log(`‚ùå Lessons API failed: ${error.message}`, 'error');
                }
            }
            
            async testLessonAPI() {
                this.log('üìñ Testing single lesson API...', 'success');
                
                try {
                    const response = await fetch('/api/lessons/python-basics-01');
                    const data = await response.json();
                    
                    if (response.ok && data.blocks && data.blocks.length > 0) {
                        this.showApiResponse('lesson-api-response', {
                            status: 'success',
                            title: data.title,
                            blocks: data.blocks.length,
                            types: [...new Set(data.blocks.map(b => b.type))]
                        });
                        this.log(`‚úÖ Lesson API: ${data.blocks.length} blocks found`, 'success');
                    } else {
                        throw new Error('No blocks found in lesson');
                    }
                } catch (error) {
                    this.showApiResponse('lesson-api-response', {
                        status: 'error',
                        error: error.message
                    });
                    this.log(`‚ùå Lesson API failed: ${error.message}`, 'error');
                }
            }
            
            async testProgressAPI() {
                this.log('üìä Testing progress API...', 'success');
                
                try {
                    const testData = {
                        lessonId: 'python-basics-01',
                        completedBlocks: ['test-block-1'],
                        progress: 0.5,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    const response = await fetch('/api/lessons/python-basics-01/progress', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(testData)
                    });
                    
                    if (response.ok) {
                        this.showApiResponse('progress-api-response', {
                            status: 'success',
                            message: 'Progress saved successfully'
                        });
                        this.log('‚úÖ Progress API: Save successful', 'success');
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    this.showApiResponse('progress-api-response', {
                        status: 'error',
                        error: error.message
                    });
                    this.log(`‚ùå Progress API failed: ${error.message}`, 'error');
                }
            }
            
            async testQuizAPI() {
                this.log('üß† Testing quiz API...', 'success');
                
                try {
                    const response = await fetch('/api/quiz/python-basics-quiz');
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.showApiResponse('quiz-api-response', {
                            status: 'success',
                            questions: data.questions ? data.questions.length : 0,
                            title: data.title || 'Unknown'
                        });
                        this.log('‚úÖ Quiz API: Quiz data loaded', 'success');
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    this.showApiResponse('quiz-api-response', {
                        status: 'error',
                        error: error.message
                    });
                    this.log(`‚ùå Quiz API failed: ${error.message}`, 'error');
                }
            }
            
            async testTextBlock() {
                this.log('üìù Testing text block rendering...', 'success');
                
                try {
                    const testBlock = {
                        id: 'test-text-block',
                        type: 'text',
                        content: '# Test Text Block\\n\\nThis is a test text block with **markdown** formatting.',
                        key_points: ['Test point 1', 'Test point 2']
                    };
                    
                    const html = this.renderer.renderTextBlock(testBlock);
                    const hasContent = html.includes('Test Text Block');
                    const hasMarkdown = html.includes('<strong>markdown</strong>');
                    const hasButton = html.includes('Mark as Read');
                    
                    const result = {
                        rendered: !!html,
                        hasContent: hasContent,
                        hasMarkdown: hasMarkdown,
                        hasButton: hasButton,
                        success: hasContent && hasButton
                    };
                    
                    this.showTestResults('text-block-results', result);
                    this.updateStatus('text-block-status', result.success ? 'success' : 'error');
                    this.log(`${result.success ? '‚úÖ' : '‚ùå'} Text block test: ${result.success ? 'passed' : 'failed'}`, result.success ? 'success' : 'error');
                    
                } catch (error) {
                    this.showTestResults('text-block-results', { error: error.message });
                    this.updateStatus('text-block-status', 'error');
                    this.log(`‚ùå Text block test failed: ${error.message}`, 'error');
                }
            }
            
            async testCodeBlock() {
                this.log('üíª Testing code block rendering...', 'success');
                
                try {
                    const testBlock = {
                        id: 'test-code-block',
                        type: 'code_example',
                        code: 'print("Hello, World!")',
                        language: 'python',
                        explanation: 'This is a test code block.'
                    };
                    
                    const html = this.renderer.renderCodeBlock(testBlock);
                    const hasCode = html.includes('print("Hello, World!")');
                    const hasLanguage = html.includes('PYTHON');
                    const hasExplanation = html.includes('This is a test code block');
                    const hasButton = html.includes('Mark as Understood');
                    
                    const result = {
                        rendered: !!html,
                        hasCode: hasCode,
                        hasLanguage: hasLanguage,
                        hasExplanation: hasExplanation,
                        hasButton: hasButton,
                        success: hasCode && hasButton
                    };
                    
                    this.showTestResults('code-block-results', result);
                    this.updateStatus('code-block-status', result.success ? 'success' : 'error');
                    this.log(`${result.success ? '‚úÖ' : '‚ùå'} Code block test: ${result.success ? 'passed' : 'failed'}`, result.success ? 'success' : 'error');
                    
                } catch (error) {
                    this.showTestResults('code-block-results', { error: error.message });
                    this.updateStatus('code-block-status', 'error');
                    this.log(`‚ùå Code block test failed: ${error.message}`, 'error');
                }
            }
            
            async testInteractiveBlock() {
                this.log('üîß Testing interactive block rendering...', 'success');
                
                try {
                    const testBlock = {
                        id: 'test-interactive-block',
                        type: 'interactive',
                        title: 'Test Challenge',
                        instructions: 'Write a Python function',
                        starter_code: 'def hello():\\n    pass',
                        solution: 'def hello():\\n    return "Hello"'
                    };
                    
                    const html = this.renderer.renderInteractiveBlock(testBlock);
                    const hasInstructions = html.includes('Write a Python function');
                    const hasCode = html.includes('def hello():');
                    const hasRunButton = html.includes('Run Code') || html.includes('Submit');
                    
                    const result = {
                        rendered: !!html,
                        hasInstructions: hasInstructions,
                        hasCode: hasCode,
                        hasRunButton: hasRunButton,
                        success: hasInstructions && hasCode
                    };
                    
                    this.showTestResults('interactive-block-results', result);
                    this.updateStatus('interactive-block-status', result.success ? 'success' : 'error');
                    this.log(`${result.success ? '‚úÖ' : '‚ùå'} Interactive block test: ${result.success ? 'passed' : 'failed'}`, result.success ? 'success' : 'error');
                    
                } catch (error) {
                    this.showTestResults('interactive-block-results', { error: error.message });
                    this.updateStatus('interactive-block-status', 'error');
                    this.log(`‚ùå Interactive block test failed: ${error.message}`, 'error');
                }
            }
            
            async testQuizBlock() {
                this.log('üß† Testing quiz block rendering...', 'success');
                
                try {
                    const testBlock = {
                        id: 'test-quiz-block',
                        type: 'quiz',
                        quiz_id: 'python-basics-quiz',
                        description: 'Test your Python knowledge'
                    };
                    
                    const html = this.renderer.renderQuizBlock(testBlock);
                    const hasQuizContainer = html.includes('quiz-container');
                    const hasQuizId = html.includes('python-basics-quiz');
                    const hasDescription = html.includes('Test your Python knowledge');
                    
                    const result = {
                        rendered: !!html,
                        hasQuizContainer: hasQuizContainer,
                        hasQuizId: hasQuizId,
                        hasDescription: hasDescription,
                        success: hasQuizContainer && hasQuizId
                    };
                    
                    this.showTestResults('quiz-block-results', result);
                    this.updateStatus('quiz-block-status', result.success ? 'success' : 'error');
                    this.log(`${result.success ? '‚úÖ' : '‚ùå'} Quiz block test: ${result.success ? 'passed' : 'failed'}`, result.success ? 'success' : 'error');
                    
                } catch (error) {
                    this.showTestResults('quiz-block-results', { error: error.message });
                    this.updateStatus('quiz-block-status', 'error');
                    this.log(`‚ùå Quiz block test failed: ${error.message}`, 'error');
                }
            }
            
            async testAssessment() {
                this.log('üìä Testing assessment validation...', 'success');
                
                try {
                    const testCases = [
                        { type: 'text', data: { timeSpent: 60, readingCompleted: true }, expected: true },
                        { type: 'quiz', data: { score: 85, totalQuestions: 5 }, expected: true },
                        { type: 'quiz', data: { score: 50, totalQuestions: 5 }, expected: false },
                        { type: 'interactive', data: { codeExecuted: true, testsPassed: 3 }, expected: true }
                    ];
                    
                    const results = testCases.map(testCase => {
                        const result = this.assessmentTracker.validateAssessment(testCase.type, testCase.data);
                        return {
                            type: testCase.type,
                            expected: testCase.expected,
                            actual: result,
                            passed: result === testCase.expected
                        };
                    });
                    
                    const allPassed = results.every(r => r.passed);
                    
                    this.showTestResults('assessment-results', {
                        testCases: results,
                        allPassed: allPassed,
                        passedCount: results.filter(r => r.passed).length,
                        totalCount: results.length
                    });
                    
                    this.updateStatus('assessment-status', allPassed ? 'success' : 'error');
                    this.log(`${allPassed ? '‚úÖ' : '‚ùå'} Assessment test: ${results.filter(r => r.passed).length}/${results.length} passed`, allPassed ? 'success' : 'error');
                    
                } catch (error) {
                    this.showTestResults('assessment-results', { error: error.message });
                    this.updateStatus('assessment-status', 'error');
                    this.log(`‚ùå Assessment test failed: ${error.message}`, 'error');
                }
            }
            
            async testPersistence() {
                this.log('üíæ Testing progress persistence...', 'success');
                
                try {
                    const testLessonId = 'test-lesson-persistence';
                    const testProgress = {
                        completedBlocks: ['block-1', 'block-2'],
                        progress: 0.5,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // Save progress
                    await this.progressTracker.saveProgress(testLessonId, testProgress);
                    
                    // Load progress
                    const loadedProgress = await this.progressTracker.loadProgress(testLessonId);
                    
                    const result = {
                        saved: true,
                        loaded: !!loadedProgress,
                        completedBlocksMatch: JSON.stringify(loadedProgress?.completedBlocks) === JSON.stringify(testProgress.completedBlocks),
                        progressMatch: loadedProgress?.progress === testProgress.progress,
                        success: !!loadedProgress
                    };
                    
                    this.showTestResults('persistence-results', result);
                    this.updateStatus('persistence-status', result.success ? 'success' : 'error');
                    this.log(`${result.success ? '‚úÖ' : '‚ùå'} Persistence test: ${result.success ? 'passed' : 'failed'}`, result.success ? 'success' : 'error');
                    
                } catch (error) {
                    this.showTestResults('persistence-results', { error: error.message });
                    this.updateStatus('persistence-status', 'error');
                    this.log(`‚ùå Persistence test failed: ${error.message}`, 'error');
                }
            }
            
            showApiResponse(elementId, data) {
                const element = document.getElementById(elementId);
                element.style.display = 'block';
                element.textContent = JSON.stringify(data, null, 2);
            }
            
            showTestResults(elementId, data) {
                const element = document.getElementById(elementId);
                element.style.display = 'block';
                element.textContent = JSON.stringify(data, null, 2);
            }
            
            updateStatus(elementId, status) {
                const element = document.getElementById(elementId);
                element.className = `status ${status}`;
                element.textContent = status === 'success' ? 'Passed' : status === 'error' ? 'Failed' : 'Warning';
            }
            
            updateOverallStatus(message, type) {
                const statusElement = document.getElementById('overall-status');
                statusElement.innerHTML = `<span class="status ${type}">${message}</span>`;
            }
            
            log(message, type = 'info') {
                const logContainer = document.getElementById('test-log');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                console.log(message);
            }
        }
        
        // Initialize the validator
        const validator = new BlockTypeValidator();
        validator.initialize();
        
        // Make available globally for debugging
        window.blockTypeValidator = validator;
    </script>
</body>
</html>

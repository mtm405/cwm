{% extends "base/layout.html" %}
{% from "macros/lesson.html" import tab_button, code_block, back_link, progress_bar %}

{% block title %}{{ lesson.title if lesson else "Lesson" }} - Code with Morais{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/lesson-content-blocks.css') }}">
<style>
/* Additional inline styles for lesson page specific adjustments */
.lesson-container {
    line-height: 1.8;
}

/* Error state styling */
.error-container {
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 2.5rem;
    text-align: center;
    margin: 2rem auto;
    max-width: 800px;
}

.error-icon {
    font-size: 3.5rem;
    color: var(--error-color);
    margin-bottom: 1.5rem;
}

.error-title {
    color: var(--error-color);
    margin-bottom: 1rem;
}

.error-content {
    text-align: left;
    margin: 2rem 0;
}

.error-container .btn {
    margin-top: 1.5rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
}

.text-block h1, .text-block h2, .text-block h3 {
    color: var(--primary-color);
    margin: 1rem 0;
}

.code-example {
    background-color: var(--bg-secondary);
}

.code-header {
    background-color: var(--bg-primary);
    margin: -2rem -2rem 1rem -2rem;
    padding: 1rem 2rem;
    border-radius: 12px 12px 0 0;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-copy {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    transition: color 0.3s ease;
}

.btn-copy:hover {
    color: var(--primary-color);
}

.code-example pre {
    background-color: transparent;
    margin: 0;
    padding: 0;
    overflow-x: auto;
}

.code-example code {
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 14px;
    line-height: 1.5;
}

.interactive-challenge h3 {
    color: var(--secondary-color);
    margin-bottom: 1rem;
}

.code-output {
    margin-top: 1rem;
    padding: 1rem;
    background-color: var(--bg-secondary);
    border-radius: 8px;
    min-height: 50px;
    font-family: monospace;
}

.output-success {
    color: var(--success-color);
}

.output-success .rewards {
    background-color: var(--success-color);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    margin: 0.5rem 0;
    font-weight: bold;
}

.output-error {
    color: var(--error-color);
}

.quiz-container {
    margin: 2rem 0;
    padding: 2rem;
    background-color: var(--bg-secondary);
    border-radius: 12px;
    border: 2px solid var(--primary-color);
}

.quiz-question {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.quiz-options {
    list-style: none;
    padding: 0;
}

.quiz-option {
    margin: 0.5rem 0;
    padding: 1rem;
    background-color: var(--bg-primary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.quiz-option:hover {
    background-color: var(--bg-hover);
    border-color: var(--primary-color);
}

.quiz-option.selected {
    background-color: var(--primary-color);
    color: white;
}

.quiz-option.correct {
    background-color: var(--success-color);
    color: white;
}

.quiz-option.incorrect {
    background-color: var(--error-color);
    color: white;
}

.lesson-progress-bar {
    width: 100%;
    height: 8px;
    background-color: var(--bg-secondary);
    border-radius: 4px;
    margin: 1rem 0;
    overflow: hidden;
}

.lesson-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    border-radius: 4px;
    transition: width 0.5s ease;
}

.block-completed {
    opacity: 0.7;
    transform: scale(0.98);
    transition: all 0.3s ease;
}

.next-lesson-card {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
    margin: 2rem 0;
}

.next-lesson-card h3 {
    margin: 0 0 1rem 0;
    color: white;
}

.btn-next-lesson {
    background-color: white;
    color: var(--primary-color);
    border: none;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-next-lesson:hover {
    background-color: var(--bg-secondary);
    transform: translateY(-2px);
}

/* Loading states */
.content-loading {
    text-align: center;
    padding: 3rem;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--bg-secondary);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive design */
@media (max-width: 768px) {
    .lesson-header {
        padding: 1rem;
    }
    
    .content-block {
        margin: 1rem 0;
        padding: 1rem;
    }
    
    .code-editor {
        height: 200px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="lesson-container">
    {% if lesson.error %}
    <!-- Error State -->
    <div class="error-container">
        <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <h1 class="error-title">{{ lesson.title }}</h1>
        <p>{{ lesson.description }}</p>
        <div class="error-content">
            {% for content_block in lesson.content %}
                {% if content_block.type == 'text' %}
                    <div class="text-block">
                        {{ content_block.content|markdown }}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <a href="/lessons" class="btn btn-primary"><i class="fas fa-arrow-left"></i> Back to Lessons</a>
    </div>
    {% else %}
    <!-- üéØ LESSON HEADER SECTION -->
    <header class="lesson-header">
        {% include 'components/lesson/back-link.html' %}
        
        <div class="lesson-header-content">
            <div class="lesson-meta">
                <h1 class="lesson-title">
                    <i class="fas fa-{{ lesson.icon or 'code' }}"></i>
                    {{ lesson.title }}
                </h1>
                <div class="lesson-badges">
                    <span class="difficulty-badge {{ lesson.difficulty or 'beginner' }}">
                        {{ (lesson.difficulty or 'beginner')|title }}
                    </span>
                    <span class="time-badge">
                        <i class="fas fa-clock"></i> {{ lesson.estimated_time or 30 }}min
                    </span>
                    <span class="xp-badge">
                        <i class="fas fa-star"></i> {{ lesson.xp_reward or 100 }} XP
                    </span>
                    {% if lesson.coin_reward %}
                    <span class="coin-badge">
                        <i class="fas fa-coins"></i> {{ lesson.coin_reward }} ü™ô
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- üìä PROGRESS BAR SECTION -->
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-text">Progress</span>
                    <span class="progress-percentage" id="progress-percentage">{{ lesson_progress.progress or 0 }}%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="lesson-progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: {{ lesson_progress.progress or 0 }}%"></div>
                    </div>
                </div>
                <div class="progress-stats">
                    <span class="completed-blocks" id="completed-blocks-text">
                        {{ lesson_progress.completed_blocks|length or 0 }} of {{ lesson.blocks|length or 0 }} blocks completed
                    </span>
                    <span class="earned-rewards" id="earned-rewards">
                        {% if lesson_progress.xp_earned %}+{{ lesson_progress.xp_earned }} XP{% endif %}
                        {% if lesson_progress.coins_earned %}+{{ lesson_progress.coins_earned }} ü™ô{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- üóÇÔ∏è SUBTOPIC NAVIGATION (conditional) -->
    {% if lesson.subtopics %}
    <nav class="subtopic-navigation" role="tablist">
        <div class="subtopic-tabs">
            {% for subtopic in lesson.subtopics %}
            <button class="subtopic-tab {{ 'active' if loop.first else '' }}" 
                    data-subtopic="{{ subtopic.id }}"
                    role="tab"
                    aria-selected="{{ 'true' if loop.first else 'false' }}"
                    tabindex="{{ '0' if loop.first else '-1' }}"
                    onclick="switchSubtopic({{ loop.index0 }})">
                <i class="fas fa-{{ subtopic.icon or 'book' }}"></i>
                <span class="tab-title">{{ subtopic.title|string }}</span>
                <i class="fas fa-check-circle tab-check {{ 'completed' if subtopic.id in lesson_progress.completed_subtopics else '' }}"></i>
            </button>
            {% endfor %}
        </div>
    </nav>
    {% endif %}

    <!-- üìö MAIN CONTENT AREA -->
    <main class="lesson-content-wrapper">
        
        <!-- Loading Skeleton -->
        <div id="content-loading" class="content-loading">
            {% set component_type = 'lesson-content' %}
            {% include 'components/common/skeleton-loader.html' %}
        </div>
        
        <!-- Dynamic Content Container -->
        <div id="lesson-content" class="lesson-content" style="display: none;">
            <!-- Content blocks will be dynamically rendered here by JavaScript -->
            <div id="lesson-content-container" class="content-blocks-container">
                <!-- Placeholder for dynamic content blocks -->
            </div>
        </div>
        
        <!-- Modern Fallback Content (used by ES6 modules) -->
        <div id="lesson-fallback" class="fallback-content" style="display: none;">
            <div class="alert alert-warning">
                <h4>üì∂ Connection Issue</h4>
                <p>Having trouble loading the lesson? We've saved your progress locally.</p>
                <button id="retry-btn" class="btn btn-primary">
                    <i class="fas fa-refresh"></i> Try Again
                </button>
            </div>
        </div>
        
    </main>

    <!-- üéØ LESSON NAVIGATION FOOTER -->
    <footer class="lesson-navigation">
        <div class="nav-buttons">
            {% if lesson.subtopics %}
            <!-- Previous Subtopic Button -->
            <button id="prev-btn" class="nav-btn prev-btn" 
                    onclick="previousSubtopic()" 
                    style="display: flex;">
                <i class="fas fa-arrow-left"></i>
                <span class="nav-text">Previous</span>
            </button>
            {% elif prev_lesson %}
            <a href="{{ url_for('lesson.lesson', lesson_id=prev_lesson.id) }}" 
               class="nav-btn prev-btn">
                <i class="fas fa-arrow-left"></i>
                <span class="nav-text">
                    <small>Previous</small>
                    <strong>{{ prev_lesson.title|truncate(30) }}</strong>
                </span>
            </a>
            {% endif %}
            
            <div class="nav-center">
                <button id="lesson-menu-btn" class="lesson-menu-btn" onclick="toggleLessonMenu()">
                    <i class="fas fa-list"></i>
                    <span>Lesson Menu</span>
                </button>
            </div>
            
            {% if lesson.subtopics %}
            <!-- Next Subtopic Button -->
            <button id="next-btn" class="nav-btn next-btn" 
                    onclick="nextSubtopic()"
                    style="display: flex;">
                <span class="nav-text">Next</span>
                <i class="fas fa-arrow-right"></i>
            </button>
            {% elif next_lesson %}
            <a href="{{ url_for('lesson.lesson', lesson_id=next_lesson.id) }}" 
               class="nav-btn next-btn" 
               id="next-lesson-btn">
                <span class="nav-text">
                    <small>Next</small>
                    <strong>{{ next_lesson.title|truncate(30) }}</strong>
                </span>
                <i class="fas fa-arrow-right"></i>
            </a>
            {% endif %}
        </div>
    </footer>

</div>

<!-- üéâ CELEBRATION MODALS -->
<div id="celebration-container"></div>

<!-- üí° HELP MODAL -->
<div id="help-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí° Need Help?</h3>
            <button class="modal-close" onclick="closeHelpModal()">&times;</button>
        </div>
        <div class="modal-body" id="help-content">
            <!-- Dynamic help content -->
        </div>
    </div>
</div>

<!-- üìã LESSON MENU SIDEBAR -->
<div id="lesson-menu-sidebar" class="lesson-menu-sidebar">
    <div class="sidebar-header">
        <h3>üìö Lesson Progress</h3>
        <button onclick="toggleLessonMenu()" class="sidebar-close">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="sidebar-content">
        <!-- Dynamic lesson menu content -->
    </div>
</div>
<!-- JavaScript for Dynamic Content Rendering -->

<script type="module" src="/static/js/lesson/lessonMain.js"></script>

// Legacy function - now delegated to enhanced system
function initializeLesson() {
    console.log('üöÄ Initializing enhanced lesson system...');
    
    // The enhanced system will handle all initialization
    // Check if enhanced system is available
    if (window.EnhancedLessonTemplate) {
        console.log('‚úÖ Enhanced lesson system detected, delegating initialization...');
        return; // Enhanced system will handle initialization
    }
    
    // Fallback to legacy initialization if enhanced system isn't available
    console.warn('‚ö†Ô∏è Enhanced system not available, using legacy initialization...');
    initializeLegacyLesson();
}

// Legacy initialization function (kept for fallback)
function initializeLegacyLesson() {
    console.log('üìÑ Running legacy lesson initialization...');
    
    try {
        // Validate required elements
        const requiredElements = ['lesson-content-container'];
        const missingElements = requiredElements.filter(id => !document.getElementById(id));
        
        if (missingElements.length > 0) {
            throw new Error(`Required elements not found: ${missingElements.join(', ')}`);
        }
        
        // Safely hide loading and show content
        const loadingElement = document.getElementById('content-loading');
        const contentElement = document.getElementById('lesson-content');
        
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
        if (contentElement) {
            contentElement.style.display = 'block';
        }
        
        // Ensure lesson data is properly structured
        if (!globalThis.lessonData) {
            throw new Error('No lesson data available');
        }
        
        // Initialize progress if not exists
        if (!globalThis.lessonProgress) {
            globalThis.lessonProgress = {
                completed_blocks: [],
                progress: 0,
                current_block: 0
            };
        }
        if (!globalThis.lessonProgress.completed_blocks) {
            globalThis.lessonProgress.completed_blocks = [];
        }
        
        // Test Firebase data structure and integration
        testFirebaseIntegration();
        
        // Render content based on structure
        if (globalThis.lessonData.subtopics && globalThis.lessonData.subtopics.length > 0) {
            console.log('üìë Rendering subtopic-based lesson...');
            globalThis.currentSubtopic = 0;
            renderSubtopic(0);
        } else if (globalThis.lessonData.blocks && globalThis.lessonData.blocks.length > 0) {
            console.log('üìÑ Rendering single-page lesson...');
            renderLessonContent(globalThis.lessonData.blocks);
        } else {
            console.warn('‚ö†Ô∏è No structured content found, attempting legacy render...');
            renderLegacyContent(globalThis.lessonData.content || 'No content available');
        }
        
        // Update progress display
        updateProgressDisplay();
        
        console.log('‚úÖ Legacy lesson initialization complete');
        
    } catch (error) {
        console.error('‚ùå Failed to initialize legacy lesson:', error);
        showFallbackContent();
    }
}

// This function is replaced by the comprehensive renderSubtopic below

function renderLessonBlocks(blocks) {
    const container = document.getElementById('lesson-content-container');
    container.innerHTML = '';
    
    blocks.forEach((block, index) => {
        const blockElement = createBlockElement(block, index);
        container.appendChild(blockElement);
    });
    
    // Initialize any interactive elements
    initializeInteractiveElements();
}

function createBlockElement(block, index) {
    // Phase 3 Fix: Enhanced data validation for block creation
    if (!block) {
        console.warn('‚ö†Ô∏è Null block at index:', index);
        return null;
    }
    
    const article = document.createElement('article');
    article.className = `content-block ${block.type || 'unknown'}-block`;
    article.id = `block-${block.id || index}`;
    article.dataset.blockId = block.id || index;
    article.dataset.blockType = block.type || 'text';
    
    // Add completion status with safe access
    const isCompleted = globalThis.lessonProgress?.completed_blocks && 
                       Array.isArray(globalThis.lessonProgress.completed_blocks) &&
                       globalThis.lessonProgress.completed_blocks.includes(block.id);
    if (isCompleted) {
        article.classList.add('completed');
    }
    
    // Render based on block type with fallback
    try {
        switch(block.type) {
            case 'text':
                article.innerHTML = createTextBlockHTML(block);
                break;
            case 'code_example':
                article.innerHTML = createCodeExampleHTML(block);
                break;
            case 'interactive':
                article.innerHTML = createInteractiveBlockHTML(block);
                break;
            case 'quiz':
                article.innerHTML = createQuizBlockHTML(block);
                break;
            default:
                console.warn('‚ö†Ô∏è Unknown block type:', block.type);
                article.innerHTML = createDefaultBlockHTML(block);
        }
    } catch (error) {
        console.error('‚ùå Error creating block element:', error);
        article.innerHTML = `<div class="error-block">Error rendering block: ${error.message}</div>`;
    }
    
    return article;
}

function createTextBlockHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-book-open"></i>
            </div>
            <div class="block-meta">
                <span class="block-type">Reading</span>
                <span class="block-progress-indicator" id="progress-${block.id}">
                    <i class="fas fa-circle"></i>
                </span>
            </div>
        </div>
        
        <div class="block-content">
            <div class="text-content">
                ${block.content || ''}
            </div>
            
            ${block.key_points ? `
            <div class="key-points">
                <h4>üîë Key Points:</h4>
                <ul>
                    ${block.key_points.map(point => `<li>${point}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
        </div>
        
        <div class="block-actions">
            <button onclick="markBlockComplete('${block.id}')" 
                    class="btn btn-success complete-btn">
                <i class="fas fa-check"></i> Mark as Read
            </button>
        </div>
    `;
}

function createCodeExampleHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-code"></i>
            </div>
            <div class="code-meta">
                <span class="language-badge">${(block.language || 'python').toUpperCase()}</span>
                <button class="btn-copy" onclick="copyCodeBlock('${block.id}')">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
        </div>
        
        <div class="code-container">
            <div class="code-header">
                <span class="code-title">${block.title || 'Example Code'}</span>
            </div>
            
            <pre class="code-content" id="code-${block.id}"><code class="language-${block.language || 'python'}">${block.code || ''}</code></pre>
            
            ${block.explanation ? `
            <div class="code-explanation">
                <h5>üí° Explanation:</h5>
                <p>${block.explanation}</p>
            </div>
            ` : ''}
        </div>
    `;
}

function createInteractiveBlockHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-laptop-code"></i>
            </div>
            <div class="challenge-meta">
                <span class="challenge-type">${block.challenge_type || 'Code Challenge'}</span>
                <span class="difficulty">${block.difficulty || 'Beginner'}</span>
            </div>
        </div>
        
        <div class="challenge-content">
            <div class="challenge-instructions">
                <h4>üéØ Your Challenge:</h4>
                <p>${block.instructions || ''}</p>
                
                ${block.requirements ? `
                <div class="requirements">
                    <h5>üìã Requirements:</h5>
                    <ul>
                        ${block.requirements.map(req => `<li>${req}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            </div>
            
            <div class="code-editor-wrapper">
                <div class="editor-toolbar">
                    <span class="editor-label">${block.language || 'Python'} Editor</span>
                    <div class="editor-actions">
                        <button onclick="getHint('${block.id}')" class="btn btn-sm btn-hint">
                            <i class="fas fa-lightbulb"></i> Hint (5 ü™ô)
                        </button>
                        <button onclick="resetCode('${block.id}')" class="btn btn-sm btn-reset">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div id="editor-${block.id}" class="code-editor">${block.starter_code || ''}</div>
                
                <div class="editor-footer">
                    <button onclick="runInteractiveCode('${block.id}')" 
                            class="btn btn-primary run-btn">
                        <i class="fas fa-play"></i> Run Code
                    </button>
                    <button onclick="showSolution('${block.id}')" 
                            class="btn btn-outline solution-btn">
                        <i class="fas fa-eye"></i> Show Solution
                    </button>
                </div>
            </div>
            
            <div class="output-section">
                <div class="output-header">
                    <i class="fas fa-terminal"></i> Output & Results
                </div>
                <div id="output-${block.id}" class="ide-output"></div>
                
                ${block.tests ? `
                <div class="test-results" id="tests-${block.id}">
                    <h5>üß™ Test Results:</h5>
                    <div class="test-list">
                        <!-- Test results will be populated here -->
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

function createQuizBlockHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-brain"></i>
            </div>
            <div class="quiz-meta">
                <span class="quiz-type">Knowledge Check</span>
            </div>
        </div>
        
        <div class="quiz-content">
            <div class="quiz-intro">
                <h4>üß† Test Your Understanding</h4>
                <p>${block.description || 'Complete this quiz to test your knowledge.'}</p>
            </div>
            
            <div id="quiz-${block.quiz_id || block.id}" data-quiz-id="${block.quiz_id || block.id}">
                <div class="spinner">Loading quiz...</div>
            </div>
        </div>
    `;
}

function createDefaultBlockHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-question"></i>
            </div>
            <div class="block-meta">
                <span class="block-type">Unknown Block Type: ${block.type}</span>
            </div>
        </div>
        
        <div class="block-content">
            <p>This block type (${block.type}) is not yet supported.</p>
            <pre>${JSON.stringify(block, null, 2)}</pre>
        </div>
    `;
}

// Utility functions
function showNotification(message, type = 'info') {
    console.log(`${type.toUpperCase()}: ${message}`);
    
    // Create simple notification if no notification system exists
    if (typeof showToast === 'function') {
        showToast(message, type);
    } else {
        // Fallback notification
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 1rem;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => notification.style.opacity = '1', 100);
        
        // Auto remove
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
}

function showFallbackContent() {
    const fallbackElement = document.getElementById('fallback-content');
    const contentElement = document.getElementById('lesson-content');
    
    if (fallbackElement) {
        fallbackElement.style.display = 'block';
    }
    if (contentElement) {
        contentElement.style.display = 'none';
    }
    
    console.warn('‚ö†Ô∏è Showing fallback content due to initialization failure');
}

function retryLoadContent() {
    const fallbackElement = document.getElementById('fallback-content');
    const loadingElement = document.getElementById('content-loading');
    
    if (fallbackElement) {
        fallbackElement.style.display = 'none';
    }
    if (loadingElement) {
        loadingElement.style.display = 'block';
    }
    
    setTimeout(() => {
        initializeLesson();
    }, 1000);
}

function renderLegacyContent(content) {
    const container = document.getElementById('lesson-content-container');
    if (!container) return;
    
    container.innerHTML = `
        <div class="content-block text-block">
            <div class="block-header">
                <div class="block-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="block-meta">
                    <span class="block-type">Lesson Content</span>
                </div>
            </div>
            <div class="block-content">
                <div class="text-content">
                    ${typeof content === 'string' ? content.replace(/\n/g, '<br>') : 'No content available'}
                </div>
            </div>
        </div>
    `;
}

function updateProgressDisplay() {
    const totalBlocks = globalThis.lessonData.blocks ? globalThis.lessonData.blocks.length : 0;
    const completedBlocks = globalThis.lessonProgress.completed_blocks ? 
        globalThis.lessonProgress.completed_blocks.length : 0;
    const progress = totalBlocks > 0 ? Math.round((completedBlocks / totalBlocks) * 100) : 0;
    
    // Update progress bar if it exists
    const progressBar = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-percentage');
    const completedText = document.getElementById('completed-blocks-text');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    if (progressText) {
        progressText.textContent = progress + '%';
    }
    if (completedText) {
        completedText.textContent = `${completedBlocks} of ${totalBlocks} blocks completed`;
    }
    
    // Update lesson progress
    globalThis.lessonProgress.progress = progress;
}

function initializeInteractiveElements() {
    // Initialize ACE editors for interactive blocks
    document.querySelectorAll('.code-editor').forEach(editor => {
        if (editor.id && typeof ace !== 'undefined') {
            try {
                const aceEditor = ace.edit(editor.id);
                aceEditor.setTheme('ace/theme/monokai');
                aceEditor.session.setMode('ace/mode/python');
                aceEditor.setOptions({
                    showPrintMargin: false,
                    fontSize: 14
                });
                globalThis.editors[editor.id] = aceEditor;
            } catch (error) {
                console.warn('Failed to initialize ACE editor for', editor.id, error);
            }
        }
    });
    
    // Initialize quiz systems
    document.querySelectorAll('[data-quiz-id]').forEach(quizElement => {
        // Quiz initialization would go here
        console.log('Quiz element found:', quizElement.dataset.quizId);
    });
}

// Global function to toggle lesson menu
function toggleLessonMenu() {
    const sidebar = document.getElementById('lesson-menu-sidebar');
    if (sidebar) {
        sidebar.classList.toggle('active');
    } else {
        console.warn('‚ö†Ô∏è Lesson menu sidebar not found');
    }
}
</script>

{% endif %}
{% endblock %}

<!-- üöÄ Enhanced Firebase Lesson System - ES6 Modules -->
{% block extra_js %}
<!-- ÔøΩ Modern Lesson System: Modular JS Loading -->
<script src="{{ url_for('static', filename='js/core/app.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/editor/editorService.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/quiz/QuizEngine.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/utils/dataStructureNormalizer.js') }}" type="module"></script>
<!-- Remove legacy and error recovery scripts, use only if fallback needed -->
<script>
class LessonBootstrap {
    async init() {
        try {
            await this.loadEssentials();
            await this.initializeSystem();
        } catch (error) {
            this.renderFallback();
        }
    }
    async loadEssentials() {
        // Load scripts in order, handle failures
        const scripts = [
            '/static/js/lesson/enhancedFirebaseLessonService.js',
            '/static/js/lesson/enhancedLessonBlockRenderer.js',
            '/static/js/lesson/enhancedLessonIntegrationManager.js'
        ];
        for (const script of scripts) {
            try {
                await this.loadScript(script);
            } catch (error) {
                console.warn(`Failed to load ${script}, continuing...`);
            }
        }
    }
    loadScript(src) {
        return new Promise((resolve, reject) => {
            // Prevent duplicate loading
            if (document.querySelector(`script[src="${src}"]`)) {
                resolve();
                return;
            }
            const script = document.createElement('script');
            script.src = src;
            script.async = false;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }
    async initializeSystem() {
        // Try to initialize enhanced system if available
        if (window.EnhancedLessonIntegrationManager) {
            try {
                const lessonId = window.lessonData?.id || window.location.pathname.split('/').pop();
                window.currentLessonManager = new window.EnhancedLessonIntegrationManager(
                    lessonId,
                    window.lessonData || null
                );
                await window.currentLessonManager.initialize();
                return;
            } catch (error) {
                console.error('‚ùå Enhanced initialization error:', error);
            }
        }
        // Fallback to legacy
        if (typeof window.initializeLesson === 'function') {
            window.initializeLesson();
        } else {
            this.renderFallback();
        }
    }
    renderFallback() {
        // Always show SOMETHING to the user
        const container = document.getElementById('lesson-content-container');
        if (container) {
            container.innerHTML = `
                <div class="lesson-fallback">
                    <h1>${window.lessonData?.title || 'Lesson'}</h1>
                    <p>Loading lesson content...</p>
                    <button onclick="window.location.reload()">Retry</button>
                </div>
            `;
        }
    }
}
document.addEventListener('DOMContentLoaded', () => {
    new LessonBootstrap().init();
});
</script>
{% endblock %}

<script>
// Current subtopic tracking
let currentSubtopicIndex = 0;
// Use safe default values if template variables aren't available at runtime
let subtopics = window.lessonData && window.lessonData.subtopics ? window.lessonData.subtopics : [];
let completedSubtopics = window.lessonProgress && window.lessonProgress.completed_subtopics ? window.lessonProgress.completed_subtopics : [];

// Initialize ACE Editor - handled by InitializationQueue
// Editor initialization will be handled by the main initialization queue

function switchLessonTab(subtopicId) {
    // Update active tab
    document.querySelectorAll('.lesson-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-subtopic-id') === subtopicId) {
            tab.classList.add('active');
            currentSubtopicIndex = subtopics.findIndex(s => s.id === subtopicId);
        }
    });
    
    // Update content (in a real app, this would load subtopic-specific content)
    updateCompleteButton();
}

function updateCompleteButton() {
    const currentSubtopic = subtopics[currentSubtopicIndex];
    const btn = document.getElementById('complete-subtopic-btn');
    
    if (!btn) return; // Guard clause to prevent null reference error
    
    if (completedSubtopics.includes(currentSubtopic.id)) {
        btn.textContent = 'Œì¬£√¥ Completed';
        btn.disabled = true;
    } else {
        btn.textContent = 'Mark as Complete';
        btn.disabled = false;
    }
}

async function completeCurrentSubtopic() {
    const currentSubtopic = subtopics[currentSubtopicIndex];
    
    try {
        const response = await fetch('/api/lesson/complete-subtopic', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lesson_id: '{{ lesson.id }}',
                subtopic_id: currentSubtopic.id
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update UI
            completedSubtopics.push(currentSubtopic.id);
            
            // Update progress bar
            document.getElementById('progress-percentage').textContent = result.new_progress + '%';
            document.getElementById('lesson-progress-fill').style.width = result.new_progress + '%';
            
            // Update tab check mark
            const tab = document.querySelector(`[data-subtopic-id="${currentSubtopic.id}"]`);
            const checkIcon = tab.querySelector('.tab-check');
            checkIcon.classList.add('completed');
            
            // Update button
            updateCompleteButton();
            
            // Show reward notification
            showNotification(`Subtopic completed! +${result.xp_earned} XP earned! ‚â°∆í√Ñ√´`);
            
            if (result.lesson_completed) {
                setTimeout(() => {
                    showNotification('Lesson completed! Great job! ‚â°∆í√Ö√•');
                }, 1000);
            }
        }
    } catch (error) {
        console.error('Error completing subtopic:', error);
        showNotification('Error saving progress. Please try again.', 'error');
    }
}

function previousSubtopic() {
    if (currentSubtopicIndex > 0) {
        const prevSubtopic = subtopics[currentSubtopicIndex - 1];
        switchLessonTab(prevSubtopic.id);
    }
}

function nextSubtopic() {
    if (currentSubtopicIndex < subtopics.length - 1) {
        const nextSubtopic = subtopics[currentSubtopicIndex + 1];
        switchLessonTab(nextSubtopic.id);
    }
}

function copyCode(button) {
    const codeBlock = button.closest('.code-example').querySelector('code');
    const text = codeBlock.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 2000);
    });
}

/**
 * Debug function to check authentication state
 * Add this to your console to check auth state
 */
window.debugAuth = function() {
    console.log('=== Auth Debug Info ===');
    console.log('Token in localStorage:', localStorage.getItem('auth_token'));
    
    // Check if authService exists and get its properties
    if (window.authService) {
        console.log('AuthService available:', !!window.authService);
        console.log('Token in authService:', window.authService.token);
        console.log('Current User:', window.authService.currentUser);
        console.log('Is Authenticated:', window.authService.isAuthenticated());
        console.log('Is Initialized:', window.authService.initialized);
    } else {
        console.log('AuthService not available');
    }
    
    // Check global user objects
    console.log('globalThis.currentUser:', globalThis.currentUser);
    console.log('window.currentUser:', window.currentUser);
    
    // Check other auth managers
    if (window.authManager) {
        console.log('AuthManager available:', !!window.authManager);
        console.log('AuthManager user:', window.authManager.getCurrentUser());
        console.log('AuthManager authenticated:', window.authManager.isUserAuthenticated());
    }
    
    // Check session storage
    console.log('SessionStorage auth_token:', sessionStorage.getItem('auth_token'));
    console.log('LocalStorage user data:', localStorage.getItem('user_data'));
    
    return {
        authService: window.authService,
        authManager: window.authManager,
        currentUser: globalThis.currentUser || window.currentUser,
        localStorage: {
            auth_token: localStorage.getItem('auth_token'),
            user_data: localStorage.getItem('user_data')
        },
        sessionStorage: {
            auth_token: sessionStorage.getItem('auth_token')
        }
    };
};

// Make it available globally for easy access
globalThis.debugAuth = window.debugAuth;

// Auto-run once for immediate debugging (can be commented out in production)
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.includes('dev')) {
    console.log('üîß Running auth debug in development mode...');
    setTimeout(() => {
        try {
            debugAuth();
        } catch (error) {
            console.error('Error running debug auth:', error);
        }
    }, 1000);
}

// Enhanced lesson initialization - handled by enhanced system
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM loaded, initializing enhanced lesson system...');
    
    // Initialize Firebase service first if available
    const initializeEnhancedSystem = function() {
        // Check if enhanced system is available
        if (window.EnhancedLessonIntegrationManager) {
            console.log('‚úÖ Enhanced lesson system available, initializing...');
            try {
                // Get lesson ID from the URL or data attribute
                const lessonId = document.querySelector('meta[name="lesson-id"]')?.content || 
                                 window.lessonData?.id || 
                                 window.location.pathname.split('/').pop();
                
                // Create the manager with initial data
                window.currentLessonManager = new window.EnhancedLessonIntegrationManager(
                    lessonId, 
                    window.lessonData || null
                );
                
                // Initialize the system
                window.currentLessonManager.initialize().catch(error => {
                    console.error('‚ùå Enhanced initialization error:', error);
                    // Fallback to legacy if enhanced fails
                    fallbackToLegacy();
                });
                
                return true;
            } catch (error) {
                console.error('‚ùå Error initializing enhanced system:', error);
                return false;
            }
        }
        return false;
    };
    
    const fallbackToLegacy = function() {
        console.warn('‚ö†Ô∏è Enhanced system not ready, using legacy initialization...');
        setTimeout(() => {
            try {
                if (typeof initializeLesson === 'function') {
                    initializeLesson();
                } else {
                    console.error('‚ùå Legacy initialization function not found');
                    showFallbackContent();
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize lesson:', error);
                showFallbackContent();
            }
        }, 100);
    };
    
    // Try to initialize Firebase first
    if (window.enhancedFirebaseLessonService) {
        window.enhancedFirebaseLessonService.init().then(() => {
            console.log('üî• Firebase service initialized');
            // Now try to initialize the enhanced system
            if (!initializeEnhancedSystem()) {
                fallbackToLegacy();
            }
        }).catch(err => {
            console.error('‚ùå Firebase initialization error:', err);
            // Still try to initialize enhanced system even if Firebase fails
            if (!initializeEnhancedSystem()) {
                fallbackToLegacy();
            }
        });
    } else {
        console.error('‚ùå Enhanced Firebase service not found!');
        // Still try to initialize enhanced system even if Firebase service isn't found
        if (!initializeEnhancedSystem()) {
            fallbackToLegacy();
        }
    }
});

// Legacy Compatibility Layer
<script src="{{ url_for('static', filename='js/compatibility/legacy-lesson-renderer.js') }}"></script>

// Enhanced fallback initialization with better error handling
window.addEventListener('load', function() {
    // Enhanced system check
    if (window.EnhancedLessonTemplate) {
        console.log('‚úÖ Enhanced lesson system loaded and ready');
        return;
    }
    
    // Legacy fallback check
    const container = document.getElementById('lesson-content-container');
    if (container && container.children.length === 0) {
        console.log('‚ö†Ô∏è Lesson not initialized, attempting legacy fallback...');
        setTimeout(() => {
            try {
                initializeLesson();
            } catch (error) {
        }, 500);
    }
});

console.log('‚úÖ Lesson initialization scripts loaded');
</script>

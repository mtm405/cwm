{% extends "base.html" %}

{% block title %}{{ lesson.title if lesson else "Lesson" }} - Code with Morais{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/lesson.css') }}">
{% endblock %}

{% block content %}
<div class="lesson-container">
    <!-- LESSON HEADER SECTION -->
    <header class="lesson-header">
        {% include 'components/lesson/back-link.html' %}
        
        <div class="lesson-header-content">
            <div class="lesson-meta">
                <h1 class="lesson-title">
                    <i class="fas fa-{{ lesson.icon or 'code' }}"></i>
                    {{ lesson.title }}
                </h1>
                <div class="lesson-badges">
                    <span class="difficulty-badge {{ lesson.difficulty or 'beginner' }}">
                        {{ (lesson.difficulty or 'beginner')|title }}
                    </span>
                    <span class="time-badge">
                        <i class="fas fa-clock"></i> {{ lesson.estimated_time or 30 }}min
                    </span>
                    <span class="xp-badge">
                        <i class="fas fa-star"></i> {{ lesson.xp_reward or 100 }} XP
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- LESSON CONTENT -->
    <div class="lesson-content">
        {% if lesson.content %}
            {% for content_block in lesson.content %}
                {% if content_block.type == 'text' %}
                    <div class="content-block text-block">
                        {{ content_block.content | markdown if content_block.content else 'No content available' }}
                    </div>
                {% elif content_block.type == 'code_example' %}
                    <div class="content-block code-block">
                        <div class="code-container">
                            <div class="code-header">
                                <span class="language-tag">{{ content_block.language or 'python' }}</span>
                                <button class="copy-btn" onclick="copyCode(this)">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <pre><code class="language-{{ content_block.language or 'python' }}">{{ content_block.code }}</code></pre>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="lesson-description">
                <p>{{ lesson.description or 'No content available for this lesson yet.' }}</p>
            </div>
        {% endif %}
        
        <!-- Progress Section -->
        {% if lesson.subtopics %}
            <div class="lesson-progress">
                <h3>Lesson Progress</h3>
                <div class="subtopics-list">
                    {% for subtopic in lesson.subtopics %}
                        <div class="subtopic-item" data-subtopic-id="{{ subtopic.id if subtopic.id else loop.index0 }}">
                            <div class="subtopic-content">
                                <i class="fas fa-circle-check progress-icon"></i>
                                <span class="subtopic-title">{{ subtopic.title if subtopic.title else subtopic }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Copy code functionality
function copyCode(button) {
    const codeBlock = button.closest('.code-container').querySelector('code');
    const text = codeBlock.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const icon = button.querySelector('i');
        const originalClass = icon.className;
        icon.className = 'fas fa-check';
        button.textContent = ' Copied!';
        button.insertBefore(icon, button.firstChild);
        
        setTimeout(() => {
            icon.className = originalClass;
            button.textContent = ' Copy';
            button.insertBefore(icon, button.firstChild);
        }, 2000);
    });
}

// Lesson progress tracking
document.addEventListener('DOMContentLoaded', function() {
    const subtopicItems = document.querySelectorAll('.subtopic-item');
    
    subtopicItems.forEach(item => {
        item.addEventListener('click', function() {
            const subtopicId = this.dataset.subtopicId;
            const icon = this.querySelector('.progress-icon');
            
            // Toggle completion state
            if (icon.classList.contains('fa-circle-check')) {
                icon.classList.remove('fa-circle-check');
                icon.classList.add('fa-circle');
                this.classList.remove('completed');
            } else {
                icon.classList.remove('fa-circle');
                icon.classList.add('fa-circle-check');
                this.classList.add('completed');
                
                // Send completion to backend
                markSubtopicComplete(subtopicId);
            }
        });
    });
});

// API call to mark subtopic as complete
function markSubtopicComplete(subtopicId) {
    const lessonId = '{{ lesson.id }}';
    
    fetch('/api/lesson/complete-subtopic', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            lesson_id: lessonId,
            subtopic_id: subtopicId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Subtopic marked as complete');
        }
    })
    .catch(error => {
        console.error('Error marking subtopic complete:', error);
    });
}
</script>
{% endblock %}

<!--
Template: Emergency JS Fix - Include this before all other scripts
Purpose: Fixes all JavaScript loading and module issues
Usage: Include this at the very top of the head section before any other scripts
-->

<!-- EMERGENCY JAVASCRIPT FIX - LOAD FIRST -->
<script>
/**
 * Pre-Load JavaScript Error Prevention and Recovery System
 * This script MUST load before any other JavaScript to prevent critical errors
 */

console.log('ðŸš¨ Emergency JavaScript Fix - Pre-loading error prevention...');

// ===== IMMEDIATE ERROR PREVENTION =====

// 1. Fix module system issues immediately
(function() {
    // Store original console methods
    const originalConsoleError = console.error;
    const originalConsoleWarn = console.warn;
    
    // Intercept and handle module errors
    console.error = function(...args) {
        const message = args.join(' ');
        
        // Suppress module loading errors that we handle
        if (message.includes('Cannot use import statement outside a module') ||
            message.includes('Unexpected token \'export\'') ||
            message.includes('Unexpected token \'import\'')) {
            console.warn('ðŸ”§ Module error intercepted and handled by emergency fix');
            return;
        }
        
        return originalConsoleError.apply(console, args);
    };
    
    // 2. Create immediate fallback for critical objects
    window.emergencyFallbacks = {
        AppUtils: class {
            showNotification(msg, type) { 
                console.log(`[${type.toUpperCase()}] ${msg}`);
            }
            handleError(error, context) { 
                console.error(`${context}:`, error);
            }
        },
        
        EventBus: class {
            constructor() { this.events = {}; }
            on(event, cb) { 
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(cb);
            }
            emit(event, data) {
                if (this.events[event]) {
                    this.events[event].forEach(cb => cb(data));
                }
            }
            off(event, cb) {
                if (this.events[event]) {
                    this.events[event] = this.events[event].filter(c => c !== cb);
                }
            }
        }
    };
    
    // 3. Enhanced base64 decoder
    const originalAtob = window.atob;
    window.atob = function(str) {
        try {
            if (!str || typeof str !== 'string') return '';
            
            // Clean and pad the string
            let cleaned = str.replace(/[^A-Za-z0-9+/]/g, '');
            while (cleaned.length % 4) {
                cleaned += '=';
            }
            return originalAtob(cleaned);
        } catch (error) {
            console.warn('Base64 decode failed, returning empty string');
            return '';
        }
    };
    
    // 4. Safe token extraction
    window.extractUserFromToken = function(token) {
        if (!token || typeof token !== 'string') return false;
        
        try {
            const parts = token.split('.');
            if (parts.length !== 3) return false;
            
            const payload = atob(parts[1]);
            if (!payload) return false;
            
            const decoded = JSON.parse(payload);
            const userInfo = {
                id: decoded.sub || decoded.user_id || decoded.id,
                email: decoded.email,
                name: decoded.name || decoded.given_name,
                picture: decoded.picture
            };
            
            if (userInfo.id || userInfo.email) {
                localStorage.setItem('cwm_user_profile', JSON.stringify(userInfo));
                window.currentUser = userInfo;
                return true;
            }
        } catch (error) {
            console.warn('Token extraction failed:', error);
        }
        return false;
    };
    
    // 5. Create essential globals immediately
    if (!window.AppUtils) {
        window.AppUtils = window.emergencyFallbacks.AppUtils;
        window.appUtils = new window.AppUtils();
    }
    
    if (!window.eventBus) {
        window.eventBus = new window.emergencyFallbacks.EventBus();
    }
    
    // 6. Handle missing API endpoints
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
        if (typeof url === 'string' && url.includes('/api/auth/refresh-token')) {
            return Promise.resolve(new Response(
                JSON.stringify({ error: 'Endpoint not implemented' }), 
                { status: 404, headers: { 'Content-Type': 'application/json' } }
            ));
        }
        return originalFetch.call(this, url, options);
    };
    
    // 7. Global error handlers
    window.addEventListener('error', (event) => {
        const message = event.error?.message || event.message || '';
        
        if (message.includes('Cannot use import statement') || 
            message.includes('Unexpected token')) {
            console.log('ðŸ”§ Module error handled by emergency system');
            event.preventDefault();
            return;
        }
        
        if (message.includes('is not defined')) {
            console.log('ðŸ”§ Reference error handled by emergency system');
            event.preventDefault();
            return;
        }
    });
    
    window.addEventListener('unhandledrejection', (event) => {
        console.warn('ðŸš¨ Unhandled rejection handled by emergency system:', event.reason);
        event.preventDefault();
    });
    
    console.log('âœ… Emergency JavaScript Fix - Pre-load protection active');
})();

// 8. Module compatibility layer
window.moduleCompat = {
    exports: {},
    register(name, obj) {
        this.exports[name] = obj;
        window[name] = obj;
    },
    get(name) {
        return this.exports[name] || window[name];
    }
};

// 9. Essential function definitions
window.refreshDashboard = function() {
    if (window.modernDashboardManager?.refreshDashboard) {
        window.modernDashboardManager.refreshDashboard();
    } else {
        console.log('ðŸ”„ Dashboard refresh requested, reloading page');
        location.reload();
    }
};

window.initializeFallbacks = function() {
    console.log('ðŸ”§ Initializing emergency fallbacks...');
    
    // Dashboard fallback
    if (!window.ModernDashboardManager) {
        window.ModernDashboardManager = class {
            constructor() { this.initialized = false; }
            async init() { 
                console.log('ðŸ“Š Dashboard initialized (emergency fallback)');
                this.initialized = true;
            }
            refreshDashboard() {
                console.log('ðŸ”„ Dashboard refresh');
                location.reload();
            }
        };
    }
    
    // Initialize based on page
    const page = document.body?.dataset?.page;
    if (page === 'dashboard' && !window.modernDashboardManager) {
        window.modernDashboardManager = new window.ModernDashboardManager();
        window.modernDashboardManager.init();
    }
};

// 10. Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', window.initializeFallbacks);
} else {
    setTimeout(window.initializeFallbacks, 100);
}

console.log('ðŸš¨ Emergency JavaScript Fix - All pre-load protections active');
</script>

<!-- Load our comprehensive error fix -->
<script src="{{ url_for('static', filename='js/complete-error-fix.js') }}" async></script>

<!-- Load AppUtils before other scripts that depend on it -->
<script src="{{ url_for('static', filename='js/modules/app-utils.js') }}" defer></script>

<!-- ACE Editor Fallback (load before any code editor usage) -->
<script>
// Provide ACE editor fallback immediately
if (typeof window.ace === 'undefined') {
    window.ace = {
        edit: function(elementId) {
            console.log('ðŸ”„ ACE editor fallback for:', elementId);
            const element = document.getElementById(elementId);
            if (element && element.tagName.toLowerCase() === 'div') {
                const textarea = document.createElement('textarea');
                textarea.id = elementId;
                textarea.className = element.className + ' ace-fallback';
                textarea.style.cssText = 'width: 100%; height: 200px; font-family: monospace; padding: 10px; border: 1px solid #ccc;';
                textarea.value = element.textContent || '';
                element.parentNode.replaceChild(textarea, element);
                
                return {
                    setValue: (val) => textarea.value = val,
                    getValue: () => textarea.value,
                    setTheme: () => {},
                    session: { setMode: () => {}, setTabSize: () => {}, setUseSoftTabs: () => {} },
                    setOptions: () => {},
                    resize: () => {}
                };
            }
            return {
                setValue: () => {}, getValue: () => '', setTheme: () => {},
                session: { setMode: () => {}, setTabSize: () => {}, setUseSoftTabs: () => {} },
                setOptions: () => {}, resize: () => {}
            };
        }
    };
}
</script>

<!--
Google Auth Debug Test Page
Purpose: Debug and test Google OAuth integration
Usage: Access at /debug/google-auth
-->
{% extends "base/layout.html" %}

{% block page_name %}debug-auth{% endblock %}

{% block title %}Google Auth Debug - Code with Morais{% endblock %}

{% block content %}
<div class="debug-container" style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
    <h1>üîç Google Auth Debug Console</h1>
    
    <!-- Configuration Check -->
    <div class="debug-section">
        <h2>üìã Configuration Status</h2>
        <div id="config-status" class="status-grid">
            <div class="status-card">
                <h3>Google Client ID</h3>
                <p id="client-id-status">Checking...</p>
            </div>
            <div class="status-card">
                <h3>Callback Function</h3>
                <p id="callback-status">Checking...</p>
            </div>
            <div class="status-card">
                <h3>Google Identity Services</h3>
                <p id="gsi-status">Checking...</p>
            </div>
        </div>
    </div>
    
    <!-- Test Google Sign-In -->
    <div class="debug-section">
        <h2>üîê Test Google Sign-In</h2>
        <div class="signin-test">
            <div class="signin-wrapper">
                <div id="g_id_onload"
                     data-client_id="{{ google_client_id }}"
                     data-context="signin"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="filled_blue"
                     data-text="signin_with"
                     data-shape="pill"
                     data-logo_alignment="left">
                </div>
            </div>
            <p>üëÜ Click the button above to test Google Sign-In</p>
        </div>
    </div>
    
    <!-- Auth Flow Monitor -->
    <div class="debug-section">
        <h2>üìä Authentication Flow Monitor</h2>
        <div id="auth-log" class="log-container">
            <p>Waiting for authentication events...</p>
        </div>
        <button onclick="clearLog()" class="btn btn-secondary">Clear Log</button>
    </div>
    
    <!-- Backend Test -->
    <div class="debug-section">
        <h2>üîß Backend Test</h2>
        <button onclick="testBackendEndpoint()" class="btn btn-primary">Test /auth/google/callback</button>
        <div id="backend-test-result" class="test-result"></div>
    </div>
    
    <!-- Session Info -->
    <div class="debug-section">
        <h2>üë§ Current Session</h2>
        <div id="session-info" class="session-display">
            <p>Loading session information...</p>
        </div>
    </div>
</div>

<style>
.debug-container {
    font-family: 'Inter', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
}

.debug-section {
    margin-bottom: 3rem;
    padding: 2rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.debug-section h2 {
    margin-bottom: 1.5rem;
    color: var(--primary-color);
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.status-card {
    padding: 1.5rem;
    background: var(--bg-primary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.status-card h3 {
    margin-bottom: 0.5rem;
    font-size: 1rem;
    color: var(--text-primary);
}

.signin-test {
    text-align: center;
    padding: 2rem;
    background: var(--bg-primary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.log-container {
    background: #000;
    color: #00ff00;
    padding: 1rem;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    height: 300px;
    overflow-y: auto;
    border: 1px solid #333;
}

.test-result {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--bg-primary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.session-display {
    background: var(--bg-primary);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.status-ok { color: #28a745; }
.status-error { color: #dc3545; }
.status-warning { color: #ffc107; }

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-secondary {
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}
</style>

<script>
// Enhanced debug logging
function addLog(message, type = 'info') {
    const logContainer = document.getElementById('auth-log');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
    logEntry.style.color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : '#00ff00';
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

function clearLog() {
    document.getElementById('auth-log').innerHTML = '<p>Log cleared...</p>';
}

// Check configuration status
function checkConfiguration() {
    // Check Google Client ID
    const clientId = '{{ google_client_id }}';
    const clientIdElement = document.getElementById('client-id-status');
    if (clientId && clientId !== '') {
        clientIdElement.innerHTML = `<span class="status-ok">‚úÖ Present (${clientId.substring(0, 20)}...)</span>`;
    } else {
        clientIdElement.innerHTML = '<span class="status-error">‚ùå Missing</span>';
    }
    
    // Check callback function
    const callbackElement = document.getElementById('callback-status');
    if (typeof window.handleCredentialResponse === 'function') {
        callbackElement.innerHTML = '<span class="status-ok">‚úÖ Defined</span>';
    } else {
        callbackElement.innerHTML = '<span class="status-error">‚ùå Not defined</span>';
    }
    
    // Check Google Identity Services
    const gsiElement = document.getElementById('gsi-status');
    if (typeof google !== 'undefined' && google.accounts) {
        gsiElement.innerHTML = '<span class="status-ok">‚úÖ Loaded</span>';
    } else {
        gsiElement.innerHTML = '<span class="status-warning">‚ö†Ô∏è Loading...</span>';
        // Recheck after a delay
        setTimeout(() => {
            if (typeof google !== 'undefined' && google.accounts) {
                gsiElement.innerHTML = '<span class="status-ok">‚úÖ Loaded</span>';
            } else {
                gsiElement.innerHTML = '<span class="status-error">‚ùå Failed to load</span>';
            }
        }, 2000);
    }
}

// Enhanced handleCredentialResponse for debugging
function handleCredentialResponse(response) {
    addLog('üîê Google Sign-In response received', 'info');
    addLog(`Token length: ${response.credential ? response.credential.length : 'N/A'}`, 'info');
    
    if (!response || !response.credential) {
        addLog('‚ùå Invalid response: No credential provided', 'error');
        return;
    }
    
    addLog('üì§ Sending token to backend...', 'info');
    
    // Show loading state
    const authButtons = document.querySelectorAll('.g_id_signin');
    authButtons.forEach(btn => {
        if (btn) {
            btn.style.opacity = '0.6';
            btn.style.pointerEvents = 'none';
        }
    });
    
    // Send token to backend
    fetch('/auth/google/callback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ token: response.credential })
    })
    .then(response => {
        addLog(`üì• Backend response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
        return response.json();
    })
    .then(data => {
        addLog(`üìä Response data: ${JSON.stringify(data, null, 2)}`, data.success ? 'success' : 'error');
        
        if (data.success) {
            addLog('‚úÖ Authentication successful!', 'success');
            addLog(`üë§ User: ${data.user ? data.user.email : 'Unknown'}`, 'success');
            
            // Update session display
            updateSessionInfo();
            
            // Redirect after a delay to show the success message
            setTimeout(() => {
                addLog('üîÑ Redirecting to dashboard...', 'info');
                window.location.href = data.redirect_url || '/dashboard';
            }, 2000);
        } else {
            addLog(`‚ùå Authentication failed: ${data.error}`, 'error');
            
            // Re-enable buttons
            authButtons.forEach(btn => {
                if (btn) {
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                }
            });
        }
    })
    .catch(error => {
        addLog(`‚ùå Network error: ${error.message}`, 'error');
        console.error('Authentication error:', error);
        
        // Re-enable buttons
        authButtons.forEach(btn => {
            if (btn) {
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }
        });
    });
}

// Test backend endpoint
function testBackendEndpoint() {
    const resultDiv = document.getElementById('backend-test-result');
    resultDiv.innerHTML = '<p>Testing backend endpoint...</p>';
    
    fetch('/auth/google/callback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ token: 'test-token' })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.innerHTML = `
            <h4>Backend Test Result:</h4>
            <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
        
        if (data.error && data.error.includes('Invalid token')) {
            resultDiv.innerHTML += '<p style="color: #28a745;">‚úÖ Endpoint is working (correctly rejected test token)</p>';
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <h4>Backend Test Error:</h4>
            <p style="color: #dc3545;">${error.message}</p>
        `;
    });
}

// Update session information
function updateSessionInfo() {
    fetch('/auth/status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('session-info').innerHTML = `
                <h4>Session Status:</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        })
        .catch(error => {
            document.getElementById('session-info').innerHTML = `
                <h4>Session Error:</h4>
                <p style="color: #dc3545;">${error.message}</p>
            `;
        });
}

// Make handleCredentialResponse available globally
window.handleCredentialResponse = handleCredentialResponse;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    addLog('üöÄ Debug page loaded', 'info');
    checkConfiguration();
    updateSessionInfo();
    
    // Log any existing Google Identity Services errors
    if (window.console && console.error) {
        const originalError = console.error;
        console.error = function(...args) {
            if (args[0] && args[0].includes && args[0].includes('GSI')) {
                addLog(`üêõ GSI Error: ${args[0]}`, 'error');
            }
            originalError.apply(console, args);
        };
    }
});
</script>
{% endblock %}

{% block extra_js %}
<!-- Google Sign-In -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
{% endblock %}

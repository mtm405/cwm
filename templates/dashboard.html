{% extends "base.html" %}

{% block page_name %}dashboard{% endblock %}

{% block title %}Dashboard - Code with Morais{% endblock %}

{% block sidebar %}
<!-- Sidebar removed for modern full-width layout -->
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Modern Header with Navigation Tabs -->
    <header class="modern-dashboard-header">
        <div class="header-content">
            <div class="welcome-section">
                <h1 id="welcome-message">Welcome back, Student! 🚀</h1>
                <p class="dashboard-subtitle">Ready to continue your Python journey?</p>
            </div>
            
            <div class="header-actions">
                <button class="refresh-dashboard btn btn-ghost" title="Refresh Dashboard">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <a href="/lessons" class="btn btn-primary">
                    <i class="fas fa-book"></i> Continue Learning
                </a>
            </div>
        </div>
        
        <!-- Quick Navigation Tabs -->
        <nav class="dashboard-nav">
            <button class="nav-tab active" data-tab="overview">
                <i class="fas fa-chart-line"></i> Overview
            </button>
            <button class="nav-tab" data-tab="challenge">
                <i class="fas fa-calendar-day"></i> Daily Challenge
            </button>
            <button class="nav-tab" data-tab="leaderboard">
                <i class="fas fa-trophy"></i> Leaderboard
            </button>
            <button class="nav-tab" data-tab="activity">
                <i class="fas fa-stream"></i> Activity
            </button>
        </nav>
    </header>
    
    <!-- Tab Content Sections -->
    <div class="tab-content">
        
        <!-- Overview Tab -->
        <div class="tab-pane active" id="overview-tab">
            <!-- Modern Stats Cards -->
            <section class="stats-section">
                <div class="stats-grid-modern">
                    <div class="stat-card-modern primary" data-stat="xp">
                        <div class="stat-header">
                            <i class="stat-icon fas fa-star"></i>
                            <span class="stat-trend">+25%</span>
                        </div>
                        <div class="stat-body">
                            <span class="stat-value-large">{{ user.get('xp', 0) }}</span>
                            <span class="stat-label">Total XP</span>
                        </div>
                        <div class="stat-progress">
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: 75%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card-modern success" data-stat="pycoins">
                        <div class="stat-header">
                            <i class="stat-icon fas fa-coins"></i>
                            <span class="stat-trend">+12</span>
                        </div>
                        <div class="stat-body">
                            <span class="stat-value-large">{{ user.get('pycoins', 0) }}</span>
                            <span class="stat-label">PyCoins</span>
                        </div>
                        <div class="stat-progress">
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: 60%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card-modern warning" data-stat="level">
                        <div class="stat-header">
                            <i class="stat-icon fas fa-trophy"></i>
                            <span class="stat-trend">Level Up!</span>
                        </div>
                        <div class="stat-body">
                            <span class="stat-value-large">{{ user.get('level', 1) }}</span>
                            <span class="stat-label">Current Level</span>
                        </div>
                        <div class="stat-progress">
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: 85%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card-modern info" data-stat="streak">
                        <div class="stat-header">
                            <i class="stat-icon fas fa-fire"></i>
                            <span class="stat-trend">🔥 Hot!</span>
                        </div>
                        <div class="stat-body">
                            <span class="stat-value-large">{{ user.get('streak', 0) }}</span>
                            <span class="stat-label">Day Streak</span>
                        </div>
                        <div class="stat-progress">
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: 90%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Learning Path Dashboard -->
            <section class="learning-dashboard">
                <div class="dashboard-grid">
                    <!-- Continue Learning Card -->
                    <div class="dashboard-card featured">
                        <div class="card-header-modern">
                            <h3><i class="fas fa-play-circle"></i> Continue Learning</h3>
                            <span class="card-status">Ready</span>
                        </div>
                        <div class="card-content">
                            <div class="lesson-preview">
                                <div class="lesson-thumbnail">
                                    <i class="fas fa-python"></i>
                                </div>
                                <div class="lesson-info">
                                    <h4>Python Fundamentals</h4>
                                    <p>Next: Variables and Data Types</p>
                                    <div class="lesson-progress-modern">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: {{ ((user.get('lessons_completed', [])|length / 10) * 100)|round }}%"></div>
                                        </div>
                                        <span class="progress-text">{{ user.get('lessons_completed', [])|length }}/10 completed</span>
                                    </div>
                                </div>
                            </div>
                            <a href="/lessons" class="btn btn-primary btn-block">
                                <i class="fas fa-arrow-right"></i> Continue Journey
                            </a>
                        </div>
                    </div>
                    
                    <!-- Quick Stats Card -->
                    <div class="dashboard-card">
                        <div class="card-header-modern">
                            <h3><i class="fas fa-chart-line"></i> Your Progress</h3>
                        </div>
                        <div class="card-content">
                            <div class="progress-stats-modern">
                                <div class="progress-item-modern">
                                    <div class="progress-icon">
                                        <i class="fas fa-graduation-cap"></i>
                                    </div>
                                    <div class="progress-details">
                                        <span class="progress-label">Lessons</span>
                                        <span class="progress-value">{{ user.get('lessons_completed', [])|length }}/10</span>
                                    </div>
                                </div>
                                <div class="progress-item-modern">
                                    <div class="progress-icon">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <div class="progress-details">
                                        <span class="progress-label">Next Level</span>
                                        <span class="progress-value">{{ (user.get('level', 1)|int) + 1 }}</span>
                                    </div>
                                </div>
                                <div class="progress-item-modern">
                                    <div class="progress-icon">
                                        <i class="fas fa-target"></i>
                                    </div>
                                    <div class="progress-details">
                                        <span class="progress-label">XP Needed</span>
                                        {% set xp_needed = ((user.get('level', 1)|int + 1) * 100) - user.get('xp', 0)|int %}
                                        <span class="progress-value">{{ xp_needed if xp_needed > 0 else 0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity Card -->
                    <div class="dashboard-card">
                        <div class="card-header-modern">
                            <h3><i class="fas fa-clock"></i> Recent Activity</h3>
                            <button class="btn btn-ghost btn-sm">View All</button>
                        </div>
                        <div class="card-content">
                            <div class="activity-feed-compact">
                                <div class="activity-item">
                                    <div class="activity-icon success">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="activity-details">
                                        <p>Completed: Python Basics</p>
                                        <span class="activity-time">2 hours ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon primary">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div class="activity-details">
                                        <p>Earned 50 XP</p>
                                        <span class="activity-time">3 hours ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon warning">
                                        <i class="fas fa-fire"></i>
                                    </div>
                                    <div class="activity-details">
                                        <p>5-day streak!</p>
                                        <span class="activity-time">Yesterday</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Challenge Tab -->
        <div class="tab-pane" id="challenge-tab">
            <section class="challenge-section">
                <div class="challenge-card-modern">
                    {% if daily_challenge %}
                    <div class="challenge-header">
                        <div class="challenge-title">
                            <h2><i class="fas fa-calendar-day"></i> {{ daily_challenge.title }}</h2>
                            <div class="challenge-timer">
                                <i class="fas fa-clock"></i>
                                <span>Time left: <span id="daily-timer">23h 45m</span></span>
                            </div>
                        </div>
                        <div class="challenge-difficulty difficulty-{{ daily_challenge.difficulty }}">
                            <i class="fas fa-signal"></i>
                            {{ daily_challenge.difficulty|title }}
                        </div>
                    </div>
                    
                    <div class="challenge-content">
                        <p class="challenge-description">{{ daily_challenge.description }}</p>
                        
                        <div class="challenge-rewards-modern">
                            <div class="reward-card">
                                <i class="fas fa-star"></i>
                                <span class="reward-value">+{{ daily_challenge.xp_reward }}</span>
                                <span class="reward-label">XP</span>
                            </div>
                            <div class="reward-card">
                                <i class="fas fa-coins"></i>
                                <span class="reward-value">+{{ daily_challenge.coin_reward }}</span>
                                <span class="reward-label">PyCoins</span>
                            </div>
                        </div>
                        
                        <div class="challenge-actions-modern">
                            <button class="btn btn-primary btn-lg" data-challenge-id="{{ daily_challenge.id }}">
                                <i class="fas fa-play"></i> Start Challenge
                            </button>
                            <button class="btn btn-secondary">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="no-challenge-modern">
                        <div class="no-challenge-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <h3>No Challenge Today</h3>
                        <p>Check back tomorrow for a new coding challenge!</p>
                        <button class="btn btn-secondary">
                            <i class="fas fa-history"></i> View Previous Challenges
                        </button>
                    </div>
                    {% endif %}
                </div>
            </section>
        </div>
        
        <!-- Leaderboard Tab -->
        <div class="tab-pane" id="leaderboard-tab">
            <section class="leaderboard-section">
                <div class="leaderboard-card-modern">
                    <div class="leaderboard-header">
                        <h2><i class="fas fa-trophy"></i> Global Leaderboard</h2>
                        <div class="leaderboard-controls">
                            <select class="filter-select">
                                <option value="all">All Time</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="leaderboard-modern">
                        {% for user_entry in leaderboard %}
                        <div class="leaderboard-item-modern {% if user_entry.username == user.get('username') %}current-user{% endif %}">
                            <div class="leaderboard-rank">
                                {% if loop.index <= 3 %}
                                    <i class="fas fa-trophy rank-{{ loop.index }}"></i>
                                {% else %}
                                    <span class="rank-number">{{ loop.index }}</span>
                                {% endif %}
                            </div>
                            <div class="leaderboard-avatar">
                                <img src="{{ user_entry.profile_picture or '/static/img/default-avatar.png' }}" alt="Avatar">
                                {% if user_entry.username == user.get('username') %}
                                <span class="you-badge">YOU</span>
                                {% endif %}
                            </div>
                            <div class="leaderboard-info">
                                <span class="username">{{ user_entry.username }}</span>
                                <span class="level">Level {{ user_entry.level }}</span>
                            </div>
                            <div class="leaderboard-stats">
                                <span class="xp-value">{{ user_entry.xp }} XP</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Activity Tab -->
        <div class="tab-pane" id="activity-tab">
            <section class="activity-section">
                <div class="activity-card-modern">
                    <div class="activity-header">
                        <h2><i class="fas fa-stream"></i> Recent Activity</h2>
                        <div class="activity-controls">
                            <button class="btn btn-secondary btn-sm">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="activity-feed-modern">
                        <div class="activity-item-large">
                            <div class="activity-icon-large success">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div class="activity-content">
                                <h4>Lesson Completed</h4>
                                <p>You completed "Python Basics: Variables"</p>
                                <div class="activity-rewards">
                                    <span class="reward-badge">+50 XP</span>
                                    <span class="reward-badge">+10 PyCoins</span>
                                </div>
                                <span class="activity-time">2 hours ago</span>
                            </div>
                        </div>
                        
                        <div class="activity-item-large">
                            <div class="activity-icon-large primary">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="activity-content">
                                <h4>Achievement Unlocked</h4>
                                <p>First Steps - Complete your first lesson</p>
                                <div class="activity-rewards">
                                    <span class="reward-badge special">🏆 Achievement</span>
                                </div>
                                <span class="activity-time">3 hours ago</span>
                            </div>
                        </div>
                        
                        <div class="activity-item-large">
                            <div class="activity-icon-large warning">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="activity-content">
                                <h4>Streak Milestone</h4>
                                <p>You've maintained a 5-day learning streak!</p>
                                <div class="activity-rewards">
                                    <span class="reward-badge">+25 XP</span>
                                </div>
                                <span class="activity-time">Yesterday</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
    </div> <!-- End of tab-content -->
    
</div> <!-- End of dashboard-container -->
        <div class="card-header">
            <h2><i class="fas fa-calendar-day"></i> Daily Challenge</h2>
            <div class="challenge-timer">
                <i class="fas fa-clock"></i>
                <span>Time left: <span id="daily-timer" data-target="23:59:59">23h 45m</span></span>
            </div>
        </div>
        
        <div class="challenge-content" id="challenge-content">
            {% if daily_challenge %}
            <div class="challenge-info">
                <h3>{{ daily_challenge.title }}</h3>
                <p class="challenge-description">{{ daily_challenge.description }}</p>
                
                <div class="challenge-rewards">
                    <div class="reward-item">
                        <i class="fas fa-star"></i>
                        <span>+{{ daily_challenge.xp_reward }} XP</span>
                    </div>
                    <div class="reward-item">
                        <i class="fas fa-coins"></i>
                        <span>+{{ daily_challenge.coin_reward }} PyCoins</span>
                    </div>
                    <div class="difficulty-badge difficulty-{{ daily_challenge.difficulty }}">
                        <i class="fas fa-signal"></i>
                        {{ daily_challenge.difficulty|title }}
                    </div>
                </div>
                
                <div class="challenge-actions">
                    <button class="btn btn-primary challenge-start-btn" 
                            data-challenge-id="{{ daily_challenge.id }}">
                        <i class="fas fa-play"></i> Start Challenge
                    </button>
                    <button class="btn btn-secondary" onclick="previewChallenge()">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                </div>
            </div>
            {% else %}
            <div class="no-challenge">
                <i class="fas fa-calendar-times"></i>
                <h3>No Challenge Today</h3>
                <p>Check back tomorrow for a new coding challenge!</p>
                <button class="btn btn-secondary" onclick="loadPreviousChallenges()">
                    <i class="fas fa-history"></i> View Previous Challenges
                </button>
            </div>
            {% endif %}
        </div>
    </section>
    
    <!-- Two Column Layout -->
    <div class="dashboard-grid">
        <!-- Leaderboard -->
        <section id="leaderboard" class="card">
            <h2><i class="fas fa-trophy"></i> Global Leaderboard</h2>
            <div class="leaderboard">
                {% for user_entry in leaderboard %}
                <div class="leaderboard-item">
                    <span class="leaderboard-rank">{{ loop.index }}</span>
                    <div class="leaderboard-user">
                        <strong>{{ user_entry.username }}</strong>
                        {% if user_entry.username == user.get('username') %}
                        <span class="you-badge">You!</span>
                        {% endif %}
                    </div>
                    <span class="leaderboard-xp">{{ user_entry.xp }} XP</span>
                </div>
                {% endfor %}
            </div>
            <a href="#" class="btn btn-secondary btn-sm">View Full Leaderboard</a>
        </section>
        
        <!-- Activity Feed -->
        <section id="activity" class="card">
            <h2><i class="fas fa-stream"></i> Recent Activity</h2>
            <div id="activity-feed" class="activity-feed">
                {% for activity in recent_activity %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-{{ activity.icon }}"></i>
                    </div>
                    <div class="activity-content">
                        <p class="activity-message">{{ activity.message }}</p>
                        <span class="activity-time">
                            {% if activity.timestamp %}
                                {{ activity.timestamp.strftime('%H:%M') }}
                            {% else %}
                                Just now
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
    </div>
    
    <!-- IT Specialist Exam Progress -->
    <section id="progress" class="card">
        <h2><i class="fas fa-tasks"></i> IT Specialist Exam Objectives</h2>
        <div id="exam-objectives" class="exam-objectives">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i> Loading exam objectives...
            </div>
        </div>
        <div class="exam-readiness" id="exam-readiness">
            <h3>Overall Exam Readiness</h3>
            <div class="readiness-score" id="readiness-score">
                <div class="score-circle">
                    <span id="readiness-percentage">0%</span>
                </div>
                <p>Ready for IT Specialist Certification</p>
            </div>
        </div>
    </section>
</div>

<style>
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
}

.progress-overview {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    align-items: center;
}

.current-lesson h3 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.progress-stats {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.progress-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem;
    background-color: var(--bg-secondary);
    border-radius: 8px;
}

.progress-label {
    color: var(--text-secondary);
}

.progress-value {
    font-weight: bold;
    color: var(--primary-color);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.timer {
    color: var(--secondary-color);
    font-weight: bold;
}

.challenge-content h3 {
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.challenge-rewards {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.challenge-rewards span {
    padding: 0.5rem 1rem;
    background-color: var(--bg-secondary);
    border-radius: 20px;
    font-size: 0.9rem;
}

.difficulty {
    font-weight: bold;
}

.difficulty-easy { color: var(--success-color); }
.difficulty-medium { color: var(--warning-color); }
.difficulty-hard { color: var(--danger-color); }

.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin: 2rem 0;
}

.you-badge {
    background-color: var(--primary-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-left: 0.5rem;
}

.exam-objectives {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.objective-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    background-color: var(--bg-secondary);
}

.objective-item.completed {
    border-left: 4px solid var(--success-color);
}

.objective-item.active {
    border-left: 4px solid var(--primary-color);
}

.objective-item i {
    font-size: 1.5rem;
    width: 24px;
}

.objective-item.completed i {
    color: var(--success-color);
}

.objective-item.active i {
    color: var(--primary-color);
}

.objective-content {
    flex: 1;
}

.objective-content h4 {
    margin-bottom: 0.25rem;
}

.objective-content p {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.objective-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0.5rem 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.lesson-count {
    color: var(--primary-color);
    font-weight: 500;
}

.weight {
    background-color: var(--bg-tertiary);
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
}

.objective-progress {
    position: relative;
    margin-top: 0.75rem;
}

.progress-bar {
    height: 100%;
    background-color: var(--primary-color);
    transition: width 0.3s ease;
}

.progress-text {
    position: absolute;
    right: 0;
    top: -1.5rem;
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.loading-spinner {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

.loading-spinner i {
    margin-right: 0.5rem;
    color: var(--primary-color);
}

.error {
    text-align: center;
    padding: 2rem;
    color: var(--error-color);
    background-color: var(--error-bg);
    border-radius: 8px;
    margin: 1rem 0;
}

/* Exam Readiness Styles */
.exam-readiness {
    margin-top: 2rem;
    text-align: center;
    padding: 1.5rem;
    background-color: var(--bg-secondary);
    border-radius: 12px;
}

.exam-readiness h3 {
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.readiness-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.score-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Notification styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 300px;
    animation: slideIn 0.3s ease;
}

.notification-success {
    background: linear-gradient(135deg, #4CAF50, #45a049);
}

.notification-error {
    background: linear-gradient(135deg, #f44336, #e53935);
}

.notification-info {
    background: linear-gradient(135deg, #2196F3, #1976D2);
}

.notification button {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    margin-left: auto;
    padding: 0;
    width: 20px;
    height: 20px;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .progress-overview {
        grid-template-columns: 1fr;
    }
    
    .challenge-rewards {
        justify-content: center;
    }
}
</style>

<script>
// Dashboard API integration
class DashboardManager {
    constructor() {
        this.refreshInterval = 30000; // 30 seconds
        this.init();
    }
    
    init() {
        this.loadDashboardStats();
        this.loadExamObjectives();
        this.loadDailyChallenge();
        this.loadLeaderboard();
        this.loadActivityFeed();
        this.loadNextLesson();
        
        // Set up auto-refresh
        setInterval(() => this.refreshData(), this.refreshInterval);
    }
    
    async loadDashboardStats() {
        try {
            const response = await fetch('/api/dashboard/stats');
            const data = await response.json();
            
            if (response.ok && data.user) {
                // Update user stats with animation
                this.updateStatWithAnimation('user-xp', data.user.xp);
                this.updateStatWithAnimation('user-coins', data.user.pycoins);
                
                // Update welcome message with time-based greeting and first name
                const welcomeMsg = document.getElementById('welcome-message');
                if (welcomeMsg && data.user) {
                    const firstName = data.user.first_name || 
                                    (data.user.display_name && data.user.display_name.split(' ')[0]) || 
                                    data.user.username || 'Student';
                    
                    const greeting = this.getTimeBasedGreeting();
                    welcomeMsg.innerHTML = `${greeting}, ${firstName}! 🚀`;
                }
                
                // Update progress information
                if (data.progress) {
                    const progressElement = document.querySelector('.progress-value');
                    if (progressElement) {
                        progressElement.textContent = `${data.progress.completed_lessons}/${data.progress.total_lessons}`;
                    }
                }
                
                // Store user data for other functions
                this.currentUser = data.user;
                
                // Show authentication status
                if (data.authenticated) {
                    console.log('User authenticated, real data loaded');
                }
            } else if (data.guest_mode) {
                console.log('Guest mode active');
                // Set guest greeting
                const welcomeMsg = document.getElementById('welcome-message');
                if (welcomeMsg) {
                    const greeting = this.getTimeBasedGreeting();
                    welcomeMsg.innerHTML = `${greeting}, Guest! 🚀`;
                }
            }
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
        }
    }
    
    getTimeBasedGreeting() {
        const hour = new Date().getHours();
        
        if (hour >= 5 && hour < 12) {
            return 'Good morning';
        } else if (hour >= 12 && hour < 17) {
            return 'Good afternoon';
        } else if (hour >= 17 && hour < 22) {
            return 'Good evening';
        } else {
            return 'Good night';
        }
    }
    
    updateStatWithAnimation(elementId, newValue) {
        const element = document.getElementById(elementId);
        if (element && element.textContent !== newValue.toString()) {
            element.style.transition = 'all 0.3s ease';
            element.style.transform = 'scale(1.1)';
            element.textContent = newValue;
            
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 300);
        }
    }
    
    async loadExamObjectives() {
        try {
            const response = await fetch('/api/dashboard/exam-objectives');
            const data = await response.json();
            
            if (data.objectives) {
                this.renderExamObjectives(data.objectives, data.overall_exam_readiness);
            }
        } catch (error) {
            console.error('Error loading exam objectives:', error);
        }
    }
    
    renderExamObjectives(objectives, overallReadiness) {
        const container = document.querySelector('.exam-objectives');
        if (!container) return;
        
        container.innerHTML = objectives.map(objective => `
            <div class="objective-item ${objective.status}">
                <i class="fas fa-${objective.status === 'completed' ? 'check-circle' : objective.status === 'in-progress' ? 'clock' : 'circle'}"></i>
                <div class="objective-content">
                    <h4>${objective.title}</h4>
                    <p>${objective.description}</p>
                    <div class="objective-progress">
                        <div class="progress-bar" style="width: ${objective.progress}%"></div>
                    </div>
                    <small>${objective.completed_lessons}/${objective.total_lessons} lessons completed (${objective.progress}%)</small>
                </div>
            </div>
        `).join('');
        
        // Update overall exam readiness
        const readinessElement = document.querySelector('.exam-readiness');
        if (readinessElement) {
            readinessElement.innerHTML = `
                <h3>Overall Exam Readiness: ${Math.round(overallReadiness)}%</h3>
                <div class="progress-bar-large">
                    <div class="progress-fill" style="width: ${overallReadiness}%"></div>
                </div>
            `;
        }
    }
    
    async loadDailyChallenge() {
        try {
            const response = await fetch('/api/dashboard/daily-challenge');
            const data = await response.json();
            
            if (data.challenge) {
                const challenge = data.challenge;
                const challengeElement = document.getElementById('daily-challenge-content');
                if (challengeElement) {
                    challengeElement.innerHTML = `
                        <h3>${challenge.title}</h3>
                        <p>${challenge.description}</p>
                        <div class="challenge-rewards">
                            <span class="reward-badge">+${challenge.xp_reward} XP</span>
                            <span class="reward-badge">+${challenge.coin_reward} Coins</span>
                        </div>
                        <button onclick="startDailyChallenge('${challenge.id}')" class="btn btn-primary">
                            Start Challenge
                        </button>
                    `;
                }
            }
        } catch (error) {
            console.error('Error loading daily challenge:', error);
        }
    }
    
    async loadLeaderboard() {
        try {
            const response = await fetch('/api/dashboard/leaderboard');
            const data = await response.json();
            
            if (data.leaderboard) {
                const leaderboardElement = document.querySelector('.leaderboard-list');
                if (leaderboardElement) {
                    leaderboardElement.innerHTML = data.leaderboard.map((user, index) => `
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">#${index + 1}</span>
                            <div class="leaderboard-user">
                                <strong>${user.username}</strong>
                                <span class="level-badge">Level ${user.level}</span>
                            </div>
                            <span class="leaderboard-xp">${user.xp} XP</span>
                        </div>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('Error loading leaderboard:', error);
        }
    }
    
    async loadActivityFeed() {
        try {
            const response = await fetch('/api/dashboard/activity-feed');
            const data = await response.json();
            
            if (response.ok && data.activities) {
                const feedElement = document.getElementById('activity-feed');
                if (feedElement) {
                    feedElement.innerHTML = data.activities.map(activity => `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-${activity.icon || 'code'}"></i>
                            </div>
                            <div class="activity-content">
                                <p class="activity-message">${activity.message}</p>
                                <span class="activity-time">${this.formatTime(activity.timestamp)}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } else if (data.guest_mode) {
                const feedElement = document.getElementById('activity-feed');
                if (feedElement) {
                    feedElement.innerHTML = `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="activity-content">
                                <p class="activity-message">Sign in to track your learning progress!</p>
                                <span class="activity-time">Now</span>
                            </div>
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error('Error loading activity feed:', error);
        }
    }
    
    async loadNextLesson() {
        try {
            const response = await fetch('/api/dashboard/next-lesson');
            const data = await response.json();
            
            if (data.next_lesson) {
                const lesson = data.next_lesson;
                const nextLessonElement = document.querySelector('.current-lesson');
                if (nextLessonElement) {
                    nextLessonElement.innerHTML = `
                        <h3>${lesson.is_review ? 'Review' : 'Continue Learning'}</h3>
                        <h4>${lesson.title}</h4>
                        <p>${lesson.description || 'Ready for your next Python adventure?'}</p>
                        <a href="/lesson/${lesson.id}" class="btn btn-primary">
                            <i class="fas fa-play"></i> ${lesson.is_review ? 'Review Lesson' : 'Continue Lesson'}
                        </a>
                    `;
                }
            }
        } catch (error) {
            console.error('Error loading next lesson:', error);
        }
    }
    
    formatTime(timestamp) {
        if (!timestamp) return 'Just now';
        
        const now = new Date();
        const time = new Date(timestamp);
        const diffMs = now - time;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
        return time.toLocaleDateString();
    }
    
    refreshData() {
        this.loadDashboardStats();
        this.loadActivityFeed();
        // Don't refresh everything too frequently to avoid overwhelming the user
    }
    
    async awardXP(xp, coins, reason) {
        try {
            const response = await fetch('/api/dashboard/award-xp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ xp, coins, reason })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show notification
                this.showNotification(`🎉 ${data.message}`, 'success');
                
                // Update dashboard stats immediately
                this.loadDashboardStats();
                this.loadActivityFeed();
                
                return true;
            } else {
                console.error('Failed to award XP:', data.error);
                return false;
            }
        } catch (error) {
            console.error('Error awarding XP:', error);
            return false;
        }
    }
    
    showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">×</button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
}

function startDailyChallenge(challengeId) {
    if (challengeId) {
        window.location.href = `/challenge/${challengeId}`;
    } else {
        showNotification('Daily challenge started! Good luck! 🚀');
    }
}

// Load Exam Objectives
async function loadExamObjectives() {
    try {
        const response = await fetch('/api/dashboard/exam-objectives');
        const data = await response.json();
        
        if (response.ok) {
            renderExamObjectives(data.objectives);
            updateExamReadiness(data.overall_exam_readiness);
        } else {
            console.error('Failed to load exam objectives:', data.error);
            document.getElementById('exam-objectives').innerHTML = 
                '<p class="error">Failed to load exam objectives. Please try again.</p>';
        }
    } catch (error) {
        console.error('Error loading exam objectives:', error);
        document.getElementById('exam-objectives').innerHTML = 
            '<p class="error">Error loading exam objectives. Please check your connection.</p>';
    }
}

function renderExamObjectives(objectives) {
    const container = document.getElementById('exam-objectives');
    container.innerHTML = '';
    
    objectives.forEach(objective => {
        const statusIcon = getStatusIcon(objective.status);
        const statusClass = objective.status;
        
        const objectiveElement = document.createElement('div');
        objectiveElement.className = `objective-item ${statusClass}`;
        objectiveElement.innerHTML = `
            <i class="${statusIcon}"></i>
            <div class="objective-content">
                <h4>${objective.title}</h4>
                <p>${objective.description}</p>
                <div class="objective-details">
                    <span class="lesson-count">${objective.completed_lessons}/${objective.total_lessons} lessons completed</span>
                    <span class="weight">Weight: ${objective.weight}%</span>
                </div>
                <div class="objective-progress">
                    <div class="progress-bar" style="width: ${objective.progress}%"></div>
                    <span class="progress-text">${objective.progress}%</span>
                </div>
            </div>
        `;
        container.appendChild(objectiveElement);
    });
}

function getStatusIcon(status) {
    switch (status) {
        case 'completed':
            return 'fas fa-check-circle';
        case 'in-progress':
            return 'fas fa-circle-half-stroke';
        default:
            return 'far fa-circle';
    }
}

function updateExamReadiness(readiness) {
    const percentage = Math.round(readiness);
    document.getElementById('readiness-percentage').textContent = `${percentage}%`;
    
    // Update color based on readiness level
    const scoreCircle = document.querySelector('.score-circle');
    if (percentage >= 80) {
        scoreCircle.style.color = '#4CAF50'; // Green
    } else if (percentage >= 60) {
        scoreCircle.style.color = '#FF9800'; // Orange
    } else {
        scoreCircle.style.color = '#F44336'; // Red
    }
}

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', () => {
    new DashboardManager();
    loadExamObjectives();
});
</script>
<script src="{{ url_for('static', filename='js/dashboard-modern.js') }}"></script>
{% endblock %}

<!--
Profile Edit Form Component
Purpose: User profile editing form with validation and file upload
Usage: {% include 'components/forms/profile-form.html' with context %}

Variables needed:
- form_action: Form submission URL (default: '/profile/update')
- user: User object with current profile data
- form_errors: Dictionary of field errors (optional)
- success_message: Success message to display (optional)
- show_password_change: Whether to show password change section (default: true)
- show_avatar_upload: Whether to show avatar upload (default: true)

Example usage:
{% set form_action = '/profile/update' %}
{% set user = current_user %}
{% set show_password_change = true %}
{% include 'components/forms/profile-form.html' with context %}
-->

<div class="profile-form-container">
    {% if success_message %}
    <div class="alert alert-success mb-4">
        <i class="fas fa-check-circle"></i>
        {{ success_message }}
    </div>
    {% endif %}

    {% if form_errors and form_errors.general %}
    <div class="alert alert-error mb-4">
        <i class="fas fa-exclamation-triangle"></i>
        {{ form_errors.general }}
    </div>
    {% endif %}

    <form method="POST" action="{{ form_action or '/profile/update' }}" enctype="multipart/form-data" class="profile-form">
        <!-- Profile Picture Section -->
        {% if show_avatar_upload|default(true) %}
        <div class="form-section avatar-section">
            <h3 class="section-title">
                <i class="fas fa-user-circle"></i>
                Profile Picture
            </h3>
            
            <div class="avatar-upload-container">
                <div class="current-avatar">
                    <img src="{{ user.avatar_url or '/static/img/default-avatar.png' }}" 
                         alt="Current avatar" 
                         class="avatar-preview"
                         id="avatarPreview">
                </div>
                
                <div class="avatar-upload-controls">
                    <input type="file" 
                           id="avatar" 
                           name="avatar" 
                           accept="image/*"
                           class="file-input"
                           onchange="previewAvatar(this)">
                    <label for="avatar" class="btn btn-secondary btn-sm">
                        <i class="fas fa-camera"></i>
                        Change Photo
                    </label>
                    <p class="upload-help">
                        JPG, PNG or GIF. Max size 2MB.
                    </p>
                </div>
            </div>
            
            {% if form_errors and form_errors.avatar %}
            <div class="form-error">
                <i class="fas fa-exclamation-triangle"></i>
                {{ form_errors.avatar }}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Personal Information Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="fas fa-user"></i>
                Personal Information
            </h3>
            
            <div class="form-row">
                <div class="form-col">
                    <!-- First Name -->
                    {% set input_id = 'first_name' %}
                    {% set input_name = 'first_name' %}
                    {% set input_label = 'First Name' %}
                    {% set input_type = 'text' %}
                    {% set input_value = user.first_name or '' %}
                    {% set input_required = true %}
                    {% set input_error = form_errors.first_name if form_errors %}
                    {% include 'components/forms/form-input.html' %}
                </div>
                
                <div class="form-col">
                    <!-- Last Name -->
                    {% set input_id = 'last_name' %}
                    {% set input_name = 'last_name' %}
                    {% set input_label = 'Last Name' %}
                    {% set input_type = 'text' %}
                    {% set input_value = user.last_name or '' %}
                    {% set input_required = true %}
                    {% set input_error = form_errors.last_name if form_errors %}
                    {% include 'components/forms/form-input.html' %}
                </div>
            </div>

            <!-- Email -->
            {% set input_id = 'email' %}
            {% set input_name = 'email' %}
            {% set input_label = 'Email Address' %}
            {% set input_type = 'email' %}
            {% set input_value = user.email or '' %}
            {% set input_required = true %}
            {% set input_error = form_errors.email if form_errors %}
            {% set input_help = 'Used for login and important notifications' %}
            {% include 'components/forms/form-input.html' %}

            <!-- Bio/About -->
            <div class="form-group">
                <label for="bio" class="form-label">About Me</label>
                <textarea 
                    id="bio" 
                    name="bio" 
                    class="form-control textarea"
                    placeholder="Tell us a bit about yourself and your coding journey..."
                    rows="4">{{ user.bio or '' }}</textarea>
                <div class="form-help">
                    <i class="fas fa-info-circle"></i>
                    This will appear on your public profile (optional)
                </div>
            </div>

            <!-- Learning Goals -->
            <div class="form-group">
                <label for="learning_goals" class="form-label">Learning Goals</label>
                <textarea 
                    id="learning_goals" 
                    name="learning_goals" 
                    class="form-control textarea"
                    placeholder="What do you want to achieve with Python?"
                    rows="3">{{ user.learning_goals or '' }}</textarea>
                <div class="form-help">
                    <i class="fas fa-info-circle"></i>
                    Help us personalize your learning experience (optional)
                </div>
            </div>
        </div>

        <!-- Account Settings Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="fas fa-cog"></i>
                Account Settings
            </h3>

            <!-- Notification Preferences -->
            <div class="form-group">
                <label class="form-label">Email Notifications</label>
                
                <div class="checkbox-group">
                    <label class="checkbox-container">
                        <input type="checkbox" 
                               name="notifications_lessons" 
                               {% if user.notifications_lessons %}checked{% endif %}>
                        <span class="checkmark"></span>
                        <span class="checkbox-label">New lessons and course updates</span>
                    </label>
                    
                    <label class="checkbox-container">
                        <input type="checkbox" 
                               name="notifications_achievements" 
                               {% if user.notifications_achievements %}checked{% endif %}>
                        <span class="checkmark"></span>
                        <span class="checkbox-label">Achievement badges and progress milestones</span>
                    </label>
                    
                    <label class="checkbox-container">
                        <input type="checkbox" 
                               name="notifications_reminders" 
                               {% if user.notifications_reminders %}checked{% endif %}>
                        <span class="checkmark"></span>
                        <span class="checkbox-label">Learning reminders and streak notifications</span>
                    </label>
                </div>
            </div>

            <!-- Privacy Settings -->
            <div class="form-group">
                <label class="checkbox-container">
                    <input type="checkbox" 
                           name="profile_public" 
                           {% if user.profile_public %}checked{% endif %}>
                    <span class="checkmark"></span>
                    <span class="checkbox-label">Make my profile visible to other learners</span>
                </label>
            </div>
        </div>

        {% if show_password_change|default(true) %}
        <!-- Password Change Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="fas fa-lock"></i>
                Change Password
            </h3>
            
            <p class="section-description">
                Leave blank to keep your current password
            </p>

            <!-- Current Password -->
            {% set input_id = 'current_password' %}
            {% set input_name = 'current_password' %}
            {% set input_label = 'Current Password' %}
            {% set input_type = 'password' %}
            {% set input_placeholder = 'Enter current password' %}
            {% set input_error = form_errors.current_password if form_errors %}
            {% include 'components/forms/form-input.html' %}

            <!-- New Password -->
            {% set input_id = 'new_password' %}
            {% set input_name = 'new_password' %}
            {% set input_label = 'New Password' %}
            {% set input_type = 'password' %}
            {% set input_placeholder = 'Enter new password' %}
            {% set input_error = form_errors.new_password if form_errors %}
            {% set input_help = 'Must be at least 8 characters' %}
            {% include 'components/forms/form-input.html' %}

            <!-- Confirm New Password -->
            {% set input_id = 'confirm_new_password' %}
            {% set input_name = 'confirm_new_password' %}
            {% set input_label = 'Confirm New Password' %}
            {% set input_type = 'password' %}
            {% set input_placeholder = 'Confirm new password' %}
            {% set input_error = form_errors.confirm_new_password if form_errors %}
            {% include 'components/forms/form-input.html' %}
        </div>
        {% endif %}

        <!-- Form Actions -->
        <div class="form-actions">
            {% set button_text = 'Save Changes' %}
            {% set button_type = 'submit' %}
            {% set button_variant = 'primary' %}
            {% set button_size = 'lg' %}
            {% set button_icon = 'fas fa-save' %}
            {% include 'components/forms/form-button.html' %}
            
            <button type="button" class="btn btn-secondary btn-lg" onclick="resetForm()">
                <i class="fas fa-undo"></i>
                <span class="button-text">Reset</span>
            </button>
        </div>
    </form>
</div>

<script>
function previewAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarPreview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function resetForm() {
    if (confirm('Are you sure you want to reset all changes?')) {
        document.querySelector('.profile-form').reset();
        // Reset avatar preview to original
        const originalSrc = "{{ user.avatar_url or '/static/img/default-avatar.png' }}";
        document.getElementById('avatarPreview').src = originalSrc;
    }
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.profile-form');
    const newPasswordInput = document.getElementById('new_password');
    const confirmNewPasswordInput = document.getElementById('confirm_new_password');
    const currentPasswordInput = document.getElementById('current_password');
    
    // Password change validation
    if (newPasswordInput || confirmNewPasswordInput) {
        [newPasswordInput, confirmNewPasswordInput, currentPasswordInput].forEach(input => {
            if (input) {
                input.addEventListener('input', validatePasswordChange);
            }
        });
    }
    
    function validatePasswordChange() {
        const newPassword = newPasswordInput?.value || '';
        const confirmPassword = confirmNewPasswordInput?.value || '';
        const currentPassword = currentPasswordInput?.value || '';
        
        // If any password field has content, require current password
        if ((newPassword || confirmPassword) && !currentPassword) {
            currentPasswordInput?.setCustomValidity('Current password is required to change password');
        } else {
            currentPasswordInput?.setCustomValidity('');
        }
        
        // Validate password confirmation
        if (newPassword && confirmPassword && newPassword !== confirmPassword) {
            confirmNewPasswordInput?.setCustomValidity('Passwords do not match');
        } else {
            confirmNewPasswordInput?.setCustomValidity('');
        }
    }
});
</script>

<style>
.profile-form-container {
    max-width: 600px;
    margin: 0 auto;
}

.form-section {
    background: var(--card-bg);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
}

.section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 0 1.5rem 0;
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
}

.section-description {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
}

.avatar-section {
    text-align: center;
}

.avatar-upload-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.avatar-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid var(--border-color);
    transition: border-color 0.2s ease;
}

.avatar-upload-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.file-input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

.upload-help {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin: 0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-col {
    min-width: 0;
}

.textarea {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.checkbox-container {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    user-select: none;
    line-height: 1.4;
}

.checkbox-container input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.checkmark {
    height: 18px;
    width: 18px;
    background-color: var(--input-bg);
    border: 2px solid var(--border-color);
    border-radius: 3px;
    margin-right: 0.75rem;
    margin-top: 2px;
    flex-shrink: 0;
    position: relative;
    transition: all 0.2s ease;
}

.checkbox-container:hover .checkmark {
    border-color: var(--primary-color);
}

.checkbox-container input:checked ~ .checkmark {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 5px;
    top: 1px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.checkbox-container input:checked ~ .checkmark:after {
    display: block;
}

.checkbox-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    padding: 2rem 0;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions .btn {
        width: 100%;
    }
}
</style>

{% extends "base.html" %}
{% from "macros/lesson.html" import tab_button, code_block, back_link, progress_bar %}

{% block title %}{{ lesson.title if lesson else "Lesson" }} - Code with Morais{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/lesson.css') }}">
{% endblock %}

{% block content %}
<div class="lesson-container">
    <!-- üéØ LESSON HEADER SECTION -->
    <header class="lesson-header">
        {% include 'components/lesson/back-link.html' %}
        
        <div class="lesson-header-content">
            <div class="lesson-meta">
                <h1 class="lesson-title">
                    <i class="fas fa-{{ lesson.icon or 'code' }}"></i>
                    {{ lesson.title }}
                </h1>
                <div class="lesson-badges">
                    <span class="difficulty-badge {{ lesson.difficulty or 'beginner' }}">
                        {{ (lesson.difficulty or 'beginner')|title }}
                    </span>
                    <span class="time-badge">
                        <i class="fas fa-clock"></i> {{ lesson.estimated_time or 30 }}min
                    </span>
                    <span class="xp-badge">
                        <i class="fas fa-star"></i> {{ lesson.xp_reward or 100 }} XP
                    </span>
                    {% if lesson.coin_reward %}
                    <span class="coin-badge">
                        <i class="fas fa-coins"></i> {{ lesson.coin_reward }} ü™ô
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- üìä PROGRESS BAR SECTION -->
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-text">Progress</span>
                    <span class="progress-percentage" id="progress-percentage">{{ lesson_progress.progress or 0 }}%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="lesson-progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: {{ lesson_progress.progress or 0 }}%"></div>
                    </div>
                </div>
                <div class="progress-stats">
                    <span class="completed-blocks" id="completed-blocks-text">
                        {{ lesson_progress.completed_blocks|length or 0 }} of {{ lesson.blocks|length or 0 }} blocks completed
                    </span>
                    <span class="earned-rewards" id="earned-rewards">
                        {% if lesson_progress.xp_earned %}+{{ lesson_progress.xp_earned }} XP{% endif %}
                        {% if lesson_progress.coins_earned %}+{{ lesson_progress.coins_earned }} ü™ô{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- üóÇÔ∏è SUBTOPIC NAVIGATION (conditional) -->
    {% if lesson.subtopics %}
    <nav class="subtopic-navigation" role="tablist">
        <div class="subtopic-tabs">
            {% for subtopic in lesson.subtopics %}
            <button class="subtopic-tab {{ 'active' if loop.first else '' }}" 
                    data-subtopic="{{ subtopic.id }}"
                    role="tab"
                    aria-selected="{{ 'true' if loop.first else 'false' }}"
                    tabindex="{{ '0' if loop.first else '-1' }}"
                    onclick="switchSubtopic({{ loop.index0 }})">
                <i class="fas fa-{{ subtopic.icon or 'book' }}"></i>
                <span class="tab-title">{{ subtopic.title }}</span>
                <i class="fas fa-check-circle tab-check {{ 'completed' if subtopic.id in lesson_progress.completed_subtopics else '' }}"></i>
            </button>
            {% endfor %}
        </div>
    </nav>
    {% endif %}

    <!-- üìö MAIN CONTENT AREA -->
    <main class="lesson-content-wrapper">
        
        <!-- Loading Skeleton -->
        <div id="content-loading" class="content-loading">
            {% set component_type = 'lesson-content' %}
            {% include 'components/common/skeleton-loader.html' %}
        </div>
        
        <!-- Dynamic Content Container -->
        <div id="lesson-content" class="lesson-content" style="display: none;">
            <!-- Content blocks will be dynamically rendered here by JavaScript -->
            <div id="lesson-content-container" class="content-blocks-container">
                <!-- Placeholder for dynamic content blocks -->
            </div>
        </div>
        
        <!-- Emergency Fallback Content -->
        <div id="fallback-content" class="fallback-content" style="display: none;">
            <div class="alert alert-warning">
                <h4>üì∂ Connection Issue</h4>
                <p>Having trouble loading the lesson? We've saved your progress locally.</p>
                <button onclick="retryLoadContent()" class="btn btn-primary">
                    <i class="fas fa-refresh"></i> Try Again
                </button>
            </div>
        </div>
        
    </main>

    <!-- üéØ LESSON NAVIGATION FOOTER -->
    <footer class="lesson-navigation">
        <div class="nav-buttons">
            {% if prev_lesson %}
            <a href="{{ url_for('lesson.lesson', lesson_id=prev_lesson.id) }}" 
               class="nav-btn prev-btn">
                <i class="fas fa-arrow-left"></i>
                <span class="nav-text">
                    <small>Previous</small>
                    <strong>{{ prev_lesson.title|truncate(30) }}</strong>
                </span>
            </a>
            {% endif %}
            
            <div class="nav-center">
                <button id="lesson-menu-btn" class="lesson-menu-btn" onclick="toggleLessonMenu()">
                    <i class="fas fa-list"></i>
                    <span>Lesson Menu</span>
                </button>
            </div>
            
            {% if next_lesson %}
            <a href="{{ url_for('lesson.lesson', lesson_id=next_lesson.id) }}" 
               class="nav-btn next-btn" 
               id="next-lesson-btn">
                <span class="nav-text">
                    <small>Next</small>
                    <strong>{{ next_lesson.title|truncate(30) }}</strong>
                </span>
                <i class="fas fa-arrow-right"></i>
            </a>
            {% endif %}
        </div>
    </footer>

</div>

<!-- üéâ CELEBRATION MODALS -->
<div id="celebration-container"></div>

<!-- üí° HELP MODAL -->
<div id="help-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí° Need Help?</h3>
            <button class="modal-close" onclick="closeHelpModal()">&times;</button>
        </div>
        <div class="modal-body" id="help-content">
            <!-- Dynamic help content -->
        </div>
    </div>
</div>

<!-- üìã LESSON MENU SIDEBAR -->
<div id="lesson-menu-sidebar" class="lesson-menu-sidebar">
    <div class="sidebar-header">
        <h3>üìö Lesson Progress</h3>
        <button onclick="toggleLessonMenu()" class="sidebar-close">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="sidebar-content">
        <!-- Dynamic lesson menu content -->
    </div>
</div>
<!-- JavaScript for Dynamic Content Rendering -->
<script>
// Lesson data from backend (Firebase integration)
window.lessonData = {{ lesson | tojson | safe }};
window.lessonProgress = {{ lesson_progress | tojson | safe }};
window.currentUser = {{ user | tojson | safe }};

// Initialize lesson page with Firebase testing
document.addEventListener('DOMContentLoaded', function() {
    initializeLessonPage();
});

function initializeLessonPage() {
    console.log('üöÄ Initializing lesson page with Firebase integration testing...');
    
    // Test Firebase data structure and integration
    testFirebaseIntegration();
    
    // Hide loading skeleton and show content
    document.getElementById('content-loading').style.display = 'none';
    document.getElementById('lesson-content').style.display = 'block';
    
    // Load lesson content based on Firebase data structure
    if (window.lessonData && window.lessonData.blocks) {
        console.log('‚úÖ Using Firebase lesson blocks structure');
        renderLessonBlocks(window.lessonData.blocks);
    } else if (lessonData && lessonData.content) {
        // Fallback for old content structure
        renderLegacyContent(lessonData.content);
    } else {
        showFallbackContent();
    }
    
    // Initialize progress tracking
    updateProgressDisplay();
}

function renderLessonBlocks(blocks) {
    const container = document.getElementById('lesson-content-container');
    container.innerHTML = '';
    
    blocks.forEach((block, index) => {
        const blockElement = createBlockElement(block, index);
        container.appendChild(blockElement);
    });
    
    // Initialize any interactive elements
    initializeInteractiveElements();
}

function createBlockElement(block, index) {
    const article = document.createElement('article');
    article.className = `content-block ${block.type}-block`;
    article.id = `block-${block.id || index}`;
    article.dataset.blockId = block.id || index;
    article.dataset.blockType = block.type;
    
    // Add completion status
    const isCompleted = lessonProgress.completed_blocks && 
                       lessonProgress.completed_blocks.includes(block.id);
    if (isCompleted) {
        article.classList.add('completed');
    }
    
    // Render based on block type
    switch(block.type) {
        case 'text':
            article.innerHTML = createTextBlockHTML(block);
            break;
        case 'code_example':
            article.innerHTML = createCodeExampleHTML(block);
            break;
        case 'interactive':
            article.innerHTML = createInteractiveBlockHTML(block);
            break;
        case 'quiz':
            article.innerHTML = createQuizBlockHTML(block);
            break;
        default:
            article.innerHTML = createDefaultBlockHTML(block);
    }
    
    return article;
}

function createTextBlockHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-book-open"></i>
            </div>
            <div class="block-meta">
                <span class="block-type">Reading</span>
                <span class="block-progress-indicator" id="progress-${block.id}">
                    <i class="fas fa-circle"></i>
                </span>
            </div>
        </div>
        
        <div class="block-content">
            <div class="text-content">
                ${block.content || ''}
            </div>
            
            ${block.key_points ? `
            <div class="key-points">
                <h4>üîë Key Points:</h4>
                <ul>
                    ${block.key_points.map(point => `<li>${point}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
        </div>
        
        <div class="block-actions">
            <button onclick="markBlockComplete('${block.id}')" 
                    class="btn btn-success complete-btn">
                <i class="fas fa-check"></i> Mark as Read
            </button>
        </div>
    `;
}

function createCodeExampleHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-code"></i>
            </div>
            <div class="code-meta">
                <span class="language-badge">${(block.language || 'python').toUpperCase()}</span>
                <button class="btn-copy" onclick="copyCodeBlock('${block.id}')">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
        </div>
        
        <div class="code-container">
            <div class="code-header">
                <span class="code-title">${block.title || 'Example Code'}</span>
            </div>
            
            <pre class="code-content" id="code-${block.id}"><code class="language-${block.language || 'python'}">${block.code || ''}</code></pre>
            
            ${block.explanation ? `
            <div class="code-explanation">
                <h5>üí° Explanation:</h5>
                <p>${block.explanation}</p>
            </div>
            ` : ''}
        </div>
    `;
}

function createInteractiveBlockHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-laptop-code"></i>
            </div>
            <div class="challenge-meta">
                <span class="challenge-type">${block.challenge_type || 'Code Challenge'}</span>
                <span class="difficulty">${block.difficulty || 'Beginner'}</span>
            </div>
        </div>
        
        <div class="challenge-content">
            <div class="challenge-instructions">
                <h4>üéØ Your Challenge:</h4>
                <p>${block.instructions || ''}</p>
                
                ${block.requirements ? `
                <div class="requirements">
                    <h5>üìã Requirements:</h5>
                    <ul>
                        ${block.requirements.map(req => `<li>${req}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            </div>
            
            <div class="code-editor-wrapper">
                <div class="editor-toolbar">
                    <span class="editor-label">${block.language || 'Python'} Editor</span>
                    <div class="editor-actions">
                        <button onclick="getHint('${block.id}')" class="btn btn-sm btn-hint">
                            <i class="fas fa-lightbulb"></i> Hint (5 ü™ô)
                        </button>
                        <button onclick="resetCode('${block.id}')" class="btn btn-sm btn-reset">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div id="editor-${block.id}" class="code-editor">${block.starter_code || ''}</div>
                
                <div class="editor-footer">
                    <button onclick="runInteractiveCode('${block.id}')" 
                            class="btn btn-primary run-btn">
                        <i class="fas fa-play"></i> Run Code
                    </button>
                    <button onclick="showSolution('${block.id}')" 
                            class="btn btn-outline solution-btn">
                        <i class="fas fa-eye"></i> Show Solution
                    </button>
                </div>
            </div>
            
            <div class="output-section">
                <div class="output-header">
                    <i class="fas fa-terminal"></i> Output & Results
                </div>
                <div id="output-${block.id}" class="ide-output"></div>
                
                ${block.tests ? `
                <div class="test-results" id="tests-${block.id}">
                    <h5>üß™ Test Results:</h5>
                    <div class="test-list">
                        <!-- Test results will be populated here -->
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

function createQuizBlockHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-brain"></i>
            </div>
            <div class="quiz-meta">
                <span class="quiz-type">Knowledge Check</span>
            </div>
        </div>
        
        <div class="quiz-content">
            <div class="quiz-intro">
                <h4>üß† Test Your Understanding</h4>
                <p>${block.description || 'Complete this quiz to test your knowledge.'}</p>
            </div>
            
            <div id="quiz-${block.quiz_id || block.id}" data-quiz-id="${block.quiz_id || block.id}">
                <div class="spinner">Loading quiz...</div>
            </div>
        </div>
    `;
}

function createDefaultBlockHTML(block) {
    return `
        <div class="block-header">
            <div class="block-icon">
                <i class="fas fa-question"></i>
            </div>
            <div class="block-meta">
                <span class="block-type">Unknown Block Type: ${block.type}</span>
            </div>
        </div>
        
        <div class="block-content">
            <p>This block type (${block.type}) is not yet supported.</p>
            <pre>${JSON.stringify(block, null, 2)}</pre>
        </div>
    `;
}

// Fallback for legacy content structure
function renderLegacyContent(content) {
    const container = document.getElementById('lesson-content-container');
    container.innerHTML = '';
    
    content.forEach((contentBlock, index) => {
        const blockElement = document.createElement('div');
        blockElement.className = `content-block ${contentBlock.type}-block`;
        
        if (contentBlock.type === 'text') {
            blockElement.innerHTML = `<div class="text-content">${contentBlock.content}</div>`;
        } else if (contentBlock.type === 'code_example') {
            blockElement.innerHTML = `
                <div class="code-header">
                    <span>Example Code</span>
                    <button class="btn btn-sm" onclick="copyCode(this)">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <pre><code class="language-${contentBlock.language}">${contentBlock.code}</code></pre>
            `;
        }
        // Add more legacy content types as needed
        
        container.appendChild(blockElement);
    });
}

function showFallbackContent() {
    document.getElementById('lesson-content').style.display = 'none';
    document.getElementById('fallback-content').style.display = 'block';
}

function retryLoadContent() {
    document.getElementById('fallback-content').style.display = 'none';
    document.getElementById('content-loading').style.display = 'block';
    setTimeout(() => {
        initializeLessonPage();
    }, 1000);
}

// Interactive functions
function markBlockComplete(blockId) {
    console.log('Marking block complete:', blockId);
    
    // Update local progress
    if (!lessonProgress.completed_blocks) {
        lessonProgress.completed_blocks = [];
    }
    
    if (!lessonProgress.completed_blocks.includes(blockId)) {
        lessonProgress.completed_blocks.push(blockId);
        
        // Update UI
        const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
        if (blockElement) {
            blockElement.classList.add('completed');
        }
        
        // Update progress
        updateProgressDisplay();
        
        // Show completion animation
        showBlockCompletionAnimation(blockId);
        
        // Sync with Firebase (if user is logged in)
        if (currentUser) {
            syncProgressToFirebase();
        }
    }
}

function updateProgressDisplay() {
    const totalBlocks = lessonData.blocks ? lessonData.blocks.length : 0;
    const completedBlocks = lessonProgress.completed_blocks ? lessonProgress.completed_blocks.length : 0;
    const progress = totalBlocks > 0 ? Math.round((completedBlocks / totalBlocks) * 100) : 0;
    
    // Update progress bar
    document.getElementById('progress-percentage').textContent = progress + '%';
    document.getElementById('progress-fill').style.width = progress + '%';
    document.getElementById('completed-blocks-text').textContent = 
        `${completedBlocks} of ${totalBlocks} blocks completed`;
    
    // Update lesson progress
    lessonProgress.progress = progress;
    
    // Check for milestones
    if (progress === 25 || progress === 50 || progress === 75 || progress === 100) {
        showMilestoneAnimation(progress);
    }
}

function showBlockCompletionAnimation(blockId) {
    // Simple completion animation
    const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
    if (blockElement) {
        blockElement.style.transform = 'scale(1.02)';
        blockElement.style.boxShadow = '0 4px 20px rgba(74, 144, 226, 0.3)';
        setTimeout(() => {
            blockElement.style.transform = '';
            blockElement.style.boxShadow = '';
        }, 300);
    }
}

function showMilestoneAnimation(progress) {
    const messages = {
        25: "üéØ Great start!",
        50: "üî• Halfway there!",
        75: "‚≠ê Almost done!",
        100: "üéâ Lesson mastered!"
    };
    
    const message = messages[progress];
    if (message) {
        console.log('Milestone reached:', message);
        // Add visual celebration here
    }
}

function syncProgressToFirebase() {
    if (!currentUser || !lessonData.id) return;
    
    fetch('/api/lesson/progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            lesson_id: lessonData.id,
            progress: lessonProgress
        })
    }).catch(error => {
        console.error('Failed to sync progress:', error);
    });
}

function copyCodeBlock(blockId) {
    const codeElement = document.getElementById(`code-${blockId}`);
    if (codeElement) {
        const text = codeElement.textContent;
        navigator.clipboard.writeText(text).then(() => {
            console.log('Code copied to clipboard');
            // Show feedback
        });
    }
}

function initializeInteractiveElements() {
    // Initialize ACE editors for interactive blocks
    document.querySelectorAll('.code-editor').forEach(editor => {
        if (editor.id.startsWith('editor-')) {
            initializeAceEditor(editor.id);
        }
    });
    
    // Initialize quiz systems
    document.querySelectorAll('[data-quiz-id]').forEach(quizElement => {
        const quizId = quizElement.dataset.quizId;
        if (window.QuizSystem) {
            new QuizSystem(quizElement, quizId);
        }
    });
}

function initializeAceEditor(editorId) {
    if (typeof ace !== 'undefined') {
        const editor = ace.edit(editorId);
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");
        editor.setOptions({
            enableBasicAutocompletion: true,
            enableLiveAutocompletion: true,
            fontSize: 14,
            showPrintMargin: false
        });
        return editor;
    }
}

/**
 * Test Firebase integration and lesson data structure
 * This function validates the lesson data and Firebase connectivity
 */
function testFirebaseIntegration() {
    console.log('üî• Testing Firebase integration and lesson data structure...');
    
    try {
        // Test 1: Validate lesson data structure
        console.log('üìä Lesson Data Structure Test:');
        if (window.lessonData) {
            console.log('‚úÖ Lesson data available:', window.lessonData);
            
            // Check required fields
            const requiredFields = ['id', 'title', 'difficulty', 'estimated_time', 'xp_reward'];
            const missingFields = requiredFields.filter(field => !window.lessonData[field]);
            
            if (missingFields.length === 0) {
                console.log('‚úÖ All required lesson fields present');
            } else {
                console.warn('‚ö†Ô∏è Missing required fields:', missingFields);
            }
            
            // Test blocks structure (Firebase lesson format)
            if (window.lessonData.blocks && Array.isArray(window.lessonData.blocks)) {
                console.log(`‚úÖ Firebase blocks structure found: ${window.lessonData.blocks.length} blocks`);
                
                // Validate each block
                window.lessonData.blocks.forEach((block, index) => {
                    const blockRequired = ['id', 'type', 'order'];
                    const blockMissing = blockRequired.filter(field => !block[field]);
                    
                    if (blockMissing.length === 0) {
                        console.log(`  ‚úÖ Block ${index + 1}: ${block.type} - ${block.title || block.id}`);
                    } else {
                        console.warn(`  ‚ö†Ô∏è Block ${index + 1} missing:`, blockMissing);
                    }
                });
            } else {
                console.log('‚ÑπÔ∏è No Firebase blocks found, checking legacy content structure...');
                if (window.lessonData.content) {
                    console.log('‚úÖ Legacy content structure detected');
                } else {
                    console.warn('‚ö†Ô∏è No content structure found');
                }
            }
        } else {
            console.error('‚ùå No lesson data available');
        }
        
        // Test 2: User progress structure
        console.log('üìà User Progress Test:');
        if (window.lessonProgress && typeof window.lessonProgress === 'object') {
            console.log('‚úÖ User progress data available:', window.lessonProgress);
            
            const progressFields = ['completed_blocks', 'progress', 'current_block'];
            progressFields.forEach(field => {
                if (window.lessonProgress[field] !== undefined) {
                    console.log(`  ‚úÖ ${field}: ${window.lessonProgress[field]}`);
                } else {
                    console.log(`  ‚ÑπÔ∏è ${field}: not set (new lesson)`);
                }
            });
        } else {
            console.log('‚ÑπÔ∏è No user progress data (new user or lesson)');
        }
        
        // Test 3: Firebase service availability
        console.log('üîß Firebase Service Test:');
        if (window.firebase && window.firebase.apps && window.firebase.apps.length > 0) {
            console.log('‚úÖ Firebase SDK initialized');
            
            // Check if Firestore is available
            if (window.firebase.firestore) {
                console.log('‚úÖ Firestore service available');
            } else {
                console.log('‚ÑπÔ∏è Firestore service not detected');
            }
        } else {
            console.log('‚ÑπÔ∏è Firebase SDK not loaded (using server-side Firebase)');
        }
        
        // Test 4: Integration with existing systems
        console.log('üîó System Integration Test:');
        
        // Check ACE editor availability (for code blocks)
        if (window.ace) {
            console.log('‚úÖ ACE editor available for code blocks');
        } else {
            console.log('‚ÑπÔ∏è ACE editor not loaded');
        }
        
        // Check QuizSystem availability
        if (window.QuizSystem) {
            console.log('‚úÖ QuizSystem available for quiz blocks');
        } else {
            console.log('‚ÑπÔ∏è QuizSystem not loaded');
        }
        
        // Test 5: Page elements and containers
        console.log('üèóÔ∏è Page Structure Test:');
        const requiredElements = [
            'lesson-content',
            'lesson-progress-bar', 
            'progress-fill',
            'progress-percentage'
        ];
        
        requiredElements.forEach(elementId => {
            const element = document.getElementById(elementId);
            if (element) {
                console.log(`  ‚úÖ ${elementId} container found`);
            } else {
                console.warn(`  ‚ö†Ô∏è ${elementId} container missing`);
            }
        });
        
        console.log('üéØ Firebase integration test completed successfully');
        return true;
        
    } catch (error) {
        console.error('‚ùå Firebase integration test failed:', error);
        return false;
    }
}
</script>

<!-- üöÄ Lesson Template System Scripts - Optimized -->
<!-- Core lesson system (consolidated from lesson-manager.js, content-renderer.js, lesson-integration.js) -->
<script src="{{ url_for('static', filename='js/lesson-core.js') }}"></script>

<!-- Supporting lesson components -->
<script src="{{ url_for('static', filename='js/components/quiz.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/gamification-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/progress-tracker.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/interactive-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/xp-animation.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/lesson-test-suite.js') }}"></script>

<script>
// Pass server data to JavaScript
window.lessonData = {{ lesson|tojson if lesson else '{}' }};
window.lessonProgress = {{ lesson_progress|tojson if lesson_progress else '{}' }};
window.currentUser = {{ user|tojson if user else '{}' }};
window.lessonId = '{{ lesson.id if lesson else '' }}';

console.log('üìö Lesson data loaded:', window.lessonData);
console.log('üìä Progress data loaded:', window.lessonProgress);

// Initialize lesson integration when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    if (window.lessonId && window.initializeLessonIntegration) {
        console.log('üöÄ Initializing comprehensive lesson system...');
        window.initializeLessonIntegration(window.lessonId);
    } else {
        console.log('‚ö†Ô∏è Legacy lesson mode - some features may be limited');
        // Fallback to existing lesson manager
        if (window.LessonPageManager) {
            new LessonPageManager().init();
        }
    }
});
</script>

<style>
/* Additional inline styles for lesson page specific adjustments */
.lesson-container {
    line-height: 1.8;
}

.text-block h1, .text-block h2, .text-block h3 {
    color: var(--primary-color);
    margin: 1rem 0;
}

.code-example {
    background-color: var(--bg-secondary);
}

.code-header {
    background-color: var(--bg-primary);
    margin: -2rem -2rem 1rem -2rem;
    padding: 1rem 2rem;
    border-radius: 12px 12px 0 0;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-copy {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    transition: color 0.3s ease;
}

.btn-copy:hover {
    color: var(--primary-color);
}

.code-example pre {
    background-color: transparent;
    margin: 0;
    padding: 0;
    overflow-x: auto;
}

.code-example code {
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 14px;
    line-height: 1.5;
}

.interactive-challenge h3 {
    color: var(--secondary-color);
    margin-bottom: 1rem;
}

.code-output {
    margin-top: 1rem;
    padding: 1rem;
    background-color: var(--bg-secondary);
    border-radius: 8px;
    min-height: 50px;
    font-family: monospace;
}

.output-success {
    color: var(--success-color);
}

.output-success .rewards {
    background-color: var(--success-color);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    text-align: center;
}

.error {
    color: var(--danger-color);
}

.quiz-block h3 {
    color: var(--warning-color);
    margin-bottom: 1rem;
}

.quiz-start {
    text-align: center;
    padding: 2rem;
}

.lesson-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
}

#complete-subtopic-btn {
    background-color: var(--success-color);
}

#complete-subtopic-btn:hover {
    background-color: #45a049;
}

#complete-subtopic-btn:disabled {
    background-color: var(--text-secondary);
    cursor: not-allowed;
}

@media (max-width: 768px) {
    .lesson-navigation {
        flex-direction: column;
        gap: 1rem;
    }
    
    .lesson-navigation button {
        width: 100%;
    }
    
    .code-editor-header {
        flex-direction: column;
        gap: 1rem;
    }
}
</style>

<script>
// Current subtopic tracking
let currentSubtopicIndex = 0;
let subtopics = {{ lesson.subtopics | tojson }};
let completedSubtopics = {{ lesson_progress.completed_subtopics | default([]) | tojson }};

// Initialize ACE Editor when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('editor')) {
        initializeEditor('editor');
    }
    updateCompleteButton();
});

function switchLessonTab(subtopicId) {
    // Update active tab
    document.querySelectorAll('.lesson-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-subtopic-id') === subtopicId) {
            tab.classList.add('active');
            currentSubtopicIndex = subtopics.findIndex(s => s.id === subtopicId);
        }
    });
    
    // Update content (in a real app, this would load subtopic-specific content)
    updateCompleteButton();
}

function updateCompleteButton() {
    const currentSubtopic = subtopics[currentSubtopicIndex];
    const btn = document.getElementById('complete-subtopic-btn');
    
    if (completedSubtopics.includes(currentSubtopic.id)) {
        btn.textContent = 'Œì¬£√¥ Completed';
        btn.disabled = true;
    } else {
        btn.textContent = 'Mark as Complete';
        btn.disabled = false;
    }
}

async function completeCurrentSubtopic() {
    const currentSubtopic = subtopics[currentSubtopicIndex];
    
    try {
        const response = await fetch('/api/lesson/complete-subtopic', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lesson_id: '{{ lesson.id }}',
                subtopic_id: currentSubtopic.id
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update UI
            completedSubtopics.push(currentSubtopic.id);
            
            // Update progress bar
            document.getElementById('progress-percentage').textContent = result.new_progress + '%';
            document.getElementById('lesson-progress-fill').style.width = result.new_progress + '%';
            
            // Update tab check mark
            const tab = document.querySelector(`[data-subtopic-id="${currentSubtopic.id}"]`);
            const checkIcon = tab.querySelector('.tab-check');
            checkIcon.classList.add('completed');
            
            // Update button
            updateCompleteButton();
            
            // Show reward notification
            showNotification(`Subtopic completed! +${result.xp_earned} XP earned! ‚â°∆í√Ñ√´`);
            
            if (result.lesson_completed) {
                setTimeout(() => {
                    showNotification('Lesson completed! Great job! ‚â°∆í√Ö√•');
                }, 1000);
            }
        }
    } catch (error) {
        console.error('Error completing subtopic:', error);
        showNotification('Error saving progress. Please try again.', 'error');
    }
}

function previousSubtopic() {
    if (currentSubtopicIndex > 0) {
        const prevSubtopic = subtopics[currentSubtopicIndex - 1];
        switchLessonTab(prevSubtopic.id);
    }
}

function nextSubtopic() {
    if (currentSubtopicIndex < subtopics.length - 1) {
        const nextSubtopic = subtopics[currentSubtopicIndex + 1];
        switchLessonTab(nextSubtopic.id);
    }
}

function copyCode(button) {
    const codeBlock = button.closest('.code-example').querySelector('code');
    const text = codeBlock.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 2000);
    });
}
</script>

<script>
// Initialize lesson after DOM loaded
// This script continues from the previous script block
// Data is already loaded in previous script sections
// Additional lesson functionality continues here
if (typeof initializeLesson === 'function') {
    initializeLesson();
}
let quizStates = {};

// Initialize lesson
document.addEventListener('DOMContentLoaded', function() {
    initializeLesson();
});

function initializeLesson() {
    // Load saved progress
    const savedProgress = localStorage.getItem(`lesson_${lessonData.id}_progress`);
    if (savedProgress) {
        lessonProgress = JSON.parse(savedProgress);
    }
    
    // Render first subtopic or all content if no subtopics
    if (lessonData.subtopics && lessonData.subtopics.length > 0) {
        renderSubtopic(0);
    } else {
        renderLessonContent(lessonData.blocks || lessonData.content);
    }
    
    updateProgressBar();
}

function renderSubtopic(index) {
    currentSubtopic = index;
    const container = document.getElementById('lesson-content-container');
    
    // Update tab active state
    document.querySelectorAll('.subtopic-tab').forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
    });
    
    // Clear container
    container.innerHTML = '';
    
    // Get blocks for this subtopic
    const subtopicBlocks = lessonData.blocks.filter(block => 
        block.subtopic_index === index || (!block.subtopic_index && index === 0)
    );
    
    renderLessonContent(subtopicBlocks);
    updateNavigationButtons();
}

function renderLessonContent(blocks) {
    const container = document.getElementById('lesson-content-container');
    container.innerHTML = '';
    
    blocks.forEach((block, index) => {
        const blockElement = createBlockElement(block, index);
        if (blockElement) {
            container.appendChild(blockElement);
        }
    });
    
    // Initialize ACE editors after rendering
    setTimeout(() => {
        Object.keys(editors).forEach(id => {
            const editorInfo = editors[id];
            initializeAceEditor(id, editorInfo.options);
            if (editorInfo.code) {
                ace.edit(id).setValue(editorInfo.code, -1);
            }
        });
    }, 100);
}

function createBlockElement(block, index) {
    const div = document.createElement('div');
    div.className = 'content-block';
    div.id = `block-${index}`;
    
    switch(block.type) {
        case 'text':
            div.innerHTML = `<div class="text-block">${block.content}</div>`;
            break;
            
        case 'code_snippet':
            div.innerHTML = createCodeSnippetBlock(block);
            break;
            
        case 'ide':
            div.innerHTML = createIDEBlock(block);
            break;
            
        case 'quiz':
            div.innerHTML = createQuizBlock(block);
            break;
            
        case 'debug_challenge':
            div.innerHTML = createDebugBlock(block);
            break;
            
        case 'divider':
            div.innerHTML = `<div class="${block.style || 'topic-divider'}"></div>`;
            break;
            
        default:
            console.warn('Unknown block type:', block.type);
            return null;
    }
    
    return div;
}

function createCodeSnippetBlock(block) {
    const editorId = `snippet-${block.id}`;
    editors[editorId] = {
        code: block.code,
        options: { readOnly: true, maxLines: 20 }
    };
    
    return `
        <div class="code-snippet-block">
            <div class="code-snippet-header">
                <span>${block.language || 'python'}</span>
                <button class="copy-button" onclick="copyCode('${editorId}')">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <div class="code-snippet-content">
                <div id="${editorId}" class="ace-editor"></div>
            </div>
        </div>
    `;
}

function createIDEBlock(block) {
    const editorId = `ide-${block.id}`;
    editors[editorId] = {
        code: block.default_code || '# Write your code here\n',
        options: { readOnly: !block.editable }
    };
    
    return `
        <div class="ide-block">
            <div class="ide-header">
                <span class="ide-label">${block.label || 'Python Editor'}</span>
                <div class="ide-controls">
                    ${block.hint ? `<button class="btn btn-secondary btn-sm" onclick="toggleHint('${block.id}')">
                        <i class="fas fa-lightbulb"></i> Hint
                    </button>` : ''}
                    <button class="btn btn-secondary btn-sm" onclick="resetCode('${editorId}', \`${(block.default_code || '').replace(/`/g, '\\`')}\`)">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="runCode('${editorId}', '${block.id}')">
                        <i class="fas fa-play"></i> Run
                    </button>
                </div>
            </div>
            <div id="${editorId}" class="ace-editor"></div>
            <div id="output-${block.id}" class="ide-output"></div>
            ${block.hint ? `<div id="hint-${block.id}" class="ide-hint">${block.hint}</div>` : ''}
        </div>
    `;
}

function createQuizBlock(block) {
    const quizId = block.id;
    if (!quizStates[quizId]) {
        quizStates[quizId] = {
            currentQuestion: 0,
            answers: {},
            submitted: false
        };
    }
    
    return `
        <div class="quiz-block" id="quiz-${quizId}">
            <div class="quiz-header">
                <h3>${block.title}</h3>
                ${block.instructions ? `<p>${block.instructions}</p>` : ''}
                <div class="quiz-meta">
                    <span><i class="fas fa-question-circle"></i> ${block.questions.length} questions</span>
                    <span><i class="fas fa-star"></i> ${block.total_points} points</span>
                    <span><i class="fas fa-percentage"></i> Pass: ${block.passing_score}%</span>
                </div>
            </div>
            <div id="quiz-content-${quizId}">
                ${createQuizQuestion(block, 0)}
            </div>
            <div class="quiz-navigation" style="margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="previousQuizQuestion('${quizId}')" 
                        id="quiz-prev-${quizId}" style="display: none;">Previous</button>
                <button class="btn btn-primary" onclick="nextQuizQuestion('${quizId}')" 
                        id="quiz-next-${quizId}">Next</button>
                <button class="btn btn-success" onclick="submitQuiz('${quizId}')" 
                        id="quiz-submit-${quizId}" style="display: none;">Submit Quiz</button>
            </div>
        </div>
    `;
}

function createQuizQuestion(quiz, questionIndex) {
    const question = quiz.questions[questionIndex];
    let html = `<div class="quiz-question">`;
    
    html += `<h4>Question ${questionIndex + 1} of ${quiz.questions.length}</h4>`;
    html += `<p>${question.question}</p>`;
    
    switch(question.type) {
        case 'multiple_choice':
            html += `<div class="quiz-options">`;
            question.options.forEach((option, i) => {
                html += `
                    <div class="quiz-option" onclick="selectQuizOption('${quiz.id}', ${questionIndex}, ${i})">
                        ${option}
                    </div>
                `;
            });
            html += `</div>`;
            break;
            
        case 'fill_in_the_blank':
            const questionText = question.question.replace('______', 
                `<input type="text" class="fill-blank-input" 
                        id="quiz-${quiz.id}-q${questionIndex}-input"
                        onchange="updateFillBlank('${quiz.id}', ${questionIndex}, this.value)">`);
            html = `<div class="quiz-question">
                <h4>Question ${questionIndex + 1} of ${quiz.questions.length}</h4>
                <p>${questionText}</p>
            </div>`;
            break;
            
        case 'drag_and_drop':
            html += createDragDropQuestion(quiz.id, question, questionIndex);
            break;
    }
    
    html += `</div>`;
    return html;
}

function createDragDropQuestion(quizId, question, questionIndex) {
    let html = `<div class="drag-drop-container">`;
    
    // Drag items
    html += `<div class="drag-items">`;
    html += `<h5>Options:</h5>`;
    question.options.forEach((option, i) => {
        html += `
            <div class="drag-item" draggable="true" 
                 data-option-index="${i}"
                 ondragstart="handleDragStart(event)"
                 ondragend="handleDragEnd(event)">
                ${option}
            </div>
        `;
    });
    html += `</div>`;
    
    // Drop zones
    html += `<div class="drop-zones">`;
    html += `<h5>Match with:</h5>`;
    question.stems.forEach((stem, i) => {
        html += `
            <div>
                <div class="drop-zone-label">${stem}</div>
                <div class="drop-zone" 
                     data-stem-index="${i}"
                     data-quiz-id="${quizId}"
                     data-question-index="${questionIndex}"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event)">
                </div>
            </div>
        `;
    });
    html += `</div>`;
    
    html += `</div>`;
    return html;
}

function createDebugBlock(block) {
    const editorId = `debug-${block.id}`;
    editors[editorId] = {
        code: block.buggy_code,
        options: { readOnly: false }
    };
    
    return `
        <div class="debug-block">
            <div class="debug-header">
                <h3><i class="fas fa-bug"></i> ${block.label || 'Debug Challenge'}</h3>
            </div>
            <div class="debug-content">
                <p class="debug-instructions">${block.instructions}</p>
                <div id="${editorId}" class="ace-editor"></div>
                <div id="debug-output-${block.id}" class="ide-output"></div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="checkDebugSolution('${block.id}', '${editorId}')">
                        <i class="fas fa-check"></i> Check Solution
                    </button>
                    <button class="btn btn-secondary" onclick="showDebugSolution('${block.id}')">
                        <i class="fas fa-lightbulb"></i> Show Solution
                    </button>
                </div>
                <div id="debug-solution-${block.id}" style="display: none; margin-top: 1rem;">
                    <div class="alert alert-info">
                        <h4>Solution:</h4>
                        <p>${block.solution.explanation}</p>
                        <pre>${block.solution.correct_code}</pre>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ACE Editor functions
function initializeAceEditor(editorId, options = {}) {
    const editor = ace.edit(editorId);
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");
    editor.setOptions({
        fontSize: "14px",
        showPrintMargin: false,
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true,
        ...options
    });
    return editor;
}

function copyCode(editorId) {
    const editor = ace.edit(editorId);
    const code = editor.getValue();
    
    navigator.clipboard.writeText(code).then(() => {
        const button = event.target.closest('.copy-button');
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.classList.add('copied');
        
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy"></i> Copy';
            button.classList.remove('copied');
        }, 2000);
    });
}

function toggleHint(blockId) {
    const hint = document.getElementById(`hint-${blockId}`);
    hint.classList.toggle('show');
}

function resetCode(editorId, defaultCode) {
    const editor = ace.edit(editorId);
    editor.setValue(defaultCode, -1);
}

function runCode(editorId, blockId) {
    const editor = ace.edit(editorId);
    const code = editor.getValue();
    const outputDiv = document.getElementById(`output-${blockId}`);
    
    outputDiv.innerHTML = '<div class="spinner"></div>';
    
    // Send code to backend
    fetch('/api/submit-code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            code: code,
            lesson_id: lessonData.id,
            challenge_id: blockId
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            outputDiv.innerHTML = result.output || 'Code executed successfully!';
            if (result.passed_tests) {
                outputDiv.innerHTML += `\n\nŒì¬£√† All tests passed! +${result.xp_earned} XP`;
                markBlockComplete(blockId);
            }
        } else {
            outputDiv.innerHTML = `Error: ${result.error || 'Unknown error'}`;
            outputDiv.style.color = 'var(--danger-color)';
        }
    })
    .catch(error => {
        outputDiv.innerHTML = `Error: ${error.message}`;
        outputDiv.style.color = 'var(--danger-color)';
    });
}

// Quiz functions
function selectQuizOption(quizId, questionIndex, optionIndex) {
    const state = quizStates[quizId];
    state.answers[questionIndex] = optionIndex;
    
    // Update UI
    const options = document.querySelectorAll(`#quiz-content-${quizId} .quiz-option`);
    options.forEach((opt, i) => {
        opt.classList.toggle('selected', i === optionIndex);
    });
}

function updateFillBlank(quizId, questionIndex, value) {
    const state = quizStates[quizId];
    state.answers[questionIndex] = value;
}

function previousQuizQuestion(quizId) {
    const state = quizStates[quizId];
    const quiz = lessonData.blocks.find(b => b.id === quizId);
    
    if (state.currentQuestion > 0) {
        state.currentQuestion--;
        const content = document.getElementById(`quiz-content-${quizId}`);
        content.innerHTML = createQuizQuestion(quiz, state.currentQuestion);
        updateQuizNavigation(quizId, quiz);
    }
}

function nextQuizQuestion(quizId) {
    const state = quizStates[quizId];
    const quiz = lessonData.blocks.find(b => b.id === quizId);
    
    if (state.currentQuestion < quiz.questions.length - 1) {
        state.currentQuestion++;
        const content = document.getElementById(`quiz-content-${quizId}`);
        content.innerHTML = createQuizQuestion(quiz, state.currentQuestion);
        updateQuizNavigation(quizId, quiz);
    }
}

function updateQuizNavigation(quizId, quiz) {
    const state = quizStates[quizId];
    const prevBtn = document.getElementById(`quiz-prev-${quizId}`);
    const nextBtn = document.getElementById(`quiz-next-${quizId}`);
    const submitBtn = document.getElementById(`quiz-submit-${quizId}`);
    
    prevBtn.style.display = state.currentQuestion > 0 ? 'inline-block' : 'none';
    nextBtn.style.display = state.currentQuestion < quiz.questions.length - 1 ? 'inline-block' : 'none';
    submitBtn.style.display = state.currentQuestion === quiz.questions.length - 1 ? 'inline-block' : 'none';
}

function submitQuiz(quizId) {
    const quiz = lessonData.blocks.find(b => b.id === quizId);
    const state = quizStates[quizId];
    
    // Calculate score
    let correct = 0;
    let totalPoints = 0;
    
    quiz.questions.forEach((question, i) => {
        const userAnswer = state.answers[i];
        totalPoints += question.points || 1;
        
        if (question.type === 'multiple_choice' && userAnswer === question.correct_index) {
            correct += question.points || 1;
        } else if (question.type === 'fill_in_the_blank') {
            const answers = Array.isArray(question.answers) ? question.answers : [question.answers];
            if (answers.some(ans => ans.toLowerCase() === (userAnswer || '').toLowerCase())) {
                correct += question.points || 1;
            }
        }
    });
    
    const score = Math.round((correct / totalPoints) * 100);
    const passed = score >= quiz.passing_score;
    
    // Display results
    const content = document.getElementById(`quiz-content-${quizId}`);
    content.innerHTML = `
        <div class="quiz-results">
            <h3>${passed ? '‚â°∆í√Ñ√´ Quiz Passed!' : '‚â°∆í√ø√∂ Try Again'}</h3>
            <div class="score-display">
                <div class="score-circle ${passed ? 'passed' : 'failed'}">
                    ${score}%
                </div>
            </div>
            <p>You scored ${correct} out of ${totalPoints} points</p>
            ${passed ? `<p class="success">Great job! You've earned ${quiz.total_points} XP!</p>` : 
                     `<p>You need ${quiz.passing_score}% to pass. Cost to retake: ${quiz.retake_cost} PyCoins</p>`}
        </div>
    `;
    
    // Hide navigation buttons
    document.getElementById(`quiz-prev-${quizId}`).style.display = 'none';
    document.getElementById(`quiz-submit-${quizId}`).style.display = 'none';
    
    if (passed) {
        markBlockComplete(quizId);
    }
}

// Drag and Drop functions
let draggedElement = null;

function handleDragStart(e) {
    draggedElement = e.target;
    e.target.classList.add('dragging');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    if (draggedElement && e.currentTarget.classList.contains('drop-zone')) {
        // Clone the dragged element
        const clone = draggedElement.cloneNode(true);
        clone.classList.remove('dragging');
        
        // Clear the drop zone and add the clone
        e.currentTarget.innerHTML = '';
        e.currentTarget.appendChild(clone);
        
        // Update quiz state
        const quizId = e.currentTarget.dataset.quizId;
        const questionIndex = parseInt(e.currentTarget.dataset.questionIndex);
        const stemIndex = parseInt(e.currentTarget.dataset.stemIndex);
        const optionIndex = parseInt(draggedElement.dataset.optionIndex);
        
        if (!quizStates[quizId].answers[questionIndex]) {
            quizStates[quizId].answers[questionIndex] = {};
        }
        quizStates[quizId].answers[questionIndex][stemIndex] = optionIndex;
    }
}

// Debug challenge functions
function checkDebugSolution(blockId, editorId) {
    const editor = ace.edit(editorId);
    const code = editor.getValue();
    const outputDiv = document.getElementById(`debug-output-${blockId}`);
    
    // Run the code first
    runCode(editorId, blockId);
    
    // You can add additional validation here
    const block = lessonData.blocks.find(b => b.id === blockId);
    if (block && block.solution && code.trim() === block.solution.correct_code.trim()) {
        outputDiv.innerHTML += '\n\nŒì¬£√† Perfect! You fixed the bug!';
        markBlockComplete(blockId);
    }
}

function showDebugSolution(blockId) {
    const solutionDiv = document.getElementById(`debug-solution-${blockId}`);
    solutionDiv.style.display = solutionDiv.style.display === 'none' ? 'block' : 'none';
}

// Progress tracking
function markBlockComplete(blockId) {
    if (!lessonProgress[lessonData.id]) {
        lessonProgress[lessonData.id] = {};
    }
    lessonProgress[lessonData.id][blockId] = true;
    
    // Save progress
    localStorage.setItem(`lesson_${lessonData.id}_progress`, JSON.stringify(lessonProgress));
    
    // Update progress bar
    updateProgressBar();
}

function updateProgressBar() {
    const totalBlocks = lessonData.blocks ? lessonData.blocks.length : 0;
    const completedBlocks = lessonProgress[lessonData.id] ? 
        Object.keys(lessonProgress[lessonData.id]).length : 0;
    
    const progress = totalBlocks > 0 ? Math.round((completedBlocks / totalBlocks) * 100) : 0;
    
    document.getElementById('lesson-progress-bar').style.width = `${progress}%`;
    document.getElementById('lesson-progress-text').textContent = `${progress}%`;
}

// Navigation functions
function switchSubtopic(index) {
    renderSubtopic(index);
}

function previousSubtopic() {
    if (currentSubtopic > 0) {
        renderSubtopic(currentSubtopic - 1);
    }
}

function nextSubtopic() {
    if (lessonData.subtopics && currentSubtopic < lessonData.subtopics.length - 1) {
        renderSubtopic(currentSubtopic + 1);
    } else {
        // Lesson complete
        showNotification('Lesson completed! Great job! ‚â°∆í√Ñ√´');
        window.location.href = '/lessons';
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    prevBtn.disabled = currentSubtopic === 0;
    
    if (lessonData.subtopics && currentSubtopic === lessonData.subtopics.length - 1) {
        nextBtn.innerHTML = 'Complete <i class="fas fa-check"></i>';
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
    }
}
</script>
{% endblock %}

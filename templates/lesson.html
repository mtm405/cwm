{% extends "base/layout.html" %}

{% block title %}{{ lesson.title if lesson else "Lesson" }} - Code with Morais{% endblock %}

{% block extra_css %}
<!-- Lesson CSS is loaded via bundles/lessons.css through the CSS lazy loader -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/bundles/utils.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/quiz.css') }}">
{% endblock %}

{% block content %}
<div class="lesson-container">
    <!-- Lesson Header -->
    <header class="lesson-header">
        <a href="/lessons" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Back to Lessons
        </a>
        
        <div class="lesson-header-content">
            <div class="lesson-meta">
                <h1 class="lesson-title">
                    <i class="fas fa-{{ lesson.icon if lesson and lesson.icon else 'code' }}"></i>
                    {{ lesson.title if lesson else 'Loading...' }}
                </h1>
                
                {% if lesson %}
                <div class="lesson-badges">
                    <span class="difficulty-badge difficulty-{{ lesson.difficulty or 'beginner' }}">
                        {{ lesson.difficulty or 'Beginner' }}
                    </span>
                    {% if lesson.estimated_time %}
                    <span class="time-badge">
                        <i class="fas fa-clock"></i>
                        {{ lesson.estimated_time }} min
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-text">Progress</span>
                    <span class="progress-percentage" id="progress-percentage">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="progress-stats">
                    <span id="completed-blocks-text">0 of 0 blocks completed</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="lesson-content-wrapper">
        <!-- Loading State -->
        <div id="content-loading" class="content-loading">
            <div class="loading-spinner"></div>
            <p>Loading lesson content...</p>
        </div>
        
        <!-- Lesson Content -->
        <div id="lesson-content" class="lesson-content" style="display: none;">
            <div id="lesson-content-container" class="content-blocks-container">
                <!-- Blocks will be rendered here by JavaScript -->
            </div>
        </div>
        
        <!-- Error Fallback -->
        <div id="lesson-fallback" class="fallback-content" style="display: none;">
            <div class="error-container">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="error-title">Unable to Load Lesson</h3>
                <div class="error-content">
                    <p>We encountered an error while loading this lesson. Please check your connection and try again.</p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-refresh"></i> Retry
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Navigation Footer -->
    <footer class="lesson-navigation">
        <div class="nav-buttons">
            <button id="prev-lesson-btn" class="btn btn-secondary" style="display: none;">
                <i class="fas fa-arrow-left"></i> Previous Lesson
            </button>
            <button id="next-lesson-btn" class="btn btn-primary" style="display: none;">
                Next Lesson <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </footer>
</div>

<!-- Set lesson data for JavaScript -->
<script>
// Inject lesson data from backend
window.lessonData = {{ lesson | tojson if lesson else 'null' }};
window.lessonProgress = {{ lesson_progress | tojson if lesson_progress else '{}' }};
window.currentUser = {{ current_user | tojson if current_user else 'null' }};

// Set lesson ID meta tag
{% if lesson %}
document.querySelector('meta[name="lesson-id"]')?.setAttribute('content', '{{ lesson.id }}') || 
document.head.appendChild(Object.assign(document.createElement('meta'), {
    name: 'lesson-id',
    content: '{{ lesson.id }}'
}));
{% endif %}
</script>
{% endblock %}

{% block extra_js %}
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<!-- Initialize Firebase -->
<script>
// Initialize Firebase when SDK is loaded
window.initFirebase = async function() {
    try {
        // Check if Firebase SDK is available
        if (typeof firebase === 'undefined') {
            console.warn('‚ö†Ô∏è Firebase SDK not loaded');
            return false;
        }
        
        // Get Firebase configuration from backend
        const response = await fetch('/api/firebase-config');
        const data = await response.json();
        
        if (data && !data.error) {
            // Initialize Firebase with backend config
            if (firebase.apps.length === 0) {
                firebase.initializeApp(data);
                console.log('‚úÖ Firebase initialized successfully');
            } else {
                console.log('‚úÖ Firebase already initialized');
            }
            return true;
        } else {
            console.warn('‚ö†Ô∏è Firebase not available from backend:', data.error || 'No config');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Firebase initialization failed:', error);
        return false;
    }
};

// Initialize Firebase immediately
window.initFirebase();
</script>

<!-- ACE Editor for code blocks -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/mode-python.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/theme-monokai.js"></script>

<!-- Core lesson scripts -->
<script src="{{ url_for('static', filename='js/lesson/lesson-system.js') }}" type="module"></script>

<!-- Explicitly load quiz scripts to ensure correct loading order -->
<script src="{{ url_for('static', filename='js/quiz/QuizState.js') }}"></script>
<script src="{{ url_for('static', filename='js/quiz/QuizEngine.js') }}"></script>
<script src="{{ url_for('static', filename='js/quiz/QuizController.js') }}"></script>

<!-- Quiz renderers -->
<script src="{{ url_for('static', filename='js/quiz/renderers/MultipleChoiceRenderer.js') }}"></script>
<script src="{{ url_for('static', filename='js/quiz/renderers/TrueFalseRenderer.js') }}"></script>
<script src="{{ url_for('static', filename='js/quiz/renderers/FillBlankRenderer.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize lesson system with quiz support
        if (window.LessonSystem) {
            window.lessonSystem = new LessonSystem();
            console.log('‚úÖ Lesson system initialized');
            
            // Add debug test after a short delay to ensure everything is loaded
            setTimeout(() => {
                console.log('üîç Running Interactive Block Debug Test...');
                
                // Debug test function
                function testInteractiveBlock() {
                    console.log('üîç Testing Interactive Block Functionality');
                    console.log('==========================================');
                    
                    // Step 1: Check if lesson system is loaded
                    console.log('1. Checking lesson system...');
                    if (!window.lessonSystem) {
                        console.error('‚ùå Lesson system not found');
                        return;
                    }
                    console.log('‚úÖ Lesson system found');
                    
                    // Step 2: Check if interactions are available
                    if (!window.lessonSystem.services || !window.lessonSystem.services.interactions) {
                        console.error('‚ùå LessonInteractions not available');
                        return;
                    }
                    console.log('‚úÖ LessonInteractions available');
                    
                    // Step 3: Find interactive blocks
                    const lessonData = window.lessonSystem.state.lessonData;
                    if (!lessonData || !lessonData.blocks) {
                        console.error('‚ùå No lesson data available');
                        return;
                    }
                    
                    const interactiveBlocks = lessonData.blocks.filter(block => block.type === 'interactive');
                    console.log(`üìä Found ${interactiveBlocks.length} interactive blocks`);
                    
                    if (interactiveBlocks.length === 0) {
                        console.warn('‚ö†Ô∏è No interactive blocks found in this lesson');
                        return;
                    }
                    
                    // Step 4: Test the first interactive block
                    const testBlock = interactiveBlocks[0];
                    console.log(`üéØ Testing block: ${testBlock.id}`);
                    
                    // Check DOM elements
                    const runButton = document.querySelector(`[data-block-id="${testBlock.id}"].run-btn`);
                    const outputElement = document.getElementById(`output-${testBlock.id}`);
                    const editorElement = document.getElementById(`editor-${testBlock.id}`);
                    
                    console.log('Run button found:', !!runButton);
                    console.log('Output element found:', !!outputElement);
                    console.log('Editor element found:', !!editorElement);
                    
                    if (!runButton) {
                        console.error('‚ùå Run button not found. Checking for alternative selectors...');
                        const allRunButtons = document.querySelectorAll('.run-btn');
                        console.log(`Found ${allRunButtons.length} elements with .run-btn class`);
                        allRunButtons.forEach((btn, index) => {
                            console.log(`  Button ${index + 1}:`, btn.dataset.blockId, btn.textContent.trim());
                        });
                        
                        // Try alternative selectors
                        const actionBtns = document.querySelectorAll('.action-btn');
                        console.log(`Found ${actionBtns.length} elements with .action-btn class`);
                        actionBtns.forEach((btn, index) => {
                            if (btn.textContent.includes('Run')) {
                                console.log(`  Run action button ${index + 1}:`, btn.dataset.blockId, btn.textContent.trim());
                            }
                        });
                        return;
                    }
                    
                    // Step 5: Check editor registration
                    const editorId = `editor-${testBlock.id}`;
                    const editor = window.lessonSystem.services.interactions.codeEditors.get(editorId);
                    console.log('Editor registered:', !!editor);
                    
                    if (editor) {
                        console.log('Editor type:', typeof editor);
                        console.log('Editor has getValue:', typeof editor.getValue === 'function');
                        console.log('Editor has runCode:', typeof editor.runCode === 'function');
                    }
                    
                    console.log('==========================================');
                    console.log('üèÅ Test completed. Check the output above for issues.');
                    
                    // Return debug info for potential manual testing
                    return {
                        testBlock,
                        runButton,
                        outputElement,
                        editorElement,
                        editor
                    };
                }
                
                // Run the test and expose globally
                window.debugInteractiveTest = testInteractiveBlock;
                const testResult = testInteractiveBlock();
                
                if (testResult) {
                    window.testResult = testResult;
                    console.log('üîß Test result saved to window.testResult for manual testing');
                }
                
            }, 3000); // Wait 3 seconds for everything to load
        }
    });
</script>
{% endblock %}
